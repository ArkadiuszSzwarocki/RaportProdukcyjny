{% extends "layout.html" %}

{% block content %}

<style>
.btn-move-order {
    background: #6c757d;
    color: white;
}

.move-modal-buffer {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    min-width: 300px;
    font-family: inherit;
    font-size: 14px;
}

.move-title-buffer {
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 16px;
    font-weight: bold;
}

.move-modal-field {
    margin-bottom: 15px;
}

.move-modal-field label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.move-modal-field input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.move-modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.move-modal-actions button {
    padding: 8px 16px;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.move-modal-actions button.btn-confirm {
    background: #28a745;
}

.move-modal-actions button.btn-cancel {
    background: #6c757d;
}

.btn-move-order-action {
    opacity: 0.5;
}

.btn-start-order-active {
    opacity: 1;
}

.btn-create-zlecenie-active {
    opacity: 1;
}
</style>

<div class="section-header">
    <div><h2 class="header-title">üèóÔ∏è BUFOR / SILOSY ‚Äî {{ wybrana_data }}</h2><p class="text-muted">Towar z poprzednich dni dostƒôpny do spakowania</p></div>
    <div class="d-flex align-center gap-10">
        <a href="/planista?data={{ wybrana_data }}" class="btn">Powr√≥t do Planisty</a>
    </div>
</div>

<div class="section-box">
    <div class="card-body p-0">
        {% if bufor_list and bufor_list|length > 0 %}
        <table class="table modern-table mb-0">
            <thead>
                <tr>
                    <th class="th-kolejka">{{ _('kolejka') }}</th>
                    <th>{{ _('data_zasypu') }}</th>
                    <th>{{ _('produkt') }}</th>
                    <th>{{ _('zrobiono_zasypie') }}</th>
                    <th>Spakowane palety</th>
                    <th>{{ _('pozostalo_do_spakowania') }}</th>
                    <th>{{ _('akcja') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for b in bufor_list %}
                <tr{% if b.status == 'zakonczone' %} class="bufor-row-finished"{% endif %}>
                    <td>
                        <span class="badge badge-primary bufor-kolejka-badge">{{ b.kolejka }}</span>
                    </td>
                    <td>
                        {{ b.data }}
                        <br><small class="text-muted">{{ b.start_time }}</small>
                    </td>
                    <td><strong>{{ b.produkt }}</strong> <small class="text-muted">{{ b.nazwa }}</small></td>
                    <td>{{ b.zasyp_total }} kg</td>
                    <td>{{ b.spakowano_total }} kg</td>
                    <td class="pozostalo-cell {% if b.raw_pozostalo is defined and b.raw_pozostalo < 0 %}negative{% else %}positive{% endif %}">
                        {% if b.raw_pozostalo is defined and b.raw_pozostalo < 0 %}
                            <span title="{{ _('nadmiar_spakowany') }}">{{ b.raw_pozostalo }} kg</span>
                        {% else %}
                            {{ b.w_silosie }} kg
                        {% endif %}
                        {% if b.needs_reconciliation %}
                            <small class="badge badge-warning badge-reconciliation">Do rozliczenia</small>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm js-start-order{% if b.status != 'w toku' %} btn-move-order-action{% else %} btn-start-order-active{% endif %}"
                                data-kolejka="{{ b.kolejka }}"
                                data-produkt="{{ b.produkt }}@"
                                data-status="{{ b.status }}">‚ñ∂Ô∏è Startuj</button>
                        <button class="btn btn-info btn-sm js-create-zlecenie{% if b.status != 'zakonczone' %} btn-move-order-action{% else %} btn-create-zlecenie-active{% endif %}"
                                data-zasyp-id="{{ b.id }}"
                                data-produkt="{{ b.produkt }}"
                                data-status="{{ b.status }}"
                                title="Utw√≥rz nowe zlecenie Workowanie z pozosta≈Çym towarem{% if b.status != 'zakonczone' %} (niedostƒôpne - zlecenie musi byƒá zamkniƒôte){% endif %}">‚ûï Utw√≥rz</button>
                        <button class="btn btn-sm js-move-order btn-move-order"
                                data-plan-id="{{ b.id }}"
                                data-produkt="{{ b.produkt }}"
                                title="{{ _('przenies_zlecenie') }}">üì¶ {{ _('przenies_zlecenie') }}</button>
                        <button class="btn btn-outline-danger btn-sm js-archive-order"
                                data-plan-id="{{ b.id }}">üìÅ Archiwizuj</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <div class="p-15 text-muted">{{ _('brak_towaru_bufor') }}</div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const createButtons = document.querySelectorAll('.js-create-zlecenie');
    const startButtons = document.querySelectorAll('.js-start-order');
    const archiveButtons = document.querySelectorAll('.js-archive-order');
    const moveButtons = document.querySelectorAll('.js-move-order');
    
    document.querySelectorAll('.js-start-order').forEach((button) => {
        button.addEventListener('click', () => {
            const kolejka = button.dataset.kolejka;
            const produkt = button.dataset.produkt || '';
            const status = button.dataset.status || '';
            
            if (!kolejka) {
                alert('‚ùå Brak numeru kolejki');
                return;
            }
            
            if (status && status !== 'w toku') {
                alert('‚ö†Ô∏è Zlecenie musi byƒá w trakcie (status: w toku)\n\nAktualny status: ' + status);
                return;
            }
            
            startujZlecenie(kolejka, produkt);
        });
    });

    document.querySelectorAll('.js-create-zlecenie').forEach((button) => {
        button.addEventListener('click', () => {
            const zasypId = button.dataset.zasypId;
            const produkt = button.dataset.produkt || '';
            const status = button.dataset.status || '';
            
            if (!zasypId) {
                alert('‚ùå Brak ID zasypu');
                return;
            }
            
            if (status !== 'zakonczone') {
                alert('‚ö†Ô∏è Zlecenie musi byƒá zamkniƒôte (status: zakonczone)\n\nAktualny status: ' + status);
                return;
            }
            
            if (produkt) {
                utworzZlecenie(zasypId, produkt);
            }
        });
    });

    document.querySelectorAll('.js-archive-order').forEach((button) => {
        button.addEventListener('click', () => {
            const planId = button.dataset.planId;
            if (planId) {
                archiwizujZlecenie(planId);
            }
        });
    });

    document.querySelectorAll('.js-move-order').forEach((button) => {
        button.addEventListener('click', () => {
            const planId = button.dataset.planId;
            const produkt = button.dataset.produkt || '';
            if (planId) {
                openMoveModalBuffer(planId, produkt);
            }
        });
    });
});

function utworzZlecenie(zasypId, produkt) {
    if (!confirm(`Czy na pewno chcesz utworzyƒá nowe zlecenie Workowanie dla "${produkt}"?\n\nSystem obliczy r√≥≈ºnicƒô miƒôdzy towarem w zasypu a spakowanym i tyle wstawi jako plan.`)) {
        return;
    }
    fetch('/bufor/create_zlecenie', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ zasyp_id: zasypId })
    }).then(r => r.json()).then(j => {
        if (j && j.success) { 
            alert(`‚úÖ ${j.message}`);
            location.reload(); 
        } else { 
            alert('‚ùå B≈ÇƒÖd: ' + (j && j.message ? j.message : 'Nie uda≈Ço siƒô utworzyƒá zlecenia')); 
        }
    }).catch(e => { 
        alert('‚ùå B≈ÇƒÖd sieci: ' + e.message); 
    });
}

function startujZlecenie(kolejka, produkt) {
    if (!confirm(`Czy na pewno chcesz uruchomiƒá zlecenie ${produkt.replace('@', '')} (kolejka ${kolejka}) na Workowaniu?`)) {
        return;
    }
    fetch(`/api/start_from_queue/${kolejka}`, { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()).then(j => {
        if (j && j.success) { 
            alert(`‚úÖ ${j.message}`);
            location.reload(); 
        } else { 
            alert('‚ùå B≈ÇƒÖd: ' + (j && j.message ? j.message : 'Nie uda≈Ço siƒô uruchomiƒá')); 
        }
    }).catch(e => { 
        alert('‚ùå B≈ÇƒÖd sieci: ' + e.message); 
    });
}

function archiwizujZlecenie(planId) {
    if (!confirm('Czy na pewno chcesz zarchiwizowaƒá to zlecenie?')) {
        return;
    }
    fetch('/bufor/archiwizuj', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plan_id: planId })
    }).then(r => r.json()).then(j => {
        if (j && j.ok) { 
            location.reload(); 
        } else { 
            alert('B≈ÇƒÖd: ' + (j && j.message ? j.message : 'Nie uda≈Ço siƒô zarchiwizowaƒá')); 
        }
    }).catch(e => { 
        alert('B≈ÇƒÖd sieci: ' + e.message); 
    });
}

function openMoveModalBuffer(planId, produkt) {
    var modal = document.getElementById('moveModalBuffer');
    if (!modal) {
        alert('‚ùå Brak okna dialogowego przeniesienia');
        return;
    }
    modal.style.display = 'block';
    modal.dataset.planId = planId;
    
    // Ustaw dzisiejszƒÖ datƒô jako domy≈õlnƒÖ
    var today = new Date().toISOString().split('T')[0];
    var dateInput = document.getElementById('move_to_date_buffer');
    if (dateInput) {
        dateInput.value = today;
    }
    
    var title = modal.querySelector('.move-title-buffer');
    if (title) {
        title.innerText = 'üì¶ Przenie≈õ szar≈ºƒô: ' + produkt;
    }
}

function confirmMoveBuffer() {
    var modal = document.getElementById('moveModalBuffer');
    if (!modal) return;
    var planId = modal.dataset.planId;
    var toDate = document.getElementById('move_to_date_buffer').value;
    
    if (!planId || !toDate) {
        alert('‚ùå Brak wymaganych danych (ID lub data)');
        return;
    }
    
    fetch('/api/przenies_zlecenie_ajax', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: planId, to_date: toDate })
    })
    .then(r => r.json().catch(() => ({ success: false, message: 'Nieprawid≈Çowa odpowied≈∫ serwera' })))
    .then(j => {
        if (j && j.success) {
            modal.style.display = 'none';
            alert('‚úÖ ' + (j.message || 'Szar≈ºa przeniesiona na nowƒÖ datƒô'));
            location.reload();
        } else {
            alert('‚ùå ' + (j && j.message ? j.message : 'B≈ÇƒÖd przeniesienia'));
        }
    })
    .catch(e => {
        alert('‚ùå B≈ÇƒÖd sieci: ' + e.message);
    });
}

function closeMoveModalBuffer() {
    var modal = document.getElementById('moveModalBuffer');
    if (modal) {
        modal.style.display = 'none';
    }
}
</script>

<!-- Move modal for Buffer -->
<div id="moveModalBuffer" class="move-modal-buffer">
    <h3 class="move-title-buffer">üì¶ Przenie≈õ szar≈ºƒô</h3>
    <div class="move-modal-field">
        <label for="move_to_date_buffer">Nowa data planu:</label>
        <input type="date" id="move_to_date_buffer" required>
    </div>
    <div class="move-modal-actions">
        <button type="button" class="move-modal-actions button btn-confirm" onclick="confirmMoveBuffer()">‚úÖ Przenie≈õ</button>
        <button type="button" class="move-modal-actions button btn-cancel" onclick="closeMoveModalBuffer()">Anuluj</button>
    </div>
</div>

{% endblock %}
