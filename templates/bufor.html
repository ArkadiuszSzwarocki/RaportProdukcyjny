{% extends "layout.html" %}

{% block content %}

<div class="section-header">
    <div><h2 class="header-title">üèóÔ∏è BUFOR / SILOSY ‚Äî {{ wybrana_data }}</h2><p class="text-muted">Towar z poprzednich dni dostƒôpny do spakowania</p></div>
    <div class="d-flex align-center gap-10">
        <a href="/planista?data={{ wybrana_data }}" class="btn">Powr√≥t do Planisty</a>
    </div>
</div>

<div class="section-box">
    <div class="card-body p-0">
        {% if bufor_list and bufor_list|length > 0 %}
        <table class="table modern-table mb-0">
            <thead>
                <tr>
                    <th>Data Zasypu</th>
                    <th>Produkt</th>
                    <th>Zrobiono na Zasypie</th>
                    <th>Spakowano</th>
                    <th>POZOSTA≈ÅO (DO SPAKOWANIA)</th>
                    <th>Akcja</th>
                </tr>
            </thead>
            <tbody>
                {% for b in bufor_list %}
                <tr {% if b.status == 'zakonczone' %}style="opacity: 0.5; background-color: #f5f5f5;"{% endif %}>
                    <td>
                        {{ b.data }}
                        <br><small class="text-muted">{{ b.start_time }}</small>
                    </td>
                    <td><strong>{{ b.produkt }}</strong> <small class="text-muted">{{ b.nazwa }}</small></td>
                    <td>{{ b.zasyp_total }} kg</td>
                    <td>{{ b.spakowano_total }} kg</td>
                    <td style="font-size: 1.1em; font-weight: bold; {% if b.raw_pozostalo is defined and b.raw_pozostalo < 0 %}color: #d9534f;{% else %}color: #5cb85c;{% endif %}">
                        {% if b.raw_pozostalo is defined and b.raw_pozostalo < 0 %}
                            <span title="Nadmiar spakowany">{{ b.raw_pozostalo }} kg</span>
                        {% else %}
                            {{ b.w_silosie }} kg
                        {% endif %}
                        {% if b.needs_reconciliation %}
                            <small class="badge badge-warning" style="margin-left:8px">Do rozliczenia</small>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-outline-danger btn-sm" onclick="archiwizujZlecenie('{{ b.id }}')">üìÅ Archiwizuj</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <div class="p-15 text-muted">Brak towaru w buforze.</div>
        {% endif %}
    </div>
</div>

{% endblock %}

<script>
function archiwizujZlecenie(planId) {
    if (!confirm('Czy na pewno chcesz zarchiwizowaƒá to zlecenie?')) {
        return;
    }
    fetch('/bufor/archiwizuj', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plan_id: planId })
    }).then(r => r.json()).then(j => {
        if (j && j.ok) { 
            location.reload(); 
        } else { 
            alert('B≈ÇƒÖd: ' + (j && j.message ? j.message : 'Nie uda≈Ço siƒô zarchiwizowaƒá')); 
        }
    }).catch(e => { 
        alert('B≈ÇƒÖd sieci: ' + e.message); 
    });
}
</script>
