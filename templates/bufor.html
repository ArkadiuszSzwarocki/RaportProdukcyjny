{% extends "layout.html" %}

{% block content %}

<div class="section-header">
    <div><h2 class="header-title">üèóÔ∏è BUFOR / SILOSY ‚Äî {{ wybrana_data }}</h2><p class="text-muted">Towar z poprzednich dni dostƒôpny do spakowania</p></div>
    <div class="d-flex align-center gap-10">
        <a href="/planista?data={{ wybrana_data }}" class="btn">Powr√≥t do Planisty</a>
    </div>
</div>

<div class="section-box">
    <div class="card-body p-0">
        {% if bufor_list and bufor_list|length > 0 %}
        <table class="table modern-table mb-0">
            <thead>
                <tr>
                    <th class="th-kolejka">{{ _('kolejka') }}</th>
                    <th>{{ _('data_zasypu') }}</th>
                    <th>{{ _('produkt') }}</th>
                    <th>{{ _('zrobiono_zasypie') }}</th>
                    <th>Spakowane palety</th>
                    <th>{{ _('pozostalo_do_spakowania') }}</th>
                    <th>{{ _('akcja') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for b in bufor_list %}
                <tr{% if b.status == 'zakonczone' %} class="bufor-row-finished"{% endif %}>
                    <td>
                        <span class="badge badge-primary bufor-kolejka-badge">{{ b.kolejka }}</span>
                    </td>
                    <td>
                        {{ b.data }}
                        <br><small class="text-muted">{{ b.start_time }}</small>
                    </td>
                    <td><strong>{{ b.produkt }}</strong> <small class="text-muted">{{ b.nazwa }}</small></td>
                    <td>{{ b.zasyp_total }} kg</td>
                    <td>{{ b.spakowano_total }} kg</td>
                    <td class="pozostalo-cell {% if b.raw_pozostalo is defined and b.raw_pozostalo < 0 %}negative{% else %}positive{% endif %}">
                        {% if b.raw_pozostalo is defined and b.raw_pozostalo < 0 %}
                            <span title="{{ _('nadmiar_spakowany') }}">{{ b.raw_pozostalo }} kg</span>
                        {% else %}
                            {{ b.w_silosie }} kg
                        {% endif %}
                        {% if b.needs_reconciliation %}
                            <small class="badge badge-warning badge-reconciliation">Do rozliczenia</small>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm js-start-order"
                                data-kolejka="{{ b.kolejka }}"
                                data-produkt="{{ b.produkt }}@">‚ñ∂Ô∏è Startuj</button>
                        <button class="btn btn-outline-danger btn-sm js-archive-order"
                                data-plan-id="{{ b.id }}">üìÅ Archiwizuj</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <div class="p-15 text-muted">{{ _('brak_towaru_bufor') }}</div>
        {% endif %}
    </div>
</div>

{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.js-start-order').forEach((button) => {
        button.addEventListener('click', () => {
            startujZlecenie(button.dataset.kolejka, button.dataset.produkt || '');
        });
    });

    document.querySelectorAll('.js-archive-order').forEach((button) => {
        button.addEventListener('click', () => {
            const planId = button.dataset.planId;
            if (planId) {
                archiwizujZlecenie(planId);
            }
        });
    });
});

function startujZlecenie(kolejka, produkt) {
    if (!confirm(`Czy na pewno chcesz uruchomiƒá zlecenie ${produkt.replace('@', '')} (kolejka ${kolejka}) na Workowaniu?`)) {
        return;
    }
    fetch(`/api/start_from_queue/${kolejka}`, { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()).then(j => {
        if (j && j.success) { 
            alert(`‚úÖ ${j.message}`);
            location.reload(); 
        } else { 
            alert('‚ùå B≈ÇƒÖd: ' + (j && j.message ? j.message : 'Nie uda≈Ço siƒô uruchomiƒá')); 
        }
    }).catch(e => { 
        alert('‚ùå B≈ÇƒÖd sieci: ' + e.message); 
    });
}

function archiwizujZlecenie(planId) {
    if (!confirm('Czy na pewno chcesz zarchiwizowaƒá to zlecenie?')) {
        return;
    }
    fetch('/bufor/archiwizuj', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plan_id: planId })
    }).then(r => r.json()).then(j => {
        if (j && j.ok) { 
            location.reload(); 
        } else { 
            alert('B≈ÇƒÖd: ' + (j && j.message ? j.message : 'Nie uda≈Ço siƒô zarchiwizowaƒá')); 
        }
    }).catch(e => { 
        alert('B≈ÇƒÖd sieci: ' + e.message); 
    });
}
</script>
