<div class="plan-box">
     <h4 class="plan-title">üì¶ MAGAZYN</h4>
     
     {% if magazyn_palety %}
         <div class="p-10 panel-white-border max-h-60vh mb-15">
             <small class="text-muted">üì¶ Potwierdzone palety ({{ magazyn_palety|length }} szt):</small>
             <table class="modern-table small table-compact">
                 <thead>
                     <tr>
                         <th>Nr</th>
                         <th>Produkt</th>
                         <th>üïí Czas</th>
                         <th>‚öñÔ∏è Waga (kg)</th>
                         <th>Status</th>
                         <th>Akcje</th>
                     </tr>
                 </thead>
                 <tbody>
                     {% for produkt, waga, czas_potwierdzenia, id, plan_id, status, czas_potwierdzenia_s in magazyn_palety %}
                     <tr>
                         <td class="text-muted font-bold">{{ loop.index }}</td>
                         <td>{{ produkt }}</td>
                         <td class="time-display">{{ czas_potwierdzenia_s }}</td>
                         <td><strong class="text-success">{{ waga | int }} kg</strong></td>
                         <td><span class="status-badge status-accepted">{{ status }}</span></td>
                         <td>
                             {% if rola in ['produkcja', 'lider', 'admin'] %}
                                 <button type="button" class="btn-icon" title="Edytuj" onclick="editPalet({{ id }}, {{ waga }})">‚úé</button>
                                 <button type="button" class="btn-delete inline-form" title="Usu≈Ñ" onclick="if(confirm('UsunƒÖƒá paletƒô?')) deletePalet({{ id }}, '{{ dzisiaj }}')">üóë</button>
                             {% endif %}
                         </td>
                     </tr>
                     {% endfor %}
                 </tbody>
             </table>
         </div>
     {% else %}
         <div class="text-center p-20 text-muted">
             <span class="fs-20">üì≠</span><br>
             <p>Brak potwierdzonych palet.</p>
         </div>
     {% endif %}

    {% if rola in ['produkcja', 'lider', 'admin'] %}
     <hr class="custom-hr">
     <h4>+ Dodaj Zadanie dla Magazynu</h4>
    <form action="{{ url_for('api.dodaj_plan') }}" method="POST" class="form-flex">
        <input type="date" name="data_planu" title="Data planu" value="{{ dzisiaj }}" required class="input-sm" aria-label="Data planu">
        <input type="text" name="produkt" title="Tre≈õƒá zadania / Produkt" placeholder="Tre≈õƒá zadania / Produkt" required class="select-flex" aria-label="Produkt">
        <input type="number" step="0.1" name="tonaz" title="Ilo≈õƒá" placeholder="Ilo≈õƒá" required class="input-sm w-80" aria-label="Ilo≈õƒá">
        <button type="submit" class="btn-add-plan">DODAJ ZADANIE</button>
    </form>
    {% endif %}
</div>

<script>
function editPalet(id, waga){
    var newWaga = prompt('Nowa waga (kg):', waga);
    if(newWaga && newWaga !== waga){
        fetch('/api/edytuj_palete_ajax', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: id, waga: newWaga, data_planu: '{{ dzisiaj }}'})
        })
        .then(r => r.json())
        .then(j => {
            if(j && j.success){
                location.reload();
            } else {
                alert('B≈ÇƒÖd: ' + (j && j.message || 'Nie uda≈Ço siƒô edytowaƒá'));
            }
        })
        .catch(e => alert('B≈ÇƒÖd: ' + e));
    }
}

function deletePalet(id, data){
    fetch('/api/usun_palete_ajax', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({id: id, data_planu: data})
    })
    .then(r => r.json())
    .then(j => {
        if(j && j.success){
            location.reload();
        } else {
            alert('B≈ÇƒÖd: ' + (j && j.message || 'Nie uda≈Ço siƒô usunƒÖƒá'));
        }
    })
    .catch(e => alert('B≈ÇƒÖd: ' + e));
}
</script>