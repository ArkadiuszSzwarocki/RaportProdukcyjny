<div class="plan-box">
    
    {% set aktywne = [] %}
    {% for p in plan if p[3] == 'w toku' %}
        {% do aktywne.append(p) %}
    {% endfor %}

    {% if aktywne %}
        {% for p in aktywne %}
        <div class="plan-box">
            <h3 class="header-title">üì¶ {{ _('odbior_palet') }}: {{ p[1] }}</h3>

            <div class="d-flex gap-10">
                <div class="flex-1 fs-110">
                    {% if p|length > 11 and p[11] %}
                        {% set pula = p[11]|int %}
                        {% if pula > 0 %}
                            <div class="pula-box pula-box--success">
                                {{ _('plan') }}: <strong class="pula-text--success">{{ p[2]|int }} kg</strong> ({{ _('do_spakowania') }}: <span class="pula-highlight--success">+{{ pula }} kg</span>)
                            </div>
                        {% elif pula < 0 %}
                            <div class="pula-box pula-box--danger">
                                {{ _('plan') }}: <strong class="pula-text--danger">{{ p[2]|int }} kg</strong> ({{ _('przekroczono') }}: <span class="pula-highlight--danger">{{ pula }} kg</span>)
                            </div>
                        {% else %}
                            <div class="pula-box pula-box--neutral">
                                {{ _('plan') }}: <strong>{{ p[2]|int }} kg</strong> ({{ _('pula_wyczerpana') }})
                            </div>
                        {% endif %}
                    {% else %}
                        {{ _('plan') }}: <strong>{{ p[2]|int }} kg</strong>
                    {% endif %}
                    <br>
                    {{ _('zrobiono') }}: <strong class="text-success">{{ p[7]|int }} kg</strong>
                    
                    <div class="p-10 panel-white-border max-h-60vh mb-15">
                        <small class="text-muted">üì¶ {{ _('ostatnie_palety') }}:</small>
                        {% if palety_mapa[p[0]] %}
                        <table class="modern-table small palety-table">
                            <thead>
                                <tr>
                                    <th>{{ _('nr') }}</th>
                                    <th>üïí {{ _('czas') }}</th>
                                    <th>‚öñÔ∏è {{ _('waga') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pal in palety_mapa[p[0]] %}
                                <tr>
                                    <td class="text-muted font-bold">{{ loop.index }}</td>
                                    <td class="time-display">{{ pal[1] }}</td>
                                    <td><strong class="text-success">{{ pal[0] | int }} kg</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p class="text-muted small">{{ _('brak_palet') }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="flex-1 d-flex flex-column gap-10">
                    {% if rola in ['produkcja','lider','admin','pracownik'] %}
                    <form action="{{ url_for('api.dodaj_palete', plan_id=p[0]) }}" method="POST" class="dashed-blue">
                        <label class="header-title">{{ _('dodaj_pelna_palete') }}</label>
                        
                        <div class="d-flex justify-center align-center gap-10">
                            <input type="number" step="1" name="waga_palety" value="1000" class="input-sm w-70" aria-label="Waga palety (kg)" onclick="this.select()" required>
                            <span class="fs-150 font-bold">kg</span>
                        </div>

                        <button type="submit" class="btn-add-plan w-100">+ DODAJ PALETƒò</button>
                    </form>
                    {% endif %}

                    <div class="d-flex gap-10">
                        <form action="/cofnij_palete/{{ p[0] }}" method="POST" class="flex-1" data-confirm-msg="{{ _("cofnac_palete") }}">
                            <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                            <button type="submit" class="btn-action btn-warning">‚Ü© {{ _('cofnij') }}</button>
                        </form>

                        <form action="/koniec_zlecenie/{{ p[0] }}" method="POST" class="flex-1" data-confirm-msg="{{ _('zakonczyc_zlecenie') }}">
                            <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                            <button type="submit" class="btn-stop" aria-label="{{ _('zakonczy') }}">‚ñ† {{ _('zakonczy') }}</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <h4 class="plan-title text-muted mt-20">üìã {{ _('kolejka_zlecen') }}:</h4>
    {% else %}
        <h4 class="plan-title">üì¶ {{ _('workowanie') }}</h4>
    {% endif %}

    {% if not plan %}
        <p class="text-muted text-muted-italic">{{ _('brak_zlecen') }}</p>
    {% else %}
        {% for p in plan if p[3] != 'w toku' %}
        <div class="plan-item {% if p[3] == 'zakonczone' %}bg-zakonczone{% endif %} {% if aktywne %}opacity-60{% endif %}">
            <div class="flex-2">
                {% if p[3] == 'zaplanowane' %}<span class="status-badge status-plan">{{ _('oczekuje') }}</span>
                {% elif p[3] == 'zakonczone' %}<span class="status-badge status-koniec">{{ _('zamkniete') }}</span>{% endif %}
                
                    <span class="font-bold">{{ p[1] }}</span> ({{ p[2]|int }} kg)
                    {% if p[3] == 'zakonczone' %} - {{ _('wyk') }}: <strong>{{ p[7]|int }} kg</strong>{% endif %}
            </div>
            
            <div>
                {% if p[3] == 'zaplanowane' %}
                    <form action="/start_zlecenia/{{ p[0] }}" method="POST">
                        <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                        <button type="submit" class="btn-start btn-small" aria-label="{{ _('start') }}">‚ñ∂ {{ _('start') }}</button>
                    </form>
                {% endif %}
                
                {% if rola in ['admin', 'lider'] %}
                    <form action="{{ url_for('planning.przywroc_zlecenie', id=p[0]) }}" method="POST" class="inline-form" style="display: inline;" onsubmit="return confirm('Wznowiƒá {{ p[1] }}?');">
                        <button type="submit" class="btn-action btn-outline-warning btn-small" aria-label="Wznowiƒá zlecenie" title="Wznowiƒá zlecenie">‚Üª Wzn√≥w</button>
                    </form>
                {% endif %}
                
                {% if rola in ['planista', 'admin', 'lider'] %}
                    <button type="button" class="btn-icon ml-5" title="{{ _('przenies_zlecenie') }}" data-action="move-order" data-order-id="{{ p[0] }}" data-order-name="{{ p[1] }}">üì¶</button>
                    <button type="button" class="btn-delete inline-form ml-5" aria-label="{{ _('usun_plan') }}" data-action="delete-order" data-order-id="{{ p[0] }}" data-order-date="{{ dzisiaj }}" data-confirm-msg="{{ _('usunac') }}">üóë</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% endif %}
    
    {% if rola in ['planista', 'admin', 'lider'] %}
    <hr class="custom-hr">
    <form action="{{ url_for('api.dodaj_plan') }}" method="POST" class="form-flex">
        <input type="date" name="data_planu" value="{{ dzisiaj }}" required class="w-auto" aria-label="{{ _('plan') }}">
        <input type="text" name="produkt" placeholder="Produkt" required class="select-flex" aria-label="Produkt">
        <input type="number" step="0.1" name="tonaz" placeholder="{{ _('plan') }} (kg)" required class="w-70" aria-label="Tonaz">
        <button type="submit" class="btn-add-plan">{{ _('dodaj') }}</button>
    </form>
    {% endif %}
</div>

<!-- Sekcja: Usuniƒôte zlecenia -->
{% if rola in ['planista', 'admin'] %}
<div id="deletedOrdersSection" class="deleted-orders-section">
    <h4 class="header-title">üóëÔ∏è {{ _('usuniety') }} {{ _('zlecenia') }} (<span id="deletedCount">0</span>)</h4>
    <div id="deletedOrdersList"></div>
</div>
{% endif %}

<!-- Move modal for Workowanie -->
<div id="moveModalWork" class="move-modal-work">
    <h3 class="move-title-work">{{ _('przenies_zlecenie') }}</h3>
    <div class="move-modal-field">
        <label for="move_to_date_work">{{ _('plan') }}:</label>
        <input type="date" id="move_to_date_work" value="{{ dzisiaj }}">
    </div>
    <div class="move-modal-actions d-flex gap-5">
        <button type="button" onclick="confirmMoveWork()" class="btn-action btn-small">{{ _('przenies_zlecenie') }}</button>
        <button type="button" onclick="document.getElementById('moveModalWork').style.display='none'" class="btn-action btn-small btn-cancel">Anuluj</button>
    </div>
</div>

<script>
// Translation messages
var wkMsgs = {
    przywroc: '{{ _("przywroc") }}',
    brakuje_danych: '{{ _("brakuje_danych") }}'
};

// Global reference to store data for modal
var moveOrderData = {};

// Za≈Çaduj usuniƒôte zlecenia
function loadDeletedOrders(){
    var dzisiaj = '{{ dzisiaj }}';
    var deletedSection = document.getElementById('deletedOrdersSection');
    if(!deletedSection) return;
    
    fetch('/api/get_deleted_plans/' + dzisiaj)
        .then(function(r){ return r.json(); })
        .then(function(j){
            if(j && j.success && j.plans && j.plans.length > 0){
                var html = '';
                j.plans.forEach(function(p){
                    html += '<div class="plan-item deleted-item-style">' +
                        '<div class="flex-2">' +
                        '<span class="deleted-item-time">‚è∞ ' + (p.deleted_at || 'N/A') + '</span><br>' +
                        '<span class="font-bold deleted-item-text">' + p.produkt + '</span> (' + p.tonaz + ' kg)' +
                        '</div>' +
                        '<div><button type="button" class="btn-action btn-small restore-deleted-btn" data-restore-id="' + p.id + '">' + wkMsgs.przywroc + '</button></div>' +
                        '</div>';
                });
                document.getElementById('deletedOrdersList').innerHTML = html;
                document.getElementById('deletedCount').innerText = j.plans.length;
                deletedSection.style.display = 'block';
            }
        })
        .catch(function(e){ console.error('Failed to load deleted orders', e); });
}

function restoreDeletedOrder(id){
    if(!confirm('Przywr√≥ciƒá to zlecenie?')) return;
    fetch('/api/przywroc_usunietego_zlecenia/' + id, {method:'POST'})
        .then(function(r){ return r.json(); })
        .then(function(j){
            if(j && j.success){
                alert('Zlecenie przywr√≥cone!');
                location.reload();
            } else {
                alert((j && j.message) || 'B≈ÇƒÖd');
            }
        })
        .catch(function(){ alert('B≈ÇƒÖd sieci'); });
}

// Delete plan function (kept for compatibility)
function deletePlan(id, data){
    fetch('/api/usun_plan_ajax/' + id, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({data_powrotu: data})
    })
    .then(function(r){ return r.json().catch(function(){ return {success:false}; }); })
    .then(function(j){
        if(j && j.success){
            location.reload();
        } else {
            alert((j && j.message) || 'B≈ÇƒÖd usuniƒôcia');
        }
    })
    .catch(function(){ alert('B≈ÇƒÖd sieci'); });
}

// Event delegation for forms with data-confirm-msg
document.addEventListener('submit', function(e){
    var form = e.target;
    if(form.hasAttribute('data-confirm-msg')){
        var msg = form.getAttribute('data-confirm-msg');
        if(!confirm(msg)){
            e.preventDefault();
        }
    }
}, true);

// Event delegation for action buttons
document.addEventListener('click', function(e){
    // Move order button
    if(e.target.hasAttribute('data-action') && e.target.getAttribute('data-action') === 'move-order'){
        var id = e.target.getAttribute('data-order-id');
        var name = e.target.getAttribute('data-order-name');
        openMoveModalWork(id, name);
    }
    
    // Delete order button
    if(e.target.hasAttribute('data-action') && e.target.getAttribute('data-action') === 'delete-order'){
        var id = e.target.getAttribute('data-order-id');
        var date = e.target.getAttribute('data-order-date');
        var msg = e.target.getAttribute('data-confirm-msg');
        if(confirm(msg)){
            deletePlan(id, date);
        }
    }
    
    // Restore deleted order button
    if(e.target.classList.contains('restore-deleted-btn')){
        var id = e.target.getAttribute('data-restore-id');
        restoreDeletedOrder(id);
    }
}, false);

function openMoveModalWork(id, nazwa){
    var modal = document.getElementById('moveModalWork');
    if(!modal) return alert('Brak modala przeniesienia');
    modal.style.display = 'block';
    modal.dataset.planId = id;
    var title = modal.querySelector('.move-title-work'); 
    if(title) title.innerText = 'Przenie≈õ: ' + nazwa;
}

function confirmMoveWork(){
    var modal = document.getElementById('moveModalWork');
    var id = modal.dataset.planId;
    var to_date = document.getElementById('move_to_date_work').value;
    if(!id || !to_date) return alert(wkMsgs.brakuje_danych);
    fetch('/api/przenies_zlecenie_ajax', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:id, to_date: to_date})})
        .then(function(r){ return r.json().catch(function(){ return { success:false, message:'Nieprawid≈Çowa odpowied≈∫ serwera' }; }); })
        .then(function(j){
            if(j && j.success){
                modal.style.display='none';
                location.reload();
            } else {
                alert((j && j.message) || 'B≈ÇƒÖd');
            }
        }).catch(function(){ alert('B≈ÇƒÖd sieci'); });
}

// Za≈Çaduj przy starcie
loadDeletedOrders();
</script>