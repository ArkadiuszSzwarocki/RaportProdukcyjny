<div class="plan-box">
    
    {% set aktywne = [] %}
    {% for p in plan if p[3] == 'w toku' %}
        {% do aktywne.append(p) %}
    {% endfor %}

    {% if aktywne %}
        {% for p in aktywne %}
        <div class="plan-box" style="background-color:#e9f4ff; border:2px solid #2196f3; padding:20px; border-radius:8px; margin-bottom:30px; box-shadow:0 4px 15px rgba(33,150,243,0.12);">
            <h3 class="header-title" style="margin-top:0; padding-bottom:10px; color:#1565c0;">üì¶ ODBI√ìR PALET: {{ p[1] }}</h3>

            <div class="d-flex" style="gap:20px;">
                <div style="flex:1; font-size:1.1em;">
                    Plan: <strong>{{ p[2] }} t</strong> <br>
                    Zrobiono: <strong class="text-success" style="font-size:1.3em;">{{ p[7] }} t</strong>
                    
                    <div style="margin-top:15px; background:white; padding:10px; border-radius:5px; max-height:200px; overflow-y:auto; border:1px solid #bbdefb;">
                        <small class="text-muted">Ostatnie palety:</small>
                        <ul style="padding-left:20px; margin:5px 0;">
                        {% if palety_mapa[p[0]] %}
                            {% for pal in palety_mapa[p[0]] %}
                                <li>{{ pal[1] }} - <strong>{{ pal[0] | int }} kg</strong></li>
                            {% endfor %}
                        {% else %}
                            <li>Brak palet</li>
                        {% endif %}
                        </ul>
                    </div>
                </div>

                <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                    <form action="/dodaj_palete/{{ p[0] }}" method="POST" style="background:white; padding:20px; border-radius:8px; text-align:center; border: 2px dashed #2196f3;">
                        <label class="header-title" style="display:block; margin-bottom:10px; color:#1565c0;">DODAJ PE≈ÅNƒÑ PALETƒò</label>
                        
                        <div class="d-flex" style="justify-content:center; align-items:center; gap:10px;">
                            <input type="number" step="1" name="waga_palety" value="1000" class="input-sm" aria-label="Waga palety (kg)" style="width:120px; height:50px; text-align:center; font-size:1.5em; font-weight:bold;" onclick="this.select()" required>
                            <span style="font-size:1.5em; font-weight:bold;">kg</span>
                        </div>
                        
                        <button type="submit" class="btn-add-plan" style="width:100%; margin-top:15px; padding:15px; font-size:1.2em;">+ DODAJ PALETƒò</button>
                    </form>

                    <div class="d-flex" style="gap:10px;">
                        <form action="/cofnij_palete/{{ p[0] }}" method="POST" onsubmit="return confirm('CofnƒÖƒá ostatniƒÖ paletƒô?');" style="flex:1;">
                            <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                            <button type="submit" class="btn-action" style="width:100%; background:#f39c12; color:white;">‚Ü© COFNIJ</button>
                        </form>
                        
                        <form action="/koniec_zlecenie/{{ p[0] }}" method="POST" onsubmit="return confirm('Zako≈Ñczyƒá zlecenie?');" style="flex:1;">
                            <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                            <button type="submit" class="btn-stop" style="width:100%;">‚ñ† ZAKO≈ÉCZ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <h4 class="plan-title" style="color: gray; margin-top: 20px;">üìã Kolejka zlece≈Ñ:</h4>
    {% else %}
        <h4 class="plan-title">üì¶ WORKOWANIE</h4>
    {% endif %}

    {% if not plan %}
        <p style="color:gray; font-style:italic;">Brak zlece≈Ñ.</p>
    {% else %}
        {% for p in plan if p[3] != 'w toku' %}
        <div class="plan-item {% if p[3] == 'zakonczone' %}bg-zakonczone{% endif %}" style="opacity: {% if aktywne %}0.6{% else %}1{% endif %};">
            <div style="flex:2;">
                {% if p[3] == 'zaplanowane' %}<span class="status-badge status-plan">OCZEKUJE</span>
                {% elif p[3] == 'zakonczone' %}<span class="status-badge status-koniec">ZAMKNIƒòTE</span>{% endif %}
                
                <span style="font-weight:bold;">{{ p[1] }}</span> ({{ p[2] }} t)
                {% if p[3] == 'zakonczone' %} - Wyk: <strong>{{ p[7] }} t</strong>{% endif %}
            </div>
            
            <div>
                {% if p[3] == 'zaplanowane' %}
                    <form action="/start_zlecenie/{{ p[0] }}" method="POST">
                        <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                        <button type="submit" class="btn-start" style="padding:5px 15px; font-size:0.9em;">‚ñ∂ START</button>
                    </form>
                {% endif %}
                
                {% if rola in ['planista', 'admin', 'lider'] %}
                <form action="/usun_plan/{{ p[0] }}" method="POST" class="inline-form" onsubmit="return confirm('UsunƒÖƒá?');" style="margin-left:10px;">
                    <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                    <button type="submit" class="btn-delete">üóë</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% endif %}
    
    {% if rola in ['planista', 'admin', 'lider'] %}
    <hr class="custom-hr">
    <form action="/dodaj_plan" method="POST" class="form-flex">
        <input type="date" name="data_planu" value="{{ dzisiaj }}" required style="width:auto;" aria-label="Data planu">
        <input type="text" name="produkt" placeholder="Produkt" required class="select-flex" aria-label="Produkt">
        <input type="number" step="0.1" name="tonaz" placeholder="Plan (t)" required style="width:70px;" aria-label="Tonaz">
        <button type="submit" class="btn-add-plan">DODAJ</button>
    </form>
    {% endif %}
</div>