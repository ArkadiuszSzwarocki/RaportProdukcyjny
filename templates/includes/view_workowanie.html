<div class="plan-box">
    
    {% set aktywne = [] %}
    {% for p in plan if p[3] == 'w toku' %}
        {% do aktywne.append(p) %}
    {% endfor %}

    {% if aktywne %}
        {% for p in aktywne %}
        <div class="plan-box">
            <h3 class="header-title">üì¶ ODBI√ìR PALET: {{ p[1] }}</h3>

            <div class="d-flex gap-10">
                <div class="flex-1 fs-110">
                    {% if p|length > 11 and p[11] %}
                        {% set pula = p[11]|int %}
                        {% if pula > 0 %}
                            <div style="background-color: #d4edda; padding: 8px; border-radius: 4px; border-left: 4px solid #28a745;">
                                Plan: <strong style="color: #155724;">{{ p[2]|int }} kg</strong> (do spakowania: <span style="color: #28a745; font-weight: bold;">+{{ pula }} kg</span>)
                            </div>
                        {% elif pula < 0 %}
                            <div style="background-color: #f8d7da; padding: 8px; border-radius: 4px; border-left: 4px solid #dc3545;">
                                Plan: <strong style="color: #721c24;">{{ p[2]|int }} kg</strong> (przekroczono: <span style="color: #dc3545; font-weight: bold;">{{ pula }} kg</span>)
                            </div>
                        {% else %}
                            <div style="background-color: #e2e3e5; padding: 8px; border-radius: 4px; border-left: 4px solid #6c757d;">
                                Plan: <strong>{{ p[2]|int }} kg</strong> (pula wyczerpana)
                            </div>
                        {% endif %}
                    {% else %}
                        Plan: <strong>{{ p[2]|int }} kg</strong>
                    {% endif %}
                    <br>
                    Zrobiono: <strong class="text-success">{{ p[7]|int }} kg</strong>
                    
                    <div class="p-10 panel-white-border max-h-60vh mb-15">
                        <small class="text-muted">üì¶ Ostatnie palety:</small>
                        {% if palety_mapa[p[0]] %}
                        <table class="modern-table small" style="font-size: 0.85em; margin-top: 8px;">
                            <thead>
                                <tr>
                                    <th>Nr</th>
                                    <th>üïí Czas</th>
                                    <th>‚öñÔ∏è Waga</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pal in palety_mapa[p[0]] %}
                                <tr>
                                    <td class="text-muted font-bold">{{ loop.index }}</td>
                                    <td class="time-display">{{ pal[1] }}</td>
                                    <td><strong class="text-success">{{ pal[0] | int }} kg</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p class="text-muted small">Brak palet</p>
                        {% endif %}
                    </div>
                </div>

                <div class="flex-1 d-flex flex-column gap-10">
                    {% if rola in ['produkcja','lider','admin','pracownik'] %}
                    <form action="{{ url_for('api.dodaj_palete', plan_id=p[0]) }}" method="POST" class="dashed-blue">
                        <label class="header-title">DODAJ PE≈ÅNƒÑ PALETƒò</label>
                        
                        <div class="d-flex justify-center align-center gap-10">
                            <input type="number" step="1" name="waga_palety" value="1000" class="input-sm w-70" aria-label="Waga palety (kg)" onclick="this.select()" required>
                            <span class="fs-150 font-bold">kg</span>
                        </div>

                        <button type="submit" class="btn-add-plan w-100">+ DODAJ PALETƒò</button>
                    </form>
                    {% endif %}

                    <div class="d-flex gap-10">
                        <form action="/cofnij_palete/{{ p[0] }}" method="POST" onsubmit="return confirm('CofnƒÖƒá ostatniƒÖ paletƒô?');" class="flex-1">
                            <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                            <button type="submit" class="btn-action btn-warning">‚Ü© COFNIJ</button>
                        </form>
                        
                                <form action="/koniec_zlecenie/{{ p[0] }}" method="POST" onsubmit="return confirm('Zako≈Ñczyƒá zlecenie?');" class="flex-1">
                            <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                            <button type="submit" class="btn-stop" aria-label="Zako≈Ñcz zlecenie">‚ñ† ZAKO≈ÉCZ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <h4 class="plan-title text-muted mt-20">üìã Kolejka zlece≈Ñ:</h4>
    {% else %}
        <h4 class="plan-title">üì¶ WORKOWANIE</h4>
    {% endif %}

    {% if not plan %}
        <p class="text-muted text-muted-italic">Brak zlece≈Ñ.</p>
    {% else %}
        {% for p in plan if p[3] != 'w toku' %}
        <div class="plan-item {% if p[3] == 'zakonczone' %}bg-zakonczone{% endif %} {% if aktywne %}opacity-60{% endif %}">
            <div class="flex-2">
                {% if p[3] == 'zaplanowane' %}<span class="status-badge status-plan">OCZEKUJE</span>
                {% elif p[3] == 'zakonczone' %}<span class="status-badge status-koniec">ZAMKNIƒòTE</span>{% endif %}
                
                    <span class="font-bold">{{ p[1] }}</span> ({{ p[2]|int }} kg)
                    {% if p[3] == 'zakonczone' %} - Wyk: <strong>{{ p[7]|int }} kg</strong>{% endif %}
            </div>
            
            <div>
                {% if p[3] == 'zaplanowane' %}
                    <form action="/start_zlecenie/{{ p[0] }}" method="POST">
                        <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                        <button type="submit" class="btn-start btn-small" aria-label="Start zlecenia">‚ñ∂ START</button>
                    </form>
                {% endif %}
                
                {% if rola in ['planista', 'admin', 'lider'] %}
                    <button type="button" class="btn-icon ml-5" title="Przenie≈õ zlecenie" onclick="openMoveModalWork({{ p[0] }}, '{{ p[1] }}')">üìÖ</button>
                    <button type="button" class="btn-delete inline-form ml-5" aria-label="Usu≈Ñ plan" onclick="if(confirm('UsunƒÖƒá?')) deletePlan({{ p[0] }}, '{{ dzisiaj }}')">üóë</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% endif %}
    
    {% if rola in ['planista', 'admin', 'lider'] %}
    <hr class="custom-hr">
    <form action="{{ url_for('api.dodaj_plan') }}" method="POST" class="form-flex">
        <input type="date" name="data_planu" value="{{ dzisiaj }}" required class="w-auto" aria-label="Data planu">
        <input type="text" name="produkt" placeholder="Produkt" required class="select-flex" aria-label="Produkt">
        <input type="number" step="0.1" name="tonaz" placeholder="Plan (kg)" required class="w-70" aria-label="Tonaz">
        <button type="submit" class="btn-add-plan">DODAJ</button>
    </form>
    {% endif %}
</div>

<!-- Move modal for Workowanie -->
<div id="moveModalWork" style="display:none; position:fixed; left:50%; top:40%; transform:translate(-50%,-50%); background:#fff; padding:15px; border:1px solid #ccc; z-index:2000;">
    <h3 class="move-title-work">Przenie≈õ zlecenie</h3>
    <div style="margin:8px 0">Nowa data: <input type="date" id="move_to_date_work" value="{{ dzisiaj }}"></div>
    <div class="d-flex gap-5" style="justify-content:flex-end;">
        <button type="button" onclick="confirmMoveWork()" class="btn-action btn-small">Przenie≈õ</button>
        <button type="button" onclick="document.getElementById('moveModalWork').style.display='none'" class="btn-action btn-small btn-cancel">Anuluj</button>
    </div>
</div>

<script>
function openMoveModalWork(id, nazwa){
    var modal = document.getElementById('moveModalWork');
    if(!modal) return alert('Brak modala przeniesienia');
    modal.style.display = 'block';
    modal.dataset.planId = id;
    var title = modal.querySelector('.move-title-work'); if(title) title.innerText = 'Przenie≈õ: ' + nazwa;
}

function confirmMoveWork(){
    var modal = document.getElementById('moveModalWork');
    var id = modal.dataset.planId;
    var to_date = document.getElementById('move_to_date_work').value;
    if(!id || !to_date) return alert('Brakuje danych');
    fetch('/api/przenies_zlecenie_ajax', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:id, to_date: to_date})})
        .then(function(r){ return r.json().catch(function(){ return { success:false, message:'Nieprawid≈Çowa odpowied≈∫ serwera' }; }); })
        .then(function(j){
            if(j && j.success){
                modal.style.display='none';
                location.reload();
            } else {
                alert((j && j.message) || 'B≈ÇƒÖd');
            }
        }).catch(function(){ alert('B≈ÇƒÖd sieci'); });
}
</script>