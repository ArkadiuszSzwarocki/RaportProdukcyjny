<div class="plan-box">
    
    {% set aktywne = [] %}
    {% for p in plan if p[3] == 'w toku' %}
        {% do aktywne.append(p) %}
    {% endfor %}

    {% if aktywne %}
        {% for p in aktywne %}
        <div class="plan-box">
            <h3 class="header-title">üì¶ ODBI√ìR PALET: {{ p[1] }}</h3>

            <div class="d-flex gap-10">
                <div class="flex-1 fs-110">
                    Plan: <strong>{{ p[2] }} t</strong> <br>
                    Zrobiono: <strong class="text-success">{{ p[7] }} t</strong>
                    
                    <div class="p-10 panel-white-border max-h-60vh mb-15">
                        <small class="text-muted">Ostatnie palety:</small>
                        <ul class="list-compact">{% if palety_mapa[p[0]] %}
                            {% for pal in palety_mapa[p[0]] %}
                                <li>{{ pal[1] }} - <strong>{{ pal[0] | int }} kg</strong></li>
                            {% endfor %}
                        {% else %}
                            <li>Brak palet</li>
                        {% endif %}</ul>
                    </div>
                </div>

                <div class="flex-1 d-flex flex-column gap-10">
                    {% if rola in ['produkcja','lider','admin','pracownik'] %}
                    <form action="/dodaj_palete/{{ p[0] }}" method="POST" class="dashed-blue">
                        <label class="header-title">DODAJ PE≈ÅNƒÑ PALETƒò</label>
                        
                        <div class="d-flex justify-center align-center gap-10">
                            <input type="number" step="1" name="waga_palety" value="1000" class="input-sm w-70" aria-label="Waga palety (kg)" onclick="this.select()" required>
                            <span class="fs-150 font-bold">kg</span>
                        </div>
                        
                        <button type="submit" class="btn-add-plan w-100">+ DODAJ PALETƒò</button>
                    </form>
                    {% endif %}

                    <div class="d-flex gap-10">
                        <form action="/cofnij_palete/{{ p[0] }}" method="POST" onsubmit="return confirm('CofnƒÖƒá ostatniƒÖ paletƒô?');" class="flex-1">
                            <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                            <button type="submit" class="btn-action btn-warning">‚Ü© COFNIJ</button>
                        </form>
                        
                                <form action="/koniec_zlecenie/{{ p[0] }}" method="POST" onsubmit="return confirm('Zako≈Ñczyƒá zlecenie?');" class="flex-1">
                            <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                            <button type="submit" class="btn-stop" aria-label="Zako≈Ñcz zlecenie">‚ñ† ZAKO≈ÉCZ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <h4 class="plan-title text-muted mt-20">üìã Kolejka zlece≈Ñ:</h4>
    {% else %}
        <h4 class="plan-title">üì¶ WORKOWANIE</h4>
    {% endif %}

    {% if not plan %}
        <p class="text-muted text-muted-italic">Brak zlece≈Ñ.</p>
    {% else %}
        {% for p in plan if p[3] != 'w toku' %}
        <div class="plan-item {% if p[3] == 'zakonczone' %}bg-zakonczone{% endif %} {% if aktywne %}opacity-60{% endif %}">
            <div class="flex-2">
                {% if p[3] == 'zaplanowane' %}<span class="status-badge status-plan">OCZEKUJE</span>
                {% elif p[3] == 'zakonczone' %}<span class="status-badge status-koniec">ZAMKNIƒòTE</span>{% endif %}
                
                <span class="font-bold">{{ p[1] }}</span> ({{ p[2] }} t)
                {% if p[3] == 'zakonczone' %} - Wyk: <strong>{{ p[7] }} t</strong>{% endif %}
            </div>
            
            <div>
                {% if p[3] == 'zaplanowane' %}
                    <form action="/start_zlecenie/{{ p[0] }}" method="POST">
                        <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                        <button type="submit" class="btn-start btn-small" aria-label="Start zlecenia">‚ñ∂ START</button>
                    </form>
                {% endif %}
                
                {% if rola in ['planista', 'admin', 'lider'] %}
                <form action="/usun_plan/{{ p[0] }}" method="POST" class="inline-form ml-10" onsubmit="return confirm('UsunƒÖƒá?');">
                    <input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                    <button type="submit" class="btn-delete" aria-label="Usu≈Ñ plan">üóë</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% endif %}
    
    {% if rola in ['planista', 'admin', 'lider'] %}
    <hr class="custom-hr">
    <form action="/dodaj_plan" method="POST" class="form-flex">
        <input type="date" name="data_planu" value="{{ dzisiaj }}" required class="w-auto" aria-label="Data planu">
        <input type="text" name="produkt" placeholder="Produkt" required class="select-flex" aria-label="Produkt">
        <input type="number" step="0.1" name="tonaz" placeholder="Plan (t)" required class="w-70" aria-label="Tonaz">
        <button type="submit" class="btn-add-plan">DODAJ</button>
    </form>
    {% endif %}
</div>