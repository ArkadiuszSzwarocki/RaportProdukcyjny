<div class="section-box">
    <div class="section-header">
        <h2>Obsada</h2>
    </div>

    <div class="mt-10">
        <div class="obsada-toolbar d-flex gap-10 align-center mb-8" style="flex-wrap: wrap;">
            <label for="obsada-date" style="font-weight: 600;">Data:</label>
            <input type="date" id="obsada-date" value="{{ qdate.strftime('%Y-%m-%d') if qdate is defined else '' }}" class="input-sm">
            {% if rola in ['lider','admin'] %}
            <label for="lider_psd" style="font-weight: 600; margin-left: 12px;">Lider PSD:</label>
            <select id="lider_psd" class="input-sm">
                <option value="">- brak -</option>
                {% for p in all_pracownicy %}
                <option value="{{ p[0] }}" {% if lider_psd_id and lider_psd_id == p[0] %}selected{% endif %}>{{ p[1] }}</option>
                {% endfor %}
            </select>
            <label for="lider_agro" style="font-weight: 600; margin-left: 12px;">Lider AGRO:</label>
            <select id="lider_agro" class="input-sm">
                <option value="">- brak -</option>
                {% for p in all_pracownicy %}
                <option value="{{ p[0] }}" {% if lider_agro_id and lider_agro_id == p[0] %}selected{% endif %}>{{ p[1] }}</option>
                {% endfor %}
            </select>
            <button type="button" id="btnSaveLiderzy" class="btn btn-primary">Zapisz lider√≥w</button>
            {% endif %}
        </div>
        <div class="obsada-sections">
            {% set sections = ['Zasyp','Workowanie','Magazyn','Hala Agro','Laboratorium','Handel'] %}
            {% for s in sections %}
            <div class="obsada-section" data-sekcja="{{ s }}">
                <h4>{{ s }}</h4>
                <!-- wyb√≥r pracownika + przycisk przeniesione na g√≥rƒô pod nazwƒÖ sekcji -->
                {% if rola in ['lider', 'admin', 'pracownik'] %}
                <div class="d-flex gap-5 align-center mb-8" style="flex-wrap: wrap;">
                    <input type="hidden" id="obsada-sekcja-{{ loop.index0 }}" value="{{ s }}">
                    <select id="obsada-select-{{ loop.index0 }}" title="Wybierz pracownika" aria-label="Wybierz pracownika" class="input-sm" style="flex: 1; min-width: 150px;">
                        <option value="" disabled selected>+ Wybierz pracownika</option>
                        {% for p in pracownicy %}<option value="{{ p[0] }}">{{ p[1] }}</option>{% endfor %}
                    </select>
                    <button type="button" id="btnAddObsada-{{ loop.index0 }}" class="btn btn-start">Dodaj</button>
                </div>
                {% endif %}

                <div id="current-obsada-{{ loop.index0 }}" class="mb-8">
                    {% set current = obsady_map.get(s, []) if obsady_map is defined else [] %}
                    {% if current %}
                    <table class="modern-table small obsada-table">
                        <thead><tr><th>Pracownik</th><th style="width:80px">Akcje</th></tr></thead>
                        <tbody id="current-obsada-tbody-{{ loop.index0 }}">
                        {% for o in current %}
                        <tr data-id="{{ o[0] }}">
                            <td><strong>{{ o[1] }}</strong></td>
                            <td>
                                {% if rola in ['lider', 'admin', 'pracownik'] %}
                                <form action="{{ url_for('api.usun_z_obsady', id=o[0]) }}" method="POST" class="m-0 d-inline-block">
                                    <button type="submit" class="delete-button" aria-label="Usu≈Ñ z obsady">üóëÔ∏è</button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                        <div class="text-muted">Brak przypisanych pracownik√≥w</div>
                    {% endif %}
                </div>

                <!-- immediate add: no pending list, no confirm/cancel buttons -->
            </div>
            {% endfor %}
        </div>

    <script>
    (function(){
        // Dynamicznie czytaj sekcje z HTML-u zamiast hardcoding
        const sectionEls = document.querySelectorAll('.obsada-section');
        const sections = Array.from(sectionEls).map(el => el.getAttribute('data-sekcja'));
        
        // Zapobiegaj zamkniƒôciu sidebara gdy klikniemy na selecty
        const allSelects = document.querySelectorAll('.obsada-toolbar select, .obsada-section select');
        allSelects.forEach(sel => {
            sel.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            sel.addEventListener('change', function(e) {
                e.stopPropagation();
            });
        });
        
        sections.forEach(function(name, idx){
            const select = document.getElementById('obsada-select-'+idx);
            const addBtn = document.getElementById('btnAddObsada-'+idx);
            const pending = document.getElementById('pending-list-'+idx);
            const sekcjaEl = document.getElementById('obsada-sekcja-'+idx);
            const sekcja = sekcjaEl ? sekcjaEl.value : name;
            const confirmBtn = document.getElementById('btnConfirmObsada-'+idx);
            const current = document.getElementById('current-obsada-'+idx);

            // Immediate add: when clicking 'Dodaj', send AJAX to add worker and update list
            if(addBtn){
                addBtn.addEventListener('click', async function(){
                    if(!select) return;
                    const val = select.value; const txt = select.options[select.selectedIndex] ? select.options[select.selectedIndex].text : '';
                    if(!val) return;
                    addBtn.disabled = true;
                    try{
                        const fd = new URLSearchParams(); fd.append('sekcja', sekcja); fd.append('pracownik_id', val);
                        const dateEl = document.getElementById('obsada-date'); const dateVal = dateEl ? dateEl.value : '';
                        if(dateVal) fd.append('date', dateVal);
                        const resp = await fetch('{{ url_for("api.dodaj_do_obsady") }}', { method: 'POST', body: fd, credentials: 'same-origin', headers: {'X-Requested-With':'XMLHttpRequest'} });
                        if(!resp.ok){ const txt = await resp.text(); showToast && showToast('B≈ÇƒÖd: '+ (txt||resp.status), 'error'); addBtn.disabled = false; return; }
                        let j = null;
                        try{ j = await resp.json(); }catch(e){ j = null; }
                        const newId = j && j.id ? j.id : null;
                        const newName = j && j.name ? j.name : txt;
                        if(current){
                            // if a table body exists, append a row; otherwise fallback to previous chip behavior
                            const tbody = document.getElementById('current-obsada-tbody-' + idx);
                            if(tbody){
                                const tr = document.createElement('tr');
                                if(newId) tr.setAttribute('data-id', newId);
                                const tdName = document.createElement('td'); tdName.innerHTML = '<strong>' + (newName||'') + '</strong>';
                                const tdAct = document.createElement('td');
                                if(newId){
                                    const form = document.createElement('form'); form.method = 'POST'; form.action = '/api/usun_z_obsady/' + newId; form.className='m-0 d-inline-block';
                                    const btn = document.createElement('button'); btn.type='submit'; btn.className='delete-button'; btn.innerHTML = 'üóëÔ∏è';
                                    form.appendChild(btn);
                                    tdAct.appendChild(form);
                                } else {
                                    const rem = document.createElement('button'); rem.className='delete-button'; rem.type='button'; rem.innerHTML='üóëÔ∏è'; rem.addEventListener('click', function(){ tr.remove(); });
                                    tdAct.appendChild(rem);
                                }
                                tr.appendChild(tdName); tr.appendChild(tdAct); tbody.appendChild(tr);
                            } else {
                                const chip = document.createElement('div'); chip.className = 'chip'; chip.textContent = newName;
                                if(newId){
                                    const form = document.createElement('form'); form.method = 'POST'; form.action = '/api/usun_z_obsady/' + newId; form.className='m-0'; form.style.display='inline-block'; form.style.marginLeft='6px';
                                    const btn = document.createElement('button'); btn.type='submit'; btn.className='delete-button'; btn.innerHTML='üóëÔ∏è';
                                    form.appendChild(btn);
                                    chip.appendChild(form);
                                } else {
                                    const rem = document.createElement('button'); rem.className='delete-button'; rem.type='button'; rem.innerHTML='üóëÔ∏è'; rem.style.marginLeft='6px';
                                    rem.addEventListener('click', function(){ chip.remove(); });
                                    chip.appendChild(rem);
                                }
                                current.appendChild(chip);
                            }
                        }
                        // remove option from select
                        try{ const opt = select.querySelector('option[value="'+val+'"]'); if(opt) opt.remove(); }catch(e){}
                        select.selectedIndex = 0;
                        showToast && showToast('Dodano pracownika','success');
                    }catch(e){ console.error(e); showToast && showToast('B≈ÇƒÖd sieci','error'); }
                    addBtn.disabled = false;
                });
            }

            // save leaders handler
            const saveBtn = document.getElementById('btnSaveLiderzy');
            if(saveBtn){
                saveBtn.addEventListener('click', async function(){
                    const dateEl = document.getElementById('obsada-date'); const dateVal = dateEl ? dateEl.value : '';
                    const lpsd = document.getElementById('lider_psd') ? document.getElementById('lider_psd').value : '';
                    const lagro = document.getElementById('lider_agro') ? document.getElementById('lider_agro').value : '';
                    saveBtn.disabled = true;
                    try{
                        const fd = new URLSearchParams(); if(dateVal) fd.append('date', dateVal); fd.append('lider_psd', lpsd); fd.append('lider_agro', lagro);
                        const resp = await fetch('{{ url_for("api.zapisz_liderow_obsady") }}', { method: 'POST', body: fd, credentials: 'same-origin', headers: {'X-Requested-With':'XMLHttpRequest'} });
                        if(!resp.ok){ const txt = await resp.text(); showToast && showToast('B≈ÇƒÖd zapisu lider√≥w: '+(txt||resp.status),'error'); saveBtn.disabled = false; return; }
                        showToast && showToast('Zapisano lider√≥w','success');
                    }catch(e){ console.error(e); showToast && showToast('B≈ÇƒÖd sieci','error'); }
                    saveBtn.disabled = false;
                });
            }

            if(current){
                // delegate delete button clicks inside the table body
                current.addEventListener('click', function(ev){
                    const t = ev.target;
                    if(!t.classList.contains('btn-delete')) return;
                    const frm = t.closest('form');
                    if(frm){
                        ev.preventDefault();
                        const url = frm.getAttribute('action') || window.location.href;
                        fetch(url, { method: 'POST', credentials: 'same-origin', headers: {'X-Requested-With':'XMLHttpRequest'} })
                        .then(async function(resp){
                            if(resp.status === 401){ window.location.href = '/login'; return; }
                            if(!resp.ok){ const txt = await resp.text(); showToast && showToast('B≈ÇƒÖd: '+(txt||resp.status),'error'); return; }
                            // remove the table row
                            const tr = t.closest('tr'); if(tr) tr.remove();
                            showToast && showToast('Usuniƒôto pracownika','success');
                        }).catch(function(err){ console.error('delete obsada failed', err); showToast && showToast('B≈ÇƒÖd sieci','error'); });
                    }
                });
            }

            // no pending list in immediate-add mode
        });
    })();
    </script>
</div>
