{% extends "layout.html" %}

{% block content %}
<div class="section-box">
    <div class="section-header">
        <h2>‚öôÔ∏è Ustawienia Workowania ‚Äî Czasy Przetwarzania</h2>
        <div>
            <a href="/admin/ustawienia" class="btn">‚Üê Powr√≥t do ustawie≈Ñ</a>
        </div>
    </div>

    <div class="section-padding">
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è O czasach przetwarzania:</strong><br/>
            Tutaj definiujesz ile minut trwa przetworzenie 1000 kg danego typu opakowania na sekcji Workowanie.
            Te czasy sƒÖ u≈ºywane do planowania i monitorowania wydajno≈õci.
        </div>

        <form action="/admin/ustawienia/workowanie_times/update" method="POST" class="form-grid">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>{{ _('typ_opakowania') }}</th>
                        <th>Opakowanie (szt kg)</th>
                        <th width="150">Czas przetwarzania (min na 1000 kg)</th>
                        <th>{{ _('opis') }}</th>
                        <th width="60" class="text-center">{{ _('akcje') }}</th>
                    </tr>
                </thead>
                <tbody id="timings-table-body">
                    {% for type_key, config in times_config.get('processing_times_minutes', {}).items() %}
                    <tr data-type-key="{{ type_key }}">
                        <td>
                            <input 
                                type="text" 
                                name="{{ type_key }}_name" 
                                value="{{ config.name }}"
                                placeholder="Typ opakowania"
                                class="input-sm input-name"
                                required
                            >
                        </td>
                        <td class="text-center">
                            <input 
                                type="number" 
                                name="{{ type_key }}_weight_kg" 
                                value="{{ config.weight_kg }}"
                                min="1"
                                max="10000"
                                class="input-sm text-center input-weight"
                                placeholder="0"
                            > kg
                        </td>
                        <td class="text-center">
                            <input 
                                type="number" 
                                name="{{ type_key }}_time_minutes" 
                                value="{{ config.processing_time_minutes }}"
                                min="1"
                                max="120"
                                class="input-sm text-center input-time-minutes"
                                title="Czas przetwarzania w minutach na 1000 kg"
                                required
                            > min
                        </td>
                        <td>
                            <input 
                                type="text" 
                                name="{{ type_key }}_description" 
                                value="{{ config.description }}"
                                placeholder="Opis (np. opakowanie, producent)"
                                class="input-sm input-description"
                                title="{{ _('opis_opakowania') }}"
                            >
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn-icon btn-delete-timing" title="Usu≈Ñ">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="mt-20 d-flex gap-10">
                <button type="button" class="btn btn-secondary" id="btnAddTiming">+ Dodaj nowy czas</button>
                <button type="submit" class="btn btn-primary">üíæ Zapisz wszystkie ustawienia</button>
            </div>
        </form>

        {% set has_times = times_config.get('processing_times_minutes') and times_config.get('processing_times_minutes')|length > 0 %}
        {% if not has_times %}
        <div class="alert alert-secondary mt-20">
            <strong>üìã Legenda:</strong>
            <ul>
                <li><strong>Big Bag:</strong> 1000 kg w {{ times_config.get('processing_times_minutes', {}).get('bigbag', {}).get('processing_time_minutes', 15) }} minut</li>
                <li><strong>Worki zgrzewane 20/25 kg:</strong> 1000 kg w {{ times_config.get('processing_times_minutes', {}).get('worki_zgrzewane_20', {}).get('processing_time_minutes', 20) }} minut</li>
                <li><strong>Worki zszywane 20/25 kg:</strong> 1000 kg w {{ times_config.get('processing_times_minutes', {}).get('worki_zszywane_20', {}).get('processing_time_minutes', 30) }} minut</li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<style>
.form-grid {
    margin-top: 20px;
}

.mt-20 {
    margin-top: 20px;
}

.d-flex {
    display: flex;
}

.gap-10 {
    gap: 10px;
}

.alert {
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 15px;
}

.alert-info {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    color: #1565c0;
}

.alert-secondary {
    background: #f5f5f5;
    border-left: 4px solid #666;
    color: #333;
}

.alert ul {
    margin: 10px 0 0 20px;
}

.alert li {
    margin: 5px 0;
}

.text-center {
    text-align: center;
}

.input-sm {
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.95em;
}

.btn-icon {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
    padding: 4px;
}

.btn-icon:hover {
    opacity: 0.7;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-secondary:hover {
    background: #7f8c8d;
}
</style>

<script>
(function() {
    const tbody = document.getElementById('timings-table-body');
    const btnAdd = document.getElementById('btnAddTiming');
    let rowCounter = Math.max(
        ...Array.from(tbody.querySelectorAll('tr')).map(row => {
            const text = row.getAttribute('data-type-key');
            return parseInt(text?.replace(/\D/g, '')) || 0;
        })
    ) + 1;

    function createNewRow() {
        const newKey = 'new_' + rowCounter++;
        const tr = document.createElement('tr');
        tr.setAttribute('data-type-key', newKey);
        tr.innerHTML = `
            <td>
                <input 
                    type="text" 
                    name="${newKey}_name" 
                    value=""
                    placeholder="Typ opakowania"
                    class="input-sm input-name"
                    required
                >
            </td>
            <td class="text-center">
                <input 
                    type="number" 
                    name="${newKey}_weight_kg" 
                    value="0"
                    min="1"
                    max="10000"
                    class="input-sm text-center input-weight"
                    placeholder="0"
                > kg
            </td>
            <td class="text-center">
                <input 
                    type="number" 
                    name="${newKey}_time_minutes" 
                    value="15"
                    min="1"
                    max="120"
                    class="input-sm text-center input-time-minutes"
                    title="Czas przetwarzania w minutach na 1000 kg"
                    required
                > min
            </td>
            <td>
                <input 
                    type="text" 
                    name="${newKey}_description" 
                    value=""
                    placeholder="Opis (np. opakowanie, producent)"
                    class="input-sm input-description"
                >
            </td>
            <td class="text-center">
                <button type="button" class="btn-icon btn-delete-timing" title="Usu≈Ñ">üóëÔ∏è</button>
            </td>
        `;
        tr.querySelector('.btn-delete-timing').addEventListener('click', function(e) {
            e.preventDefault();
            tr.remove();
        });
        return tr;
    }

        btnAdd.addEventListener('click', function(e) {
        e.preventDefault();
        tbody.appendChild(createNewRow());
    });

    // Przy usuwaniu istniejƒÖcych wierszy oznaczamy je do usuniƒôcia
    tbody.querySelectorAll('.btn-delete-timing').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const tr = btn.closest('tr');
            const key = tr.getAttribute('data-type-key') || '';
            if (key.startsWith('new_')) {
                // dla nowych, po prostu usu≈Ñ z DOM
                tr.remove();
            } else {
                // dla istniejƒÖcych oznacz pole do usuniƒôcia i ukryj wiersz
                let hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = key + '_deleted';
                hidden.value = '1';
                tr.appendChild(hidden);
                tr.style.display = 'none';
            }
        });
    });
})();
</script>

{% endblock %}
