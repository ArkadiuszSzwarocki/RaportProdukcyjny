{% extends "layout.html" %}

{% block content %}

<div class="section-header">
    <div><h2 class="header-title">ğŸ“… Panel Planisty</h2><p class="text-muted">ZarzÄ…dzanie produkcjÄ…</p></div>
    <form action="/planista" method="GET" class="d-flex align-center gap-10">
        <input type="date" name="data" value="{{ wybrana_data }}" onchange="this.form.submit()" class="input-sm" aria-label="Wybierz datÄ™">
        <a href="/planista?data={{ wybrana_data }}" class="btn btn-primary">OdÅ›wieÅ¼</a>
    </form>
</div>

{% if quality_count and quality_count > 0 %}
<div class="plan-box d-flex justify-between align-center">
    <div class="text-warning"><strong>ğŸ”” Laboratorium zgÅ‚osiÅ‚o {{ quality_count }}</strong> zleceÅ„ dezynfekcji na {{ wybrana_data }} â€” sprawdÅº JakoÅ›Ä‡ i dodaj do planÃ³w.</div>
    {% if session.get('rola') == 'planista' %}
        <div>
        <button type="button" class="btn-action btn-warning" data-slide-html='<div class="p-10"><h3>Funkcja dostÄ™pna na dedykowanej stronie</h3><p>Ta instalacja uÅ¼ywa stron zamiast wyskakujÄ…cych okien. JeÅ›li formularz istnieje, powinien otworzyÄ‡ siÄ™ w panelu bocznym.</p><p><button onclick="closeSlideOver()" class="btn-action">OK â€” zamknij</button></p></div>'>SzczegÃ³Å‚y dezynfekcji</button>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="stat-grid">
    
    <div class="stat-card {% if suma_minut_plan > 450 %}border-danger-left{% else %}border-success-left{% endif %}">
        <span class="label">ObÅ‚oÅ¼enie Zmiany (450 min)</span>
        <div class="header-title header-lg">{{ suma_minut_plan }} min</div>
        <div class="small text-muted">{% if suma_minut_plan > 450 %}âš ï¸ Przekroczono o {{ suma_minut_plan - 450 }} min!{% else %}Zapas: {{ 450 - suma_minut_plan }} min{% endif %}</div>
        <div class="progress"><div class="progress-bar {% if suma_minut_plan > 450 %}progress-bar-danger{% else %}progress-bar-success{% endif %} progress-w-{{ [procent_czasu, 100]|min|round(0)|int }}"></div></div>
    </div>

    <div class="stat-card border-primary-left">
        <span class="label">Plan Wagowy</span>
        <div class="header-title header-lg">{{ suma_plan|int }} kg</div>
        <div class="small text-muted">Cel: min 21 000 kg</div>
    </div>

    <div class="stat-card border-warning-left">
        <span class="label">Realizacja Planu</span>
        <div class="header-title header-lg {% if procent >= 100 %}text-success{% else %}text-warning{% endif %}">{{ procent|int }}%</div>
        <div class="small text-muted">Wykonano: {{ suma_wyk|int }} kg</div>
    </div>
</div>

    <div class="section-box section-box-no-pad">
        <div class="d-flex justify-between align-center p-15 p-15-bg">
        <h3 class="m-0">ğŸ“‹ GÅ‚Ã³wny Plan: <strong>{{ wybrana_data }}</strong></h3>
        <a href="{{ url_for('api.planista_bulk_page', data=wybrana_data) }}" id="btnDodajPlan" class="btn-action btn-action-success">+ DODAJ PLAN</a>
    </div>

    <table class="modern-table">
        <thead>
            <tr>
                <th>ğŸ“¦ Produkt</th>
                <th>ğŸ·ï¸ Typ</th>
                <th>ğŸ“‹ Plan</th>
                <th>â±ï¸ Estymacja</th>
                <th>âœ… Wykonanie</th>
                <th>ğŸ“š Palety</th>
                <th>ğŸ“Š Status</th>
                <th class="text-right">âš™ï¸ Akcje</th>
            </tr>
        </thead>
        <tbody>
            {% for p in plany %}
            <tr data-plan-id="{{ p[0] }}">
                <td><strong class="text-primary">{{ p[2] }}</strong></td>
                <td><span class="badge-sekcja">{{ p[9]|upper }}</span></td>
                <td><strong class="text-success">{{ p[3]|int }} kg</strong></td>
                <td>
                    <span class="duration-badge">{{ p[11] }} min</span>
                </td>
                <td>
                    {% if p[8] > 0 %}
                        <strong class="text-success">{{ p[8]|int }} kg</strong>
                        {% if p[10] %}<br><span class="small text-danger-color">âš ï¸ {{ p[10] }}</span>{% endif %}
                    {% else %}<span class="text-muted">-</span>{% endif %}
                </td>
                <td>
                    {% if palety_mapa[p[0]] %}
                        <button type="button" onclick="toggleDetails({{ p[0] }})" class="btn-toggle">ğŸ“¦ {{ palety_mapa[p[0]]|length }} szt.</button>
                    {% else %}<span class="text-muted">-</span>{% endif %}
                </td>
                <td>
                    {% if p[4] == 'zakonczone' %}<span class="status-badge status-zakonczone">âœ” ZAKOÅƒCZONE</span>
                    {% elif p[4] == 'w toku' %}<span class="status-badge status-wtoku">â³ W TOKU</span>
                    {% else %}<span class="status-badge status-zaplanowane">ZAPLANOWANE</span>{% endif %}
                </td>
                <td>
                    <div class="d-flex gap-5 align-center">
                        {% if p[4] not in ['w toku', 'zakonczone'] %}
                            <button type="button" onclick="moveUp({{ p[0] }})" class="btn-icon" aria-label="PrzenieÅ› w gÃ³rÄ™">â¬†</button>
                            <button type="button" onclick="moveDown({{ p[0] }})" class="btn-icon" aria-label="PrzenieÅ› w dÃ³Å‚">â¬‡</button>
                            <button type="button" onclick="deletePlanConfirm({{ p[0] }}, '{{ wybrana_data }}')" class="btn-icon text-danger-color" aria-label="UsuÅ„ plan">âœ–</button>
                            <button type="button" onclick="openMoveModal({{ p[0] }}, '{{ p[2] }}')" class="btn-icon text-primary" aria-label="PrzenieÅ› plan">ğŸ“…</button>
                            <button type="button" class="btn-icon" onclick="toggleEdit({{ p[0] }})" title="Edytuj">âœ</button>
                        {% else %}
                            <span class="text-muted fs-120" title="Zablokowane">ğŸ”’</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            
            {% if palety_mapa[p[0]] %}
            <tr id="details-{{ p[0] }}" class="details-row">
                <td colspan="8" class="p-0">
                    <div class="p-10">
                        <table class="modern-table small">
                            <thead><tr><th>Nr</th><th>ğŸ•’ Godzina</th><th>ğŸ“¦ Netto</th><th>âš–ï¸ Brutto</th><th>ğŸ“Œ Tara</th></tr></thead>
                            <tbody>
                                {% for pal in palety_mapa[p[0]] %}
                                <tr>
                                    <td class="text-muted font-bold">{{ loop.index }}</td><td class="time-display">{{ pal[1] }}</td><td><strong class="text-primary">{{ pal[0]|int }} kg</strong></td><td class="text-success">{{ pal[3]|int }} kg</td><td class="text-muted">{{ pal[2]|int }} kg</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% else %}<tr><td colspan="8" class="text-center p-20">Brak planu.</td></tr>{% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal Dodaj usuniÄ™ty (mechanizm popup wyÅ‚Ä…czony) -->

<!-- Modal Move usuniÄ™ty (mechanizm popup wyÅ‚Ä…czony) -->

    <script>
    function toggleDetails(id) { var row = document.getElementById('details-' + id); row.style.display = (row.style.display === 'none') ? 'table-row' : 'none'; }
    function openMoveModal(id, nazwa) {
        // show small modal inline for selecting date
        var modal = document.getElementById('moveModal');
        if(!modal) return alert('Brak modala');
        modal.style.display = 'block';
        modal.dataset.planId = id;
        modal.querySelector('.move-title').innerText = nazwa;
    }
    /* showModalDisabled removed â€” slide-over used as fallback instead */
</script>

<!-- Fallback modal-open listener removed -->

<!-- Move modal (inline) -->
<div id="moveModal" style="display:none; position:fixed; left:50%; top:40%; transform:translate(-50%,-50%); background:#fff; padding:15px; border:1px solid #ccc; z-index:2000;">
    <h3 class="move-title">PrzenieÅ› zlecenie</h3>
    <div style="margin:8px 0">Nowa data: <input type="date" id="move_to_date" value="{{ wybrana_data }}"></div>
    <div class="d-flex gap-5" style="justify-content:flex-end;">
        <button type="button" onclick="confirmMove()" class="btn-action btn-small">PrzenieÅ›</button>
        <button type="button" onclick="document.getElementById('moveModal').style.display='none'" class="btn-action btn-small btn-cancel">Anuluj</button>
    </div>
</div>

<script>
function confirmMove(){
    var modal = document.getElementById('moveModal');
    var id = modal.dataset.planId;
    var to_date = document.getElementById('move_to_date').value;
    if(!id || !to_date) return alert('Brakuje danych');
    fetch('/api/przenies_zlecenie_ajax', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:id, to_date: to_date})})
        .then(r=>r.json()).then(j=>{
            if(j && j.success){
                modal.style.display='none';
                // simple reload of page to reflect ordering and moved item
                location.reload();
            } else {
                alert((j && j.message) || 'BÅ‚Ä…d');
            }
        }).catch(()=>alert('BÅ‚Ä…d sieci'));
}
</script>
<script>
function moveUp(id){
    fetch('/api/przesun_zlecenie_ajax', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:id, kierunek:'gora', data: '{{ wybrana_data }}'})})
        .then(r=>r.json()).then(j=>{ if(j && j.success){ location.reload(); } else { alert((j && j.message)||'BÅ‚Ä…d'); } }).catch(()=>alert('BÅ‚Ä…d sieci'));
}
function moveDown(id){
    fetch('/api/przesun_zlecenie_ajax', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:id, kierunek:'dol', data: '{{ wybrana_data }}'})})
        .then(r=>r.json()).then(j=>{ if(j && j.success){ location.reload(); } else { alert((j && j.message)||'BÅ‚Ä…d'); } }).catch(()=>alert('BÅ‚Ä…d sieci'));
}
function deletePlanConfirm(id, data){ if(!confirm('UsunÄ…Ä‡?')) return; deletePlan(id, data); }
function deletePlan(id, data){
    fetch('/api/usun_plan_ajax/'+id, {method:'POST'}).then(r=>{
        if(r.ok){
            // Reload regardless of JSON payload to ensure UI reflects server state
            location.reload();
            return null;
        }
        return r.json().catch(()=>null);
    }).then(j=>{
        if(j && !j.success){ alert(j.message || 'BÅ‚Ä…d'); }
    }).catch(()=>alert('BÅ‚Ä…d sieci'));
}
</script>
<script>
    function toggleEdit(id){
        var tr = document.querySelector('tr[data-plan-id="'+id+'"]');
        if(!tr) return;
        var editRow = document.getElementById('edit-row-'+id);
        if(editRow){
            // toggle visibility
            editRow.style.display = (editRow.style.display === 'none') ? 'table-row' : 'none';
            return;
        }
        // create edit row after current row
        var newTr = document.createElement('tr');
        newTr.id = 'edit-row-' + id;
        newTr.className = 'edit-row';
        var cols = [];
        cols.push('<td colspan="2">');
        cols.push('Produkt: <input id="e_prod_'+id+'" name="produkt" value="'+(tr.children[0].innerText.trim())+'" required> ');
        cols.push('Typ: <input id="e_sekc_'+id+'" name="sekcja" value="'+(tr.querySelector('.badge-sekcja')?tr.querySelector('.badge-sekcja').innerText:'')+'"> ');
        cols.push('</td>');
        cols.push('<td>Plan: <input id="e_ton_'+id+'" name="tonaz" type="number" step="0.1" value="'+(tr.children[2].innerText.replace(/[^0-9\.\,]/g,'')||0)+'"></td>');
        cols.push('<td colspan="2">');
        cols.push('Data: <input id="e_date_'+id+'" name="data_planu" type="date" value="{{ wybrana_data }}">');
        cols.push('</td>');
        cols.push('<td colspan="3">');
        cols.push('<button type="button" onclick="submitEdit('+id+')" class="btn-action btn-small">Zapisz</button> ');
        cols.push('<button type="button" class="btn-action btn-small btn-cancel" onclick="document.getElementById(\'edit-row-'+id+'\').style.display=\'none\'">Anuluj</button>');
        cols.push('</td>');
        newTr.innerHTML = cols.join('');
        tr.parentNode.insertBefore(newTr, tr.nextSibling);
    }

    function submitEdit(id){
        var prod = document.getElementById('e_prod_'+id).value;
        var sek = document.getElementById('e_sekc_'+id).value;
        var ton = document.getElementById('e_ton_'+id).value;
        var dt = document.getElementById('e_date_'+id).value;
        fetch('/api/edytuj_plan_ajax', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({id: id, produkt: prod, sekcja: sek, tonaz: ton, data_planu: dt})
        }).then(r=>r.json()).then(j=>{
            if(j && j.success){
                // update row DOM
                var tr = document.querySelector('tr[data-plan-id="'+id+'"]');
                if(tr){ tr.children[0].innerText = prod; tr.querySelector('.badge-sekcja').innerText = (sek||'').toUpperCase(); tr.children[2].innerText = (parseFloat(ton)||0)+' kg'; }
                var er = document.getElementById('edit-row-'+id); if(er) er.style.display='none';
            } else {
                alert((j && j.message) || 'BÅ‚Ä…d');
            }
        }).catch(()=>alert('BÅ‚Ä…d sieci'));
    }


<!-- Modal: SzczegÃ³Å‚y zleceÅ„ jakoÅ›ciowych usuniÄ™ty -->

 
{% endblock %}