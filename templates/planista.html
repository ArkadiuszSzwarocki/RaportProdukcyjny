{% extends "layout.html" %}

{% block content %}

<div class="section-header">
    <div><h2 class="header-title">üìÖ Panel Planisty</h2><p class="text-muted">ZarzƒÖdzanie produkcjƒÖ</p></div>
    <form action="/planista" method="GET" style="display:flex; align-items:center; gap:10px;">
        <input type="date" name="data" value="{{ wybrana_data }}" onchange="this.form.submit()" style="padding:8px; border:1px solid #ccc; border-radius:4px; font-size:1.1em;">
        <a href="/planista?data={{ wybrana_data }}" class="btn" style="background:#3498db; color:white;">Od≈õwie≈º</a>
    </form>
</div>

<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;">
    
    <div class="stat-card" style="border-left: 5px solid {% if suma_minut_plan > 450 %}#e74c3c{% else %}#2ecc71{% endif %};">
        <span class="label">Ob≈Ço≈ºenie Zmiany (450 min)</span>
        <div style="font-size:1.8em; font-weight:bold; color:{% if suma_minut_plan > 450 %}#e74c3c{% else %}#2c3e50{% endif %};">
            {{ suma_minut_plan }} min
        </div>
        <div style="font-size:0.8em; color:#7f8c8d;">
            {% if suma_minut_plan > 450 %}‚ö†Ô∏è Przekroczono o {{ suma_minut_plan - 450 }} min!{% else %}Zapas: {{ 450 - suma_minut_plan }} min{% endif %}
        </div>
        <div style="width:100%; background:#ecf0f1; height:6px; border-radius:3px; margin-top:5px;">
            <div style="height:100%; width:{{ [procent_czasu, 100]|min }}%; background:{% if suma_minut_plan > 450 %}#e74c3c{% else %}#2ecc71{% endif %};"></div>
        </div>
    </div>

    <div class="stat-card" style="border-left: 5px solid #34495e;">
        <span class="label">Plan Wagowy</span>
        <div style="font-size:1.8em; font-weight:bold; color:#34495e;">{{ suma_plan|int }} kg</div>
        <div style="font-size:0.8em; color:#999;">Cel: min 21 000 kg</div>
    </div>

    <div class="stat-card" style="border-left: 5px solid #f39c12;">
        <span class="label">Realizacja Planu</span>
        <div style="font-size:1.8em; font-weight:bold; color:{% if procent >= 100 %}#27ae60{% else %}#e67e22{% endif %};">{{ procent|int }}%</div>
        <div style="font-size:0.8em; color:#7f8c8d;">Wykonano: {{ suma_wyk|int }} kg</div>
    </div>
</div>

<div class="section-box" style="padding:0;">
    <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:#2c3e50;">üìã G≈Ç√≥wny Plan: <strong>{{ wybrana_data }}</strong></h3>
        <button onclick="document.getElementById('modalDodaj').style.display='flex'" class="btn-action" style="background:#2ecc71; color:white;">+ DODAJ PLAN</button>
    </div>

    <table class="modern-table">
        <thead>
            <tr>
                <th>Produkt</th>
                <th>Typ</th>
                <th>Plan (kg)</th>
                <th>Estymacja</th> <th>Wykonanie (kg)</th>
                <th>Palety</th>
                <th>Status</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            {% for p in plany %}
            <tr style="border-bottom:1px solid #eee;">
                <td><strong style="color:var(--primary-color); font-size:1.1em;">{{ p[2] }}</strong></td>
                <td style="font-size:0.8em; color:#777;">{{ p[9]|upper }}</td>
                <td><strong>{{ p[3]|int }} kg</strong></td>
                
                <td style="color:#555; font-size:0.9em;">
                    <span class="material-icons" style="font-size:1em; vertical-align:middle; color:#95a5a6;">schedule</span> 
                    ~{{ p[11] }} min
                </td>

                <td>
                    {% if p[8] > 0 %}
                        <strong style="color:green;">{{ p[8]|int }} kg</strong>
                        {% if p[10] %}<br><span style="font-size:0.7em; color:red;">‚ö†Ô∏è {{ p[10] }}</span>{% endif %}
                    {% else %}<span style="color:#ccc;">-</span>{% endif %}
                </td>
                <td>
                    {% if palety_mapa[p[0]] %}
                        <button onclick="toggleDetails({{ p[0] }})" class="btn-toggle">üì¶ {{ palety_mapa[p[0]]|length }} szt. ‚ñº</button>
                    {% else %}<span style="color:#ccc;">-</span>{% endif %}
                </td>
                <td>
                    {% if p[4] == 'zakonczone' %}<span style="color:green; font-weight:bold;">‚úî Zako≈Ñczone</span>
                    {% elif p[4] == 'w toku' %}<span style="color:#e67e22; font-weight:bold; animation: pulse 2s infinite;">‚è≥ W toku</span>
                    {% else %}<span style="color:#7f8c8d;">Zaplanowane</span>{% endif %}
                </td>
                <td>
                    <div style="display:flex; gap:5px; align-items:center;">
                        {% if p[4] not in ['w toku', 'zakonczone'] %}
                            <form action="/przesun_zlecenie/{{ p[0] }}/gora?data={{ wybrana_data }}" method="POST"><button class="btn-icon">‚¨Ü</button></form>
                            <form action="/przesun_zlecenie/{{ p[0] }}/dol?data={{ wybrana_data }}" method="POST"><button class="btn-icon">‚¨á</button></form>
                            <form action="/usun_plan/{{ p[0] }}" method="POST" onsubmit="return confirm('UsunƒÖƒá?')">
                                <input type="hidden" name="widok_powrotu" value="planista"><input type="hidden" name="data_powrotu" value="{{ wybrana_data }}">
                                <button class="btn-icon" style="color:red;">‚úñ</button>
                            </form>
                            <button onclick="openMoveModal({{ p[0] }}, '{{ p[2] }}')" class="btn-icon" style="color:#3498db;">üìÖ</button>
                        {% else %}
                            <span style="color:#ccc; font-size:1.2em;" title="Zablokowane">üîí</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            
            {% if palety_mapa[p[0]] %}
            <tr id="details-{{ p[0] }}" style="display:none; background-color:#fafafa; border-left: 4px solid #8e44ad;">
                <td colspan="8" style="padding:0;">
                    <div style="padding:10px 50px;">
                        <table style="width:100%; font-size:0.85em; background:white; border:1px solid #ddd;">
                            <thead style="background:#eee;"><tr><th>Nr</th><th>Godzina</th><th>Netto</th><th>Brutto</th><th>Tara</th></tr></thead>
                            <tbody>
                                {% for pal in palety_mapa[p[0]] %}
                                <tr>
                                    <td>{{ loop.index }}</td><td>üïí {{ pal[1] }}</td><td><strong>{{ pal[0]|int }} kg</strong></td><td>{{ pal[3]|int }} kg</td><td style="color:#7f8c8d;">{{ pal[2]|int }} kg</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% else %}<tr><td colspan="8" style="text-align:center; padding:20px;">Brak planu.</td></tr>{% endfor %}
        </tbody>
    </table>
</div>

<div id="modalDodaj" class="modal-popup" style="display:none;">
    <h3>‚ûï Dodaj Zlecenie</h3>
    <form action="/dodaj_plan_zaawansowany" method="POST" style="display:flex; flex-direction:column; gap:10px;">
        <input type="hidden" name="data_planu" value="{{ wybrana_data }}">
        <input type="hidden" name="sekcja" value="Zasyp">
        <label>Typ:</label>
        <select name="typ_produkcji" style="padding:8px;">
            <option value="standard">Standard (25kg)</option>
            <option value="bigbag">Big Bag</option>
            <option value="szycie">Szycie</option>
        </select>
        <label>Produkt:</label>
        <input type="text" name="produkt" required placeholder="np. Ekogroszek" style="padding:8px;">
        <label>Ilo≈õƒá (kg):</label>
        <input type="number" step="1" name="tonaz" required placeholder="np. 24000" style="padding:8px;">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button type="submit" class="btn-action" style="background:#27ae60; color:white; flex:1;">ZAPISZ</button>
            <button type="button" onclick="document.getElementById('modalDodaj').style.display='none'" class="btn-action" style="background:#95a5a6; color:white; flex:1;">ANULUJ</button>
        </div>
    </form>
</div>

<div id="modalMove" class="modal-popup" style="display:none;">
    <h3>üìÖ Przenie≈õƒá?</h3>
    <p id="moveProduktName" style="font-weight:bold;"></p>
    <form action="" id="formMove" method="POST" style="display:flex; flex-direction:column; gap:10px;">
        <label>Data:</label>
        <input type="date" name="nowa_data" required style="padding:8px;">
        <div style="display:flex; gap:10px;">
            <button type="submit" class="btn-action" style="background:#3498db; color:white; flex:1;">PRZENIE≈ö</button>
            <button type="button" onclick="document.getElementById('modalMove').style.display='none'" class="btn-action" style="background:#95a5a6; color:white; flex:1;">ANULUJ</button>
        </div>
    </form>
</div>

<script>
    function toggleDetails(id) { var row = document.getElementById('details-' + id); row.style.display = (row.style.display === 'none') ? 'table-row' : 'none'; }
    function openMoveModal(id, nazwa) { document.getElementById('modalMove').style.display = 'flex'; document.getElementById('moveProduktName').innerText = nazwa; document.getElementById('formMove').action = "/przenies_zlecenie/" + id; }
</script>

<style>
    .stat-card { background:white; padding:15px; border-radius:8px; border:1px solid #ddd; text-align:center; }
    .modal-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); z-index: 1000; flex-direction: column; min-width: 300px; border: 1px solid #ddd; }
    .btn-icon { background:none; border:none; cursor:pointer; font-size:1.1em; padding:2px 5px; }
    .btn-toggle { background:none; border:1px solid #ccc; border-radius:12px; font-size:0.75em; padding:2px 8px; cursor:pointer; color:#555; }
</style>
{% endblock %}