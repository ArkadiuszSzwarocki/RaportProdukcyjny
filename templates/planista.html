{% extends "layout.html" %}

{% block content %}

<div class="section-header">
    <div><h2 class="header-title">üìÖ Panel Planisty</h2><p class="text-muted">ZarzƒÖdzanie produkcjƒÖ</p></div>
    <form action="/planista" method="GET" class="d-flex align-center gap-10">
        <input type="date" name="data" value="{{ wybrana_data }}" onchange="this.form.submit()" class="input-sm" aria-label="Wybierz datƒô">
        <a href="/planista?data={{ wybrana_data }}" class="btn btn-primary">Od≈õwie≈º</a>
    </form>
</div>

{% if quality_count and quality_count > 0 %}
<div class="plan-box d-flex justify-between align-center">
    <div class="text-warning"><strong>üîî Laboratorium zg≈Çosi≈Ço {{ quality_count }}</strong> zlece≈Ñ dezynfekcji na {{ wybrana_data }} ‚Äî sprawd≈∫ Jako≈õƒá i dodaj do plan√≥w.</div>
    {% if session.get('rola') == 'planista' %}
    <div>
        <button type="button" onclick="document.getElementById('modalJakosc').classList.remove('hidden')" class="btn-action btn-warning">Szczeg√≥≈Çy dezynfekcji</button>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="stat-grid">
    
    <div class="stat-card {% if suma_minut_plan > 450 %}border-danger-left{% else %}border-success-left{% endif %}">
        <span class="label">Ob≈Ço≈ºenie Zmiany (450 min)</span>
        <div class="header-title header-lg">{{ suma_minut_plan }} min</div>
        <div class="small text-muted">{% if suma_minut_plan > 450 %}‚ö†Ô∏è Przekroczono o {{ suma_minut_plan - 450 }} min!{% else %}Zapas: {{ 450 - suma_minut_plan }} min{% endif %}</div>
        <div class="progress"><div class="progress-bar {% if suma_minut_plan > 450 %}progress-bar-danger{% else %}progress-bar-success{% endif %} progress-w-{{ [procent_czasu, 100]|min|round(0)|int }}"></div></div>
    </div>

    <div class="stat-card border-primary-left">
        <span class="label">Plan Wagowy</span>
        <div class="header-title header-lg">{{ suma_plan|int }} kg</div>
        <div class="small text-muted">Cel: min 21 000 kg</div>
    </div>

    <div class="stat-card border-warning-left">
        <span class="label">Realizacja Planu</span>
        <div class="header-title header-lg {% if procent >= 100 %}text-success{% else %}text-warning{% endif %}">{{ procent|int }}%</div>
        <div class="small text-muted">Wykonano: {{ suma_wyk|int }} kg</div>
    </div>
</div>

    <div class="section-box section-box-no-pad">
        <div class="d-flex justify-between align-center p-15 p-15-bg">
        <h3 class="m-0">üìã G≈Ç√≥wny Plan: <strong>{{ wybrana_data }}</strong></h3>
        <button type="button" onclick="document.getElementById('modalDodaj').classList.remove('hidden')" class="btn-action btn-action-success">+ DODAJ PLAN</button>
    </div>

    <table class="modern-table">
        <thead>
            <tr>
                <th>Produkt</th>
                <th>Typ</th>
                <th>Plan (kg)</th>
                <th>Estymacja</th> <th>Wykonanie (kg)</th>
                <th>Palety</th>
                <th>Status</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            {% for p in plany %}
            <tr>
                <td><strong class="header-title">{{ p[2] }}</strong></td>
                <td class="small text-muted">{{ p[9]|upper }}</td>
                <td><strong>{{ p[3]|int }} kg</strong></td>
                
                <td class="small text-muted">
                    <span class="material-icons icon-muted">schedule</span> 
                    ~{{ p[11] }} min
                </td>

                <td>
                        {% if p[8] > 0 %}
                        <strong class="text-success">{{ p[8]|int }} kg</strong>
                        {% if p[10] %}<br><span class="small text-danger-color">‚ö†Ô∏è {{ p[10] }}</span>{% endif %}
                    {% else %}<span class="text-muted">-</span>{% endif %}
                </td>
                <td>
                    {% if palety_mapa[p[0]] %}
                        <button type="button" onclick="toggleDetails({{ p[0] }})" class="btn-toggle">üì¶ {{ palety_mapa[p[0]]|length }} szt. ‚ñº</button>
                    {% else %}<span class="text-muted">-</span>{% endif %}
                </td>
                <td>
                    {% if p[4] == 'zakonczone' %}<span class="text-success font-bold">‚úî Zako≈Ñczone</span>
                    {% elif p[4] == 'w toku' %}<span class="text-warning font-bold pulse-animation">‚è≥ W toku</span>
                    {% else %}<span class="text-muted">Zaplanowane</span>{% endif %}
                </td>
                <td>
                    <div class="d-flex gap-5 align-center">
                        {% if p[4] not in ['w toku', 'zakonczone'] %}
                            <form action="/przesun_zlecenie/{{ p[0] }}/gora?data={{ wybrana_data }}" method="POST"><button type="submit" class="btn-icon" aria-label="Przenie≈õ w g√≥rƒô">‚¨Ü</button></form>
                            <form action="/przesun_zlecenie/{{ p[0] }}/dol?data={{ wybrana_data }}" method="POST"><button type="submit" class="btn-icon" aria-label="Przenie≈õ w d√≥≈Ç">‚¨á</button></form>
                            <form action="/usun_plan/{{ p[0] }}" method="POST" onsubmit="return confirm('UsunƒÖƒá?')">
                                <input type="hidden" name="widok_powrotu" value="planista"><input type="hidden" name="data_powrotu" value="{{ wybrana_data }}">
                                <button type="submit" class="btn-icon text-danger-color" aria-label="Usu≈Ñ plan">‚úñ</button>
                            </form>
                            <button type="button" onclick="openMoveModal({{ p[0] }}, '{{ p[2] }}')" class="btn-icon text-primary" aria-label="Przenie≈õ plan">üìÖ</button>
                        {% else %}
                            <span class="text-muted fs-120" title="Zablokowane">üîí</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            
            {% if palety_mapa[p[0]] %}
            <tr id="details-{{ p[0] }}" class="details-row">
                <td colspan="8" class="p-0">
                    <div class="p-10">
                        <table class="small-table">
                            <thead><tr><th>Nr</th><th>Godzina</th><th>Netto</th><th>Brutto</th><th>Tara</th></tr></thead>
                            <tbody>
                                {% for pal in palety_mapa[p[0]] %}
                                <tr>
                                    <td>{{ loop.index }}</td><td>üïí {{ pal[1] }}</td><td><strong>{{ pal[0]|int }} kg</strong></td><td>{{ pal[3]|int }} kg</td><td class="text-muted">{{ pal[2]|int }} kg</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% else %}<tr><td colspan="8" class="text-center p-20">Brak planu.</td></tr>{% endfor %}
        </tbody>
    </table>
</div>

<div id="modalDodaj" class="modal-popup hidden">
    <h3>‚ûï Dodaj Zlecenie</h3>
    <form action="/dodaj_plan_zaawansowany" method="POST" class="d-flex flex-column gap-10">
        <input type="hidden" name="data_planu" value="{{ wybrana_data }}">
        <input type="hidden" name="sekcja" value="Zasyp">
        <label>Typ:</label>
        <select name="typ_produkcji" class="input-sm" title="Typ produkcji" aria-label="Typ produkcji">
            <option value="standard">Standard (25kg)</option>
            <option value="bigbag">Big Bag</option>
            <option value="szycie">Szycie</option>
        </select>
        <label>Produkt:</label>
            <input type="text" name="produkt" required placeholder="np. Ekogroszek" class="input-sm" aria-label="Produkt">
        <label>Ilo≈õƒá (kg):</label>
            <input type="number" step="1" name="tonaz" required placeholder="np. 24000" class="input-sm" aria-label="Tona≈º planu">
        <div class="d-flex gap-10">
            <button type="submit" class="btn-action btn-action-success flex-1">ZAPISZ</button>
            <button type="button" onclick="document.getElementById('modalDodaj').classList.add('hidden')" class="btn-action btn-action-cancel flex-1">ANULUJ</button>
        </div>
    </form>
</div>

<div id="modalMove" class="modal-popup hidden">
    <h3>üìÖ Przenie≈õƒá?</h3>
    <p id="moveProduktName" class="font-bold"></p>
    <form action="" id="formMove" method="POST" class="d-flex flex-column gap-10">
        <label>Data:</label>
            <input type="date" name="nowa_data" required class="input-sm" aria-label="Nowa data">
        <div class="d-flex gap-10">
            <button type="submit" class="btn-action btn-action-success flex-1">PRZENIE≈ö</button>
            <button type="button" onclick="document.getElementById('modalMove').classList.add('hidden')" class="btn-action btn-action-cancel flex-1">ANULUJ</button>
        </div>
    </form>
</div>

<script>
    function toggleDetails(id) { var row = document.getElementById('details-' + id); row.style.display = (row.style.display === 'none') ? 'table-row' : 'none'; }
    function openMoveModal(id, nazwa) { document.getElementById('modalMove').style.display = 'flex'; document.getElementById('moveProduktName').innerText = nazwa; document.getElementById('formMove').action = "/przenies_zlecenie/" + id; }
</script>


<!-- Modal: Szczeg√≥≈Çy zlece≈Ñ jako≈õciowych -->
<div id="modalJakosc" class="modal-popup hidden">
        <h3>üî¨ Zlecenia zg≈Çoszone przez laboratorium - {{ wybrana_data }}</h3>
        {% if quality_orders and quality_orders|length > 0 %}
        <div class="max-h-60vh">
            <table class="small-table">
                <thead><tr><th>ID</th><th>Produkt</th><th>Tona≈º</th><th>Sekcja</th><th>Status</th><th>Akcje</th></tr></thead>
                <tbody>
                {% for q in quality_orders %}
                    <tr>
                        <td>{{ q[0] }}</td>
                        <td>{{ q[1] }}</td>
                        <td>{{ q[2] or '-' }}</td>
                        <td>{{ q[3] }}</td>
                        <td>{{ q[4] }}</td>
                        <td>
                            <div class="d-flex gap-6">
                                <a href="{{ url_for('jakosc_detail', plan_id=q[0]) }}" class="btn-action btn-primary">Szczeg√≥≈Çy</a>
                                <form action="{{ url_for('api.jakosc_dodaj_do_planow', id=q[0]) }}" method="POST" class="inline-form">
                                    <input type="hidden" name="data_planu" value="{{ wybrana_data }}">
                                    <input type="hidden" name="data_powrot" value="{{ wybrana_data }}">
                                    <button type="submit" class="btn-action btn-action-success">Dodaj do planu</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <div class="text-muted">Brak zg≈Çosze≈Ñ jako≈õciowych dla wybranej daty.</div>
        {% endif %}
        <div class="d-flex gap-8 mb-10">
            <button type="button" onclick="document.getElementById('modalJakosc').classList.add('hidden')" class="btn-action btn-action-cancel">Zamknij</button>
        </div>
</div>

 
{% endblock %}