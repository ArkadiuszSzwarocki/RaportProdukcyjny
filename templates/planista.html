{% extends "layout.html" %}

{% block content %}

<!-- Sortable.js for drag-and-drop reordering -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<div class="section-header">
    <div><h2 class="header-title">üìÖ Panel Planisty</h2><p class="text-muted">{{ _('zarzadzanie_produkcja') }}</p></div>
    <form action="/planista" method="GET" class="d-flex align-center gap-10">
        <input type="date" name="data" value="{{ wybrana_data }}" onchange="this.form.submit()" class="input-sm" aria-label="Wybierz datƒô">
        <a href="/planista?data={{ wybrana_data }}" class="btn btn-primary">{{ _('odswiez') }}</a>
    </form>
</div>

{% if quality_count and quality_count > 0 %}
<div class="plan-box d-flex justify-between align-center">
    <div class="text-warning"><strong>üîî Laboratorium zg≈Çosi≈Ço {{ quality_count }}</strong> zlece≈Ñ dezynfekcji na {{ wybrana_data }} ‚Äî sprawd≈∫ Jako≈õƒá i dodaj do plan√≥w.</div>
    {% if session.get('rola') == 'planista' %}
        <div>
        <button type="button" class="btn-action btn-warning">{{ _('szczegoly_dezynfekcji') }}</button>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="stat-grid">
    
    <div class="stat-card {% if suma_minut_plan > 450 %}border-danger-left{% else %}border-success-left{% endif %}">
        <span class="label">{{ _('oblegenie_zmiany') }}</span>
        <div class="header-title header-lg">{{ suma_minut_plan }} min</div>
        <div class="small text-muted">{% if suma_minut_plan > 450 %}‚ö†Ô∏è Przekroczono o {{ suma_minut_plan - 450 }} min!{% else %}Zapas: {{ 450 - suma_minut_plan }} min{% endif %}</div>
        <div class="progress"><div class="progress-bar {% if suma_minut_plan > 450 %}progress-bar-danger{% else %}progress-bar-success{% endif %} progress-w-{{ [procent_czasu, 100]|min|round(0)|int }}"></div></div>
    </div>

    <div class="stat-card border-primary-left">
        <span class="label">Plan Wagowy</span>
        <div class="header-title header-lg">{{ suma_plan|int }} kg</div>
        <div class="small text-muted">Cel: min 21 000 kg</div>
    </div>

    <div class="stat-card border-warning-left">
        <span class="label">Realizacja Planu</span>
        <div class="header-title header-lg {% if procent >= 100 %}text-success{% else %}text-warning{% endif %}">{{ procent|int }}%</div>
        <div class="small text-muted">Wykonano: {{ suma_wyk|int }} kg</div>
    </div>
</div>

{# BUFOR przeniesiony na osobnƒÖ stronƒô /bufor ‚Äî patrz templates/bufor.html #}

    <div class="section-box section-box-no-pad">
        <div class="d-flex justify-between align-center p-15 p-15-bg">
            <h3 class="m-0">üìã G≈Ç√≥wny Plan: <strong>{{ wybrana_data }}</strong></h3>
            <div class="d-flex gap-10 align-center">
                <a href="{{ url_for('planning.planista_bulk_page', data=wybrana_data) }}" id="btnDodajPlan" class="btn-action btn-action-success">+ DODAJ PLAN</a>
                <!-- Quick add cleaning form -->
                <form action="/planista/add_czyszczenie" method="POST" class="d-flex align-center gap-5" style="align-items:center;">
                    <input type="hidden" name="data_planu" value="{{ wybrana_data }}">
                    <label class="small text-muted">Czyszczenie:</label>
                    <input type="number" name="tonaz" min="0" step="1" placeholder="kg" class="input-sm" style="width:80px;">
                    <input type="number" name="kolejnosc" min="1" step="1" placeholder="poz." class="input-sm" style="width:80px;">
                    <button type="submit" class="btn-action btn-small btn-warning">Dodaj</button>
                </form>
            </div>
        </div>

    <table class="modern-table">
        <thead>
            <tr>
                <th>üì¶ Produkt</th>
                <th>üè∑Ô∏è Typ</th>
                <th>üìã Plan</th>
                <th>‚è±Ô∏è Estymacja</th>
                <th>‚úÖ Wykonanie</th>
                <th>üìö Palety</th>
                <th>ÔøΩ Uszkodzone Worki</th>
                <th>ÔøΩüìä Status</th>
                <th class="text-right">‚öôÔ∏è Akcje</th>
            </tr>
        </thead>
        <tbody id="plans-tbody" class="sortable-tbody">
            {% for p in plany %}
            <tr data-plan-id="{{ p[0] }}">
                <td><strong class="text-primary">{{ p[2] }}</strong></td>
                <td><span class="badge-sekcja">{{ p[9]|upper }}</span></td>
                <td><strong class="text-success">{{ p[3]|int }} kg</strong></td>
                <td>
                    <span class="duration-badge">{{ p[12]|default(0) }} min</span>
                </td>
                <td>
                    {% if (p[8]|default(0, true)) > 0 %}
                        <strong class="text-success">{{ p[8]|int }} kg</strong>
                        {% if p[10] %}<br><span class="small text-danger-color">‚ö†Ô∏è {{ p[10] }}</span>{% endif %}
                    {% else %}<span class="text-muted">-</span>{% endif %}
                </td>
                <td>
                    {% if palety_mapa[p[0]] %}
                        <button type="button" data-action="toggle-details" data-plan-id="{{ p[0] }}" class="btn-toggle">üì¶ {{ palety_mapa[p[0]]|length }} szt.</button>
                    {% else %}<span class="text-muted">-</span>{% endif %}
                </td>
                <td>
                    <input type="number" class="input-sm uszkodzone-worki-input" data-plan-id="{{ p[0] }}" value="{{ p[11]|default(0, true)|int }}" min="0" max="999999" style="width: 80px;" title="Liczba uszkodzonych work√≥w" />
                </td>
                <td>
                    {% if p[4] == 'zakonczone' %}<span class="status-badge status-zakonczone">‚úî ZAKO≈ÉCZONE</span>
                    {% elif p[4] == 'w toku' %}<span class="status-badge status-wtoku">‚è≥ W TOKU</span>
                    {% else %}<span class="status-badge status-zaplanowane">{{ _('zaplanowane_btn') }}</span>{% endif %}
                </td>
                <td>
                    <div class="d-flex gap-5 align-center">
                        {% if p[4] not in ['w toku', 'zakonczone'] %}
                            <button type="button" data-action="move-up" data-plan-id="{{ p[0] }}" class="btn-icon" aria-label="Przenie≈õ w g√≥rƒô">‚¨Ü</button>
                            <button type="button" data-action="move-down" data-plan-id="{{ p[0] }}" class="btn-icon" aria-label="Przenie≈õ w d√≥≈Ç">‚¨á</button>
                            <button type="button" data-action="open-move-modal" data-plan-id="{{ p[0] }}" data-plan-day="{{ p[2] }}" class="btn-icon text-primary" aria-label="Przenie≈õ plan">üìÖ</button>
                            <button type="button" class="btn-icon" data-action="toggle-edit" data-plan-id="{{ p[0] }}" title="{{ _('edytuj') }}">‚úé</button>
                            <form action="{{ url_for('planning.usun_plan', id=p[0]) }}" method="POST" class="inline-form" onsubmit="return confirm('UsunƒÖƒá zlecenie?');">
                                <input type="hidden" name="data_planu" value="{{ wybrana_data }}">
                                <button type="submit" class="btn-icon text-danger" title="{{ _('usun_plan') }}">üóëÔ∏è</button>
                            </form>
                        {% else %}
                            <span class="text-muted fs-120" title="{{ _('zablokowane') }}">üîí</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            
            {% if palety_mapa[p[0]] %}
            <tr id="details-{{ p[0] }}" class="details-row">
                <td colspan="8" class="p-0">
                    <div class="p-10">
                        <table class="modern-table small">
                            <thead><tr><th>{{ _('nr') }}</th><th>üïí Godzina</th><th>üì¶ Netto</th><th>‚öñÔ∏è Brutto</th><th>üìå Tara</th></tr></thead>
                            <tbody>
                                {% for pal in palety_mapa[p[0]] %}
                                <tr>
                                    <td class="text-muted font-bold">{{ loop.index }}</td><td class="time-display">{{ pal[1] }}</td><td><strong class="text-primary">{{ pal[0]|int }} kg</strong></td><td class="text-success">{{ pal[3]|int }} kg</td><td class="text-muted">{{ pal[2]|int }} kg</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% else %}<tr><td colspan="8" class="text-center p-20">Brak planu.</td></tr>{% endfor %}
        </tbody>
    </table>
</div>

    <script>
    // Translation messages for Planista view
    var pnMsgs = {
        zapisz: '{{ _("zapisz") }}',
        anuluj: '{{ _("anuluj") }}'
    };
    
    function toggleDetails(id) { var row = document.getElementById('details-' + id); row.classList.toggle('hidden'); }
    function openMoveModal(id, nazwa) {
        // show small modal inline for selecting date
        var modal = document.getElementById('moveModal');
        if(!modal) return alert('Brak modala');
        modal.style.display = 'block';
        modal.dataset.planId = id;
        modal.querySelector('.move-title').innerText = nazwa;
    }
    
    function otworzOknoDodawaniaPalety(planId, produkt, typ){
        // Wczytuje stronƒô formularza przez AJAX i wstrzykuje do quick-popup modala
        var url = '/api/dodaj_palete_page/' + encodeURIComponent(planId);
        fetch(url, { credentials: 'same-origin' })
            .then(function(resp){ if(!resp.ok) throw new Error('Nie mo≈ºna za≈Çadowaƒá formularza'); return resp.text(); })
            .then(function(html){
                var body = document.getElementById('quickPopupBody');
                if(!body) return alert('Brak quick-popup panelu');
                openQuickPopup(html);
                // NOTE: data-slide-close handling removed with slide-over component

                // interceptuj formularz i wy≈õlij AJAXem
                var form = body.querySelector('form');
                if(form){
                    form.addEventListener('submit', function(e){
                        e.preventDefault();
                        var action = form.getAttribute('action') || ('/api/dodaj_palete/' + encodeURIComponent(planId));
                        var method = (form.getAttribute('method') || 'POST').toUpperCase();
                        var fd = new FormData(form);
                        fetch(action, { method: method, body: fd, credentials: 'same-origin' })
                            .then(function(r){
                                if(r.ok){
                                    closeQuickPopup();
                                    // od≈õwie≈º stronƒô aby zaktualizowaƒá listy i bufor
                                    location.reload();
                                } else {
                                    return r.text().then(function(t){ throw new Error(t || 'B≈ÇƒÖd serwera'); });
                                }
                            }).catch(function(err){ alert('B≈ÇƒÖd: ' + (err.message || err)); });
                    });
                }
            }).catch(function(){ alert('B≈ÇƒÖd ≈Çadowania formularza'); closeQuickPopup(); });
    }
    /* showModalDisabled removed ‚Äî slide-over used as fallback instead */
</script>

<!-- Fallback modal-open listener removed -->

<!-- Move modal (inline) -->
<div id="moveModal" class="move-modal">
    <h3 class="move-title">{{ _('przenies_zlecenie') }}</h3>
    <div class="move-modal-input"><label for="move_to_date">Nowa data:</label> <input type="date" id="move_to_date" value="{{ wybrana_data }}" placeholder="Wybierz datƒô" aria-label="Nowa data"></div>
    <div class="d-flex gap-5 move-modal-actions">
        <button type="button" onclick="confirmMove()" class="btn-action btn-small">{{ _('przenies') }}</button>
        <button type="button" class="btn-action btn-small btn-cancel" data-action="close-move-modal">{{ _('anuluj') }}</button>
    </div>
</div>

<script>
function confirmMove(){
    console.log('üìÖ [1] confirmMove() CALLED');
    var modal = document.getElementById('moveModal');
    console.log('üìÖ [2] modal:', modal);
    if(!modal) return alert('Brak modala');
    
    var id = modal.dataset.planId;
    var to_date = document.getElementById('move_to_date').value;
    console.log('üìÖ [3] id:', id, 'to_date:', to_date);
    
    if(!id || !to_date) {
        console.log('üìÖ [4] Brakuje danych!');
        return alert('Brakuje danych');
    }
    
    console.log('üìÖ [5] Wysy≈Çam fetch do /api/przenies_zlecenie_ajax');
    var payload = {id:id, to_date: to_date};
    console.log('üìÖ [6] Payload:', JSON.stringify(payload));
    
    fetch('/api/przenies_zlecenie_ajax', {
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify(payload)
    })
    .then(function(r){
        console.log('üìÖ [7] Response status:', r.status);
        return r.json();
    })
    .then(function(j){
        console.log('üìÖ [8] Response data:', j);
        if(j && j.success){
            console.log('üìÖ [9] SUCCESS - reloading page');
            modal.style.display='none';
            location.reload();
        } else {
            console.log('üìÖ [10] FAILED:', j && j.message);
            alert((j && j.message) || 'B≈ÇƒÖd');
        }
    })
    .catch(function(err){
        console.log('üìÖ [11] CATCH ERROR:', err);
        alert('B≈ÇƒÖd sieci: ' + (err.message || err));
    });
}
</script>
<script>
function moveUp(id){
    fetch('/api/przesun_zlecenie_ajax', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:id, kierunek:'gora', data: '{{ wybrana_data }}'})})
        .then(function(r){ if(!r.ok) return r.text().then(function(t){ throw new Error(t || 'B≈ÇƒÖd serwera'); }); return r.json().catch(function(){ throw new Error('Nieprawid≈Çowa odpowied≈∫ JSON'); }); })
        .then(function(j){ 
            if(j && j.success) {
                // Swap rows in table without reload
                var row = document.querySelector('tr[data-plan-id="' + id + '"]');
                if(row && row.previousElementSibling && row.previousElementSibling.tagName === 'TR') {
                    row.parentNode.insertBefore(row, row.previousElementSibling);
                }
            } else { 
                alert((j && j.message)||'B≈ÇƒÖd'); 
            } 
        })
        .catch(function(err){ alert(err && err.message ? err.message : 'B≈ÇƒÖd sieci'); });
}
function moveDown(id){
    fetch('/api/przesun_zlecenie_ajax', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:id, kierunek:'dol', data: '{{ wybrana_data }}'})})
        .then(function(r){ if(!r.ok) return r.text().then(function(t){ throw new Error(t || 'B≈ÇƒÖd serwera'); }); return r.json().catch(function(){ throw new Error('Nieprawid≈Çowa odpowied≈∫ JSON'); }); })
        .then(function(j){ 
            if(j && j.success) {
                // Swap rows in table without reload
                var row = document.querySelector('tr[data-plan-id="' + id + '"]');
                if(row && row.nextElementSibling && row.nextElementSibling.tagName === 'TR') {
                    row.parentNode.insertBefore(row.nextElementSibling, row);
                }
            } else { 
                alert((j && j.message)||'B≈ÇƒÖd'); 
            } 
        })
        .catch(function(err){ alert(err && err.message ? err.message : 'B≈ÇƒÖd sieci'); });
}
function deletePlanConfirm(id, data){ if(!confirm('UsunƒÖƒá?')) return; deletePlan(id, data); }
function deletePlan(id, data){
    fetch('/api/usun_plan_ajax/'+id, {method:'POST'})
        .then(function(r){ 
            if(r.ok) { 
                // Remove row from table without reload
                var row = document.querySelector('tr[data-plan-id="' + id + '"]');
                if(row) row.remove();
                // Also remove details row if exists
                var detailsRow = document.getElementById('details-' + id);
                if(detailsRow) detailsRow.remove();
                return null; 
            } 
            return r.text().then(function(t){ throw new Error(t || 'B≈ÇƒÖd serwera'); }); 
        })
        .then(function(j){ if(j && !j.success){ alert(j.message || 'B≈ÇƒÖd'); } })
        .catch(function(){ alert('B≈ÇƒÖd sieci'); });
}
</script>
<script>
    function toggleEdit(id){
        var tr = document.querySelector('tr[data-plan-id="'+id+'"]');
        if(!tr) return;
        var editRow = document.getElementById('edit-row-'+id);
        if(editRow){
            // toggle visibility
            editRow.style.display = (editRow.style.display === 'none') ? 'table-row' : 'none';
            return;
        }
        // create edit row after current row
        var newTr = document.createElement('tr');
        newTr.id = 'edit-row-' + id;
        newTr.className = 'edit-row';
        var cols = [];
        cols.push('<td colspan="2">');
        cols.push('Produkt: <input id="e_prod_'+id+'" name="produkt" value="'+(tr.children[0].innerText.trim())+'" required> ');
        cols.push('Typ: <input id="e_sekc_'+id+'" name="sekcja" value="'+(tr.querySelector('.badge-sekcja')?tr.querySelector('.badge-sekcja').innerText:'')+'"> ');
        cols.push('</td>');
        cols.push('<td>Plan (kg): <input id="e_ton_'+id+'" name="tonaz" type="number" step="0.1" value="'+(tr.children[2].innerText.replace(/[^0-9\.\,]/g,'')||0)+'"></td>');
        cols.push('<td colspan="2">');
        cols.push('Data: <input id="e_date_'+id+'" name="data_planu" type="date" value="{{ wybrana_data }}">');
        cols.push('</td>');
        cols.push('<td colspan="3">');
        cols.push('<button type="button" class="btn-action btn-small" id="btn-submit-'+id+'">'+pnMsgs.zapisz+'</button> ');
        cols.push('<button type="button" class="btn-action btn-small btn-cancel" id="btn-cancel-'+id+'">'+pnMsgs.anuluj+'</button>');
        cols.push('</td>');
        newTr.innerHTML = cols.join('');
        newTr.style.display = 'table-row';  // Jawne ustawienie display
        tr.parentNode.insertBefore(newTr, tr.nextSibling);
        // Add event listeners to avoid inline onclick issues
        var submitBtn = newTr.querySelector('#btn-submit-'+id);
        if(submitBtn){
            submitBtn.addEventListener('click', function(){
                submitEdit(id);
            });
        }
        var cancelBtn = newTr.querySelector('#btn-cancel-'+id);
        if(cancelBtn){
            cancelBtn.addEventListener('click', function(){
                document.getElementById('edit-row-'+id).style.display='none';
            });
        }
    }

    function submitEdit(id){
        var prod = document.getElementById('e_prod_'+id).value;
        var sek = document.getElementById('e_sekc_'+id).value;
        var ton = document.getElementById('e_ton_'+id).value;
        var dt = document.getElementById('e_date_'+id).value;
        fetch('/api/edytuj_plan_ajax', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({id: id, produkt: prod, sekcja: sek, tonaz: ton, data_planu: dt})
        }).then(r=>r.json()).then(j=>{
            if(j && j.success){
                // update row DOM
                var tr = document.querySelector('tr[data-plan-id="'+id+'"]');
                if(tr){ tr.children[0].innerText = prod; tr.querySelector('.badge-sekcja').innerText = (sek||'').toUpperCase(); tr.children[2].innerText = (parseFloat(ton)||0)+' kg'; }
                var er = document.getElementById('edit-row-'+id); if(er) er.style.display='none';
            } else {
                alert((j && j.message) || 'B≈ÇƒÖd');
            }
        }).catch(()=>alert('B≈ÇƒÖd sieci'));
    }

    function openQuickPopup(html){
        var qp = document.getElementById('quickPopup');
        var bd = document.getElementById('quickBackdrop');
        if(!qp || !bd) return;
        var body = document.getElementById('quickPopupBody');
        if(body) body.innerHTML = html || '';
        bd.classList.add('show');
        qp.style.display = 'block';
        setTimeout(function(){ qp.classList.add('open'); qp.setAttribute('aria-hidden', 'false'); }, 10);
    }
    function closeQuickPopup(){
        var qp = document.getElementById('quickPopup');
        var bd = document.getElementById('quickBackdrop');
        if(!qp) return;
        qp.classList.remove('open');
        qp.setAttribute('aria-hidden', 'true');
        if(bd) bd.classList.remove('show');
        setTimeout(function(){ qp.style.display = 'none'; var body = document.getElementById('quickPopupBody'); if(body) body.innerHTML=''; }, 360);
    }

    // Handle uszkodzone_worki input changes (auto-save via AJAX)
    document.addEventListener('change', function(e){
        if(e.target.classList.contains('uszkodzone-worki-input')){
            var planId = parseInt(e.target.getAttribute('data-plan-id'));
            var value = parseInt(e.target.value) || 0;
            
            fetch('/api/update_uszkodzone_worki', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: planId, uszkodzone_worki: value})
            })
            .then(function(r){ return r.json(); })
            .then(function(j){
                if(j && j.success){
                    e.target.style.borderColor = '#4CAF50';
                    setTimeout(function(){ e.target.style.borderColor = ''; }, 1000);
                } else {
                    alert((j && j.message) || 'B≈ÇƒÖd aktualizacji');
                    e.target.value = e.target.getAttribute('data-original-value') || 0;
                }
            })
            .catch(function(err){ 
                alert('B≈ÇƒÖd sieci');
                console.error(err);
            });
        }
    }, false);

    // Event delegation for planista actions
    document.addEventListener('click', function(e){
        var target = e.target.closest('[data-action]');
        if(!target) return;
        
        var action = target.getAttribute('data-action');
        var planId = target.getAttribute('data-plan-id');
        
        switch(action){
            case 'close-popup':
                closeQuickPopup();
                break;
            case 'close-move-modal':
                var moveModal = document.getElementById('moveModal');
                if(moveModal) moveModal.style.display = 'none';
                break;
            case 'toggle-details':
                if(planId) toggleDetails(parseInt(planId));
                break;
            case 'move-up':
                if(planId) moveUp(parseInt(planId));
                break;
            case 'move-down':
                if(planId) moveDown(parseInt(planId));
                break;
            case 'delete-plan':
                if(planId){
                    var planDate = target.getAttribute('data-plan-date');
                    deletePlanConfirm(parseInt(planId), planDate);
                }
                break;
            case 'open-move-modal':
                if(planId){
                    var planDay = target.getAttribute('data-plan-day');
                    openMoveModal(parseInt(planId), planDay);
                }
                break;
            case 'toggle-edit':
                if(planId) toggleEdit(parseInt(planId));
                break;
        }
    }, false);

// Initialize Sortable for plan reordering via drag-and-drop
if (typeof Sortable !== 'undefined') {
    var plansTbody = document.getElementById('plans-tbody');
    if (plansTbody) {
        // Check if ANY plan on this day is w toku or zakonczone
        var hasActiveOrComplete = false;
        var allRows = plansTbody.querySelectorAll('tr:not(.details-row)');
        allRows.forEach(function(row) {
            if (row.querySelector('[title*="zablokowane"]')) {
                hasActiveOrComplete = true;
            }
        });
        
        // Only enable drag if NO plans are w toku/zakonczone
        if (hasActiveOrComplete) {
            // Show message that reordering is disabled
            var msg = document.createElement('div');
            msg.className = 'alert alert-warning mt-2 mb-2';
            msg.innerHTML = '‚ö†Ô∏è {{ _("Reorderowanie wy≈ÇƒÖczone - na tym dniu jest plan w toku lub zako≈Ñczony") }}';
            plansTbody.parentNode.parentNode.insertAdjacentElement('afterend', msg);
        } else {
            Sortable.create(plansTbody, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: 'tr',  // Allow dragging entire row
                filter: '.details-row', // Don't allow dragging details rows
                onEnd: function(evt) {
                    // Get new order of plan IDs
                    var rows = plansTbody.querySelectorAll('tr:not(.details-row)');
                    var newOrder = [];
                    rows.forEach(function(row) {
                        var planId = row.getAttribute('data-plan-id');
                        if (planId) {
                            newOrder.push(parseInt(planId));
                        }
                    });
                    
                    if (newOrder.length > 0) {
                        // Send reorder request to backend
                        var data = {
                            plan_ids: newOrder,
                            data: '{{ wybrana_data }}',
                            sekcja: 'zasyp'
                        };
                        
                        fetch('/api/reorder_plans_bulk', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(data)
                        })
                        .then(function(r) {
                            if (!r.ok) return r.text().then(function(t) { throw new Error(t || 'B≈ÇƒÖd serwera'); });
                            return r.json().catch(function() { throw new Error('Nieprawid≈Çowa odpowied≈∫ JSON'); });
                        })
                        .then(function(j) {
                            if (j && j.success) {
                                // Silently update UI without reload
                                console.log('Reorder success - no reload needed');
                            } else {
                                alert((j && j.message) || 'B≈ÇƒÖd przy reorderowaniu');
                            }
                        })
                        .catch(function(err) {
                            alert('B≈ÇƒÖd: ' + (err && err.message ? err.message : 'Nie wiadomo'));
                        });
                    }
                }
            });
        }
    }
}

</script>

<!-- Quick-popup: center modal for AJAX-loaded content -->
<div id="quickBackdrop" class="quick-backdrop" data-action="close-popup"></div>
<div id="quickPopup" class="quick-popup" aria-hidden="true">
    <div class="qp-header d-flex justify-between align-center p-10">
        <div class="header-title">{{ _('panel') }}</div>
        <div><button type="button" class="btn-action btn-small" data-action="close-popup">‚úñ</button></div>
    </div>
    <div id="quickPopupBody" class="qp-body p-10">{{ _('ladowanie') }}</div>
</div>

<style>
/* Drag and drop styles for Sortable.js */
.sortable-tbody tr.sortable-ghost {
    opacity: 0.4;
    background: #f5f5f5;
}

.sortable-tbody tr.sortable-drag {
    opacity: 0;
}

.sortable-tbody tr {
    cursor: move;
}

.sortable-tbody tr:hover {
    background: #f9f9f9;
    transition: background 0.2s;
}
</style>

{% endblock %}
