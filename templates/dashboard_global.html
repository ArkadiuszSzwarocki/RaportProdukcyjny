{% extends 'layout.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_global.css') }}">

<div class="dashboard-header">
  <h1 class="dashboard-title">Dashboard</h1>
</div>

{# Full day production overview: Zasyp & Workowanie #}
<section class="section-box p-15 p-15-bg">
  <h3 class="m-0">ğŸ“¦ PodglÄ…d produkcji dziennej (Zasyp / Workowanie)</h3>
  <div style="display:flex; gap:16px; margin-top:12px; flex-wrap:wrap;">
    <div style="flex:1 1 420px;">
      <h4 class="m-0">Zasyp â€” {{ dzisiaj }} <small class="text-muted">({{ plans_zasyp|length }} planÃ³w)</small></h4>
      {% if plans_zasyp %}
      <table class="modern-table small" style="margin-top:8px;">
        <thead><tr><th>Produkt</th><th>Plan</th><th>Wykonanie</th><th>Godz.</th><th>Status</th></tr></thead>
        <tbody>
        {% for p in plans_zasyp %}
          <tr>
            <td><strong class="text-primary">{{ p[1] }}</strong></td>
            <td>{{ p[2]|int }} kg</td>
            <td>{{ p[7]|int }} kg</td>
            <td>{% if p[4] %}{{ p[4] }}{% else %}-{% endif %} â€” {% if p[5] %}{{ p[5] }}{% else %}-{% endif %}</td>
            <td>{{ p[3]|upper }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="text-muted p-10">Brak planÃ³w Zasyp na ten dzieÅ„.</div>
      {% endif %}
    </div>

    <div style="flex:1 1 420px;">
      <h4 class="m-0">Workowanie â€” {{ dzisiaj }} <small class="text-muted">({{ plans_workowanie|length }} planÃ³w)</small></h4>
      {% if plans_workowanie %}
      <table class="modern-table small" style="margin-top:8px;">
        <thead><tr><th>Produkt</th><th>Plan</th><th>Wykonanie</th><th>Godz.</th><th>Status</th></tr></thead>
        <tbody>
        {% for p in plans_workowanie %}
          <tr>
            <td><strong class="text-primary">{{ p[1] }}</strong></td>
            <td>{{ p[2]|int }} kg</td>
            <td>{{ p[7]|int }} kg</td>
            <td>{% if p[4] %}{{ p[4] }}{% else %}-{% endif %} â€” {% if p[5] %}{{ p[5] }}{% else %}-{% endif %}</td>
            <td>{{ p[3]|upper }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="text-muted p-10">Brak planÃ³w Workowanie na ten dzieÅ„.</div>
      {% endif %}
    </div>
  </div>
</section>

{# Sekcje WnioskÃ³w, NieobecnoÅ›ci i Planowanych UrlopÃ³w usuniÄ™te - przeniesione do dedykowanych paneli #}



<section>
  <h2>ğŸ“ Notatki Zmiany</h2>
  <form action="/add_shift_note" method="post" id="noteForm" class="note-form">
    <label class="note-label" for="noteTextarea">Notatka:</label>
    <textarea id="noteTextarea" name="note" required class="note-textarea" placeholder="Wpisz notatkÄ™..." title="Notatka do zapisu" aria-label="Notatka"></textarea>
    <input type="hidden" name="date" value="{{ dzisiaj }}">
    <input type="hidden" name="pracownik_id" value="{{ session.get('pracownik_id') or '' }}">
    <button type="submit" class="note-save-btn">Zapisz notatkÄ™</button>
  </form>

  <div class="notes-container">
    <h3>ğŸ“Œ Zapisane Notatki</h3>
    {% if shift_notes %}
      {% for n in shift_notes %}
      <div class="note-card">
        <div class="note-card-inner">
          <div class="note-card-content">
            <div class="note-meta">
              <strong>ğŸ“… {{ n.date }}</strong> â€¢ <em>{{ n.author }}</em>
            </div>
            <div class="note-text">{{ n.note }}</div>
          </div>
          {% if session.get('rola') in ['lider', 'admin'] and session.get('imie_nazwisko') == n.author or session.get('login') == n.author %}
          <div class="note-actions">
            <button class="note-edit-btn" data-id="{{ n.id }}">âœï¸ Edytuj</button>
            <button class="note-delete-btn" data-id="{{ n.id }}">ğŸ—‘ï¸ UsuÅ„</button>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    {% else %}
      <p class="no-notes">Brak notatek. Dodaj nowÄ… notatkÄ™ powyÅ¼ej.</p>
    {% endif %}
  </div>
</section>

<!-- Przycisk ZakoÅ„cz zmianÄ™ na dole - POWIÄ˜KSZONY 4x -->
{% if session.get('rola') in ['lider', 'admin'] %}
<div class="end-shift-wrapper">
  <form method="POST" action="{{ url_for('api.zamknij_zmiane_global') }}" class="end-shift-form" id="endShiftForm">
    {# Obsada and leader selectors removed from dashboard â€” use dedicated Obsada panel #}
    <div class="mt-10">
      <button type="submit" class="btn-action btn-success btn-end-shift btn-end-shift-large">
        ğŸ ZakoÅ„cz zmianÄ™ i pobierz raporty
      </button>
      <button type="button" class="btn-action btn-info btn-send-email btn-end-shift-large" id="btnSendEmailReport">
        ğŸ“§ WyÅ›lij raport mailem
      </button>
    </div>
  </form>
</div>
{% endif %}

<script>
// ========== AUTO-WZNOWIENIE ZLECEÅƒ Z POPRZEDNIEGO DNIA ==========
// WywoÅ‚ywane automatycznie przy zaÅ‚adowaniu strony
document.addEventListener('DOMContentLoaded', function() {
  // Pobierz datÄ™ ostatniego wznowienia z sessionStorage
  const lastResumeDate = sessionStorage.getItem('lastResumeDate');
  const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
  
  // WznÃ³w zlecenia tylko raz dziennie (jeÅ›li jest to nowy dzieÅ„)
  if (lastResumeDate !== today) {
    console.log('[AUTO-RESUME] â„¹ï¸ Wznawiam zlecenia z poprzedniego dnia...');
    
    fetch('/api/wznow_zlecenia_z_wczoraj', {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (!response.ok) {
        console.error(`[AUTO-RESUME] âœ— HTTP Error: ${response.status}`);
        return null;
      }
      return response.json();
    })
    .then(data => {
      if (data && data.success) {
        console.log(`[AUTO-RESUME] âœ… Wznowiono ${data.resumed_count} zleceÅ„ z ${data.date_resumed}`);
        // Zapisz dzisiejszÄ… datÄ™ jako ostatni dzieÅ„ wznowienia
        sessionStorage.setItem('lastResumeDate', today);
        
        // Opcjonalnie: pokaÅ¼ wiadomoÅ›Ä‡ uÅ¼ytkownikowi jeÅ›li wznowiono jakieÅ› zlecenia
        if (data.resumed_count > 0) {
          console.log(`[AUTO-RESUME] ğŸ“‹ Automatycznie wznowiono ${data.resumed_count} zleceÅ„`);
        }
      } else if (data && data.error) {
        console.error(`[AUTO-RESUME] âœ— BÅ‚Ä…d serwera: ${data.message || data.error}`);
      }
    })
    .catch(error => {
      console.error('[AUTO-RESUME] âœ— BÅ‚Ä…d sieci:', error);
    });
  }
});
</script>

<script>
document.addEventListener('click', function(e){
  if(e.target.classList.contains('wn-approve') || e.target.classList.contains('wn-reject')){
    const id = e.target.getAttribute('data-id');
    const action = e.target.classList.contains('wn-approve') ? 'approve' : 'reject';
    fetch(`/api/wnioski/${id}/${action}`, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}})
      .then(r=>r.json()).then(j=>{
        if(j && j.success){
          const tr = document.querySelector(`tr[data-id="${id}"]`);
          if(tr) tr.remove();
        } else {
          alert((j && j.message) || 'BÅ‚Ä…d');
        }
      }).catch(()=>alert('BÅ‚Ä…d sieci'));
  }
});
</script>

<script>
// Note form submission - no auto-refresh, let flash message show
const noteForm = document.getElementById('noteForm');
if(noteForm){
  noteForm.addEventListener('submit', function(e) {
    // Just submit normally, page will refresh after redirect
  });
}

// ObsÅ‚uga edycji i usuwania notatek
document.addEventListener('click', function(e){
  if(e.target.classList.contains('note-delete-btn')){
    const id = e.target.getAttribute('data-id');
    if(confirm('Czy na pewno chcesz usunÄ…Ä‡ tÄ™ notatkÄ™?')){
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/api/shift_note/${id}/delete`;
      document.body.appendChild(form);
      form.submit();
    }
  }
  if(e.target.classList.contains('note-edit-btn')){
    const id = e.target.getAttribute('data-id');
    const noteDiv = e.target.closest('div[style*="background: #f9f9f9"]');
    const noteText = noteDiv.querySelector('div:last-of-type').innerText;
    const newText = prompt('Edytuj notatkÄ™:', noteText);
    if(newText !== null && newText.trim() !== ''){
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/api/shift_note/${id}/update`;
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'note';
      input.value = newText;
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }
  }
});
</script>

<script>
// Show/hide time inputs for Wyjscie prywatne in global dashboard absence form
document.addEventListener('DOMContentLoaded', function(){
  var sel = document.getElementById('abs_typ_select');
  var fromLabel = document.getElementById('abs_wyjscie_label_from');
  var toLabel = document.getElementById('abs_wyjscie_label_to');
  var koment = document.querySelector('input[name="komentarz"]');
  function update(){
    if(!sel) return;
    if(sel.value === 'Wyjscie prywatne'){
      fromLabel.classList.remove('hidden');
      toLabel.classList.remove('hidden');
      document.getElementById('abs_wyjscie_from').required = true;
      document.getElementById('abs_wyjscie_to').required = true;
      if(koment) { koment.required = false; }
    } else {
      fromLabel.classList.add('hidden');
      toLabel.classList.add('hidden');
      try{ document.getElementById('abs_wyjscie_from').required = false; document.getElementById('abs_wyjscie_to').required = false; }catch(e){}
      if(sel.value === 'Nadgodziny'){
        if(koment) { koment.required = true; }
      } else {
        if(koment) { koment.required = false; }
      }
    }
  }
  if(sel){ sel.addEventListener('change', update); update(); }
});
</script>

<script>
// Obsada table removed from dashboard â€” handled by panel Obsada
</script>

<script>
// ========== WYSÅIJ RAPORT MAILEM ==========
// Funkcja otwierajÄ…ca klienta poczty z mailto linkiem
document.getElementById('btnSendEmailReport').addEventListener('click', function(e) {
  e.preventDefault();
  this.disabled = true;
  const originalText = this.textContent;
  this.textContent = 'â³ Przetwarzam...';
  
  try {
    // 1. Najpierw zakoÅ„cz zmianÄ™ (submit formularza)
    const endShiftForm = document.getElementById('endShiftForm');
    
    fetch(endShiftForm.action, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('BÅ‚Ä…d przy zatwierdzaniu zmiany');
      // Endpoint zwraca ZIP file, nie JSON
      console.log('[EMAIL-SEND] âœ… Zmiana zakoÅ„czona');
      return true;
    })
    .then(result => {
      
      // 2. Czekaj aÅ¼ raporty siÄ™ wygenerujÄ…
      setTimeout(() => {
        // 3. Pobierz konfiguracjÄ… odbiorcÃ³w i otwÃ³rz maila
        fetch('/api/email-config')
          .then(response => {
            if (!response.ok) throw new Error('Nie udaÅ‚o siÄ™ pobraÄ‡ konfiguracji');
            return response.json();
          })
          .then(config => {
            const recipients = config.recipients || [];
            
            if (!config.configured || recipients.length === 0) {
              alert('âš ï¸ Brakuje skonfigurowanych odbiorcÃ³w raportÃ³w.\nProszÄ™ skontaktowaÄ‡ siÄ™ z administratorem.');
              this.textContent = originalText;
              this.disabled = false;
              return;
            }
            
            // Dane raportu
            const today = new Date();
            const dateStr = today.toLocaleDateString('pl-PL');
            const dateIso = today.toISOString().split('T')[0];
            const userName = document.querySelector('span[data-user-name]')?.textContent || 'System';
            
            // UNC paths do plikÃ³w
            const uncPath = '\\\\192.168.0.18\\raporty';
            const files = [
              `${uncPath}\\Raport_${dateIso}.xlsx`,
              `${uncPath}\\Do_Maila_${dateIso}.txt`,
              `${uncPath}\\Raport_${dateIso}.pdf`
            ];
            
            // Konstruuj wiadomoÅ›Ä‡ z linkami UNC
            const subject = `Raport produkcyjny z dnia ${dateStr}`;
            let body = `DzieÅ„ dobry,\n\nPrzesyÅ‚am raport produkcyjny z dnia ${dateStr}.\n\n` +
                       `W raporcie zawarte sÄ…:\n` +
                       `- Dane produkcji\n` +
                       `- Awarie i przestoje\n` +
                       `- Obsada zmianowa\n\n` +
                       `Pliki raportu dostÄ™pne tutaj:\n\n` +
                       `Excel: ${files[0]}\n` +
                       `Tekst: ${files[1]}\n` +
                       `PDF: ${files[2]}\n\n` +
                       `Pozdrawiam,\n${userName}`;
            
            console.log('[EMAIL-SEND] Otwieranie poczty dla:', recipients.length, 'odbiorcÃ³w');
            console.log('[EMAIL-SEND] Recipients:', recipients);
            
            // OtwÃ³rz mailto: z linkami UNC
            const mailtoLink = `mailto:${recipients.join(';')}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            
            alert(`âœ… Zmiana zakoÅ„czona!\nâœ… Raporty pobrane!\nâœ… Poczta otwarta!\n\nRaporty wysÅ‚ane do:\n${recipients.join('\n')}\n\nPliki do pobrania z sieci.`);
            
            setTimeout(() => {
              this.textContent = originalText;
              this.disabled = false;
            }, 1000);
          });
      }, 1500);
    })
    .catch(error => {
      console.error('[EMAIL-SEND] âŒ BÅ‚Ä…d:', error);
      alert(`âŒ BÅ‚Ä…d:\n\n${error.message}`);
      this.textContent = originalText;
      this.disabled = false;
    });
  } catch (error) {
    console.error('[EMAIL-SEND] âŒ BÅ‚Ä…d:', error);
    alert(`âŒ BÅ‚Ä…d wysyÅ‚ania raportu:\n\n${error.message}\n\nSkontaktuj siÄ™ z IT.`);
    this.textContent = originalText;
    this.disabled = false;
  }
});

// ================= ZakoÅ„cz zmianÄ™ (bez maila) =================
const endShiftForm = document.getElementById('endShiftForm');
if (endShiftForm) {
  endShiftForm.addEventListener('submit', function(e) {
    console.log('[SUBMIT] Form submit event fired!');
    console.log('[SUBMIT] Form action:', this.action);
    e.preventDefault();
    console.log('[SUBMIT] preventDefault called');
    
    // PrzeÅ›lij formularz normalnie (POST do /api/zamknij_zmiane_global)
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'â³ Przetwarzam...';
    console.log('[SUBMIT] Sending fetch to:', this.action);
    
    fetch(this.action, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      console.log('[CLOSE-SHIFT] Response status:', response.status);
      console.log('[CLOSE-SHIFT] Response type:', response.type);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: BÅ‚Ä…d przy zatwierdzaniu zmiany`);
      }
      
      // Pobierz plik ZIP z response
      return response.blob();
    })
    .then(blob => {
      console.log('[CLOSE-SHIFT] Blob received, size:', blob.size, 'bytes');
      
      // Pobierz plik
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Raporty_${new Date().toISOString().split('T')[0]}.zip`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      console.log('[CLOSE-SHIFT] OK ZIP downloaded');
      
      alert('âœ… Zmiana zakoÅ„czona!\nâœ… Raporty pobrane!');
      
      // Poczekaj i odÅ›wieÅ¼ stronÄ™
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    })
    .catch(error => {
      console.error('[CLOSE-SHIFT] ERROR:', error);
      alert(`ERROR BÅ‚Ä…d przy zatwierdzaniu zmiany:\n\n${error.message}`);
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    });
  });
}
</script>

{% endblock %}
