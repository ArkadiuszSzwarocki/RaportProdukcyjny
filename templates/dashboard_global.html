{% extends 'layout.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_global.css') }}">

<div class="dashboard-header">
  <h1 class="dashboard-title">Dashboard</h1>
</div>

<section>
  <h2>ğŸ“‹ Zatwierdzenia WnioskÃ³w</h2>
  {% if wnioski_pending and (session.get('rola') in ['lider','admin']) %}
    <table class="modern-table">
      <thead><tr><th>ğŸ‘¤ Pracownik</th><th>ğŸ“ Typ</th><th>ğŸ“… Zakres</th><th>â±ï¸ Czas</th><th>ğŸ“¤ ZÅ‚oÅ¼ono</th><th>âš™ï¸ Akcje</th></tr></thead>
      <tbody id="wnioskiPendingBody">
      {% for w in wnioski_pending %}
        <tr data-id="{{ w.id }}">
          <td>{{ w.pracownik }}</td>
          <td>{{ w.typ }}</td>
          <td>{{ w.data_od }}{% if w.data_do and w.data_do != w.data_od %} - {{ w.data_do }}{% endif %}</td>
          <td>{{ w.czas_od or '' }} - {{ w.czas_do or '' }}</td>
          <td>{{ w.zlozono }}</td>
          <td>
            <button class="wn-approve" data-id="{{ w.id }}">ZatwierdÅº</button>
            <button class="wn-reject" data-id="{{ w.id }}">OdrzuÄ‡</button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Brak oczekujÄ…cych wnioskÃ³w lub brak uprawnieÅ„.</p>
  {% endif %}
</section>

<section>
  <h2>Wpisz nieobecnoÅ›Ä‡</h2>
  <form id="form_absence" action="{{ url_for('api.dodaj_obecnosc') }}" method="post">
    <label>Pracownik: <select name="pracownik_id">
      <option value="">â€” Wybierz pracownika â€”</option>
      {% for p in wszyscy_pracownicy %}
        <option value="{{ p[0] }}">{{ p[1] }}</option>
      {% endfor %}
    </select></label>
    <label>Typ: <select id="abs_typ_select" name="typ">
      <option value="NieobecnoÅ›Ä‡">NieobecnoÅ›Ä‡</option>
      <option value="Urlop">Urlop</option>
      <option value="Wyjscie prywatne">Wyjscie prywatne</option>
    </select></label>
    <label>Godziny: <input type="number" name="godziny" value="0" min="0" step="0.25" required></label>
    <label>Komentarz: <input type="text" name="komentarz"></label>
    <label id="abs_wyjscie_label_from" class="abs-wyjscie-label hidden">WyjÅ›cie od: <input type="time" id="abs_wyjscie_from" name="wyjscie_od"></label>
    <label id="abs_wyjscie_label_to" class="abs-wyjscie-label hidden">WyjÅ›cie do: <input type="time" id="abs_wyjscie_to" name="wyjscie_do"></label>
    <button type="submit">Zapisz nieobecnoÅ›Ä‡</button>
  </form>
</section>

<section>
  <h2>ğŸ–ï¸ Planowane Urlopy (NastÄ™pne 60 Dni)</h2>
  {% if planned_leaves %}
    <table class="modern-table">
      <thead><tr><th>ğŸ‘¤ Pracownik</th><th>ğŸ“ Typ</th><th>ğŸ“… Zakres</th><th>ğŸ“Š Status</th></tr></thead>
      <tbody>
      {% for pl in planned_leaves %}
        <tr>
          <td>{{ pl.pracownik }}</td>
          <td>{{ pl.typ }}</td>
          <td>{{ pl.data_od }}{% if pl.data_do and pl.data_do != pl.data_od %} - {{ pl.data_do }}{% endif %}</td>
          <td>{{ pl.status }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Brak planowanych urlopÃ³w.</p>
  {% endif %}
</section>

<section>
  <h2>âŒ Ostatnie NieobecnoÅ›ci (30 Dni)</h2>
  {% if recent_absences %}
    <table class="modern-table">
      <thead><tr><th>ğŸ“… Data</th><th>ğŸ‘¤ Pracownik</th><th>ğŸ“ Typ</th><th>â° Godziny</th><th>ğŸ’¬ Komentarz</th></tr></thead>
      <tbody>
      {% for a in recent_absences %}
        <tr>
          <td>{{ a.data }}</td>
          <td>{{ a.pracownik }}</td>
          <td>{{ a.typ }}</td>
          <td>{{ a.godziny }}</td>
          <td>{{ a.komentarz }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Brak ostatnich nieobecnoÅ›ci.</p>
  {% endif %}
</section>

<section>
  <h2>ğŸ“ Notatki Zmiany</h2>
  <form action="/add_shift_note" method="post" id="noteForm" class="note-form">
    <label class="note-label" for="noteTextarea">Notatka:</label>
    <textarea id="noteTextarea" name="note" required class="note-textarea" placeholder="Wpisz notatkÄ™..." title="Notatka do zapisu" aria-label="Notatka"></textarea>
    <input type="hidden" name="date" value="{{ dzisiaj }}">
    <input type="hidden" name="pracownik_id" value="{{ session.get('pracownik_id') or '' }}">
    <button type="submit" class="note-save-btn">Zapisz notatkÄ™</button>
  </form>

  <div class="notes-container">
    <h3>ğŸ“Œ Zapisane Notatki</h3>
    {% if shift_notes %}
      {% for n in shift_notes %}
      <div class="note-card">
        <div class="note-card-inner">
          <div class="note-card-content">
            <div class="note-meta">
              <strong>ğŸ“… {{ n.date }}</strong> â€¢ <em>{{ n.author }}</em>
            </div>
            <div class="note-text">{{ n.note }}</div>
          </div>
          {% if session.get('rola') in ['lider', 'admin'] and session.get('imie_nazwisko') == n.author or session.get('login') == n.author %}
          <div class="note-actions">
            <button class="note-edit-btn" data-id="{{ n.id }}">âœï¸ Edytuj</button>
            <button class="note-delete-btn" data-id="{{ n.id }}">ğŸ—‘ï¸ UsuÅ„</button>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    {% else %}
      <p class="no-notes">Brak notatek. Dodaj nowÄ… notatkÄ™ powyÅ¼ej.</p>
    {% endif %}
  </div>
</section>

<!-- Przycisk ZakoÅ„cz zmianÄ™ na dole - POWIÄ˜KSZONY 4x -->
{% if session.get('rola') in ['lider', 'admin'] %}
<div class="end-shift-wrapper">
  <form method="POST" action="{{ url_for('api.zamknij_zmiane_global') }}" class="end-shift-form">
    <div class="obsada-panel">
      <label for="obsadaDate">Obsada na dzieÅ„:</label>
      <input type="date" id="obsadaDate" name="data" value="{{ dzisiaj }}">
      <button type="button" id="refreshObsada" class="btn-action btn-small">OdÅ›wieÅ¼</button>
    </div>
    <div class="obsada-table-wrapper mt-10">
      <table class="modern-table" id="obsadaTable">
        <thead><tr><th>Sekcja</th><th>Pracownik</th></tr></thead>
        <tbody>
          <tr><td colspan="2" class="text-muted">Brak danych. Wybierz datÄ™ i kliknij 'OdÅ›wieÅ¼'.</td></tr>
        </tbody>
      </table>
    </div>
    <div class="mt-10">
      <button type="submit" class="btn-action btn-success btn-end-shift btn-end-shift-large">
        ğŸ ZakoÅ„cz zmianÄ™ i pobierz raporty
      </button>
    </div>
  </form>
</div>
{% endif %}

<script>
document.addEventListener('click', function(e){
  if(e.target.classList.contains('wn-approve') || e.target.classList.contains('wn-reject')){
    const id = e.target.getAttribute('data-id');
    const action = e.target.classList.contains('wn-approve') ? 'approve' : 'reject';
    fetch(`/api/wnioski/${id}/${action}`, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}})
      .then(r=>r.json()).then(j=>{
        if(j && j.success){
          const tr = document.querySelector(`tr[data-id="${id}"]`);
          if(tr) tr.remove();
        } else {
          alert((j && j.message) || 'BÅ‚Ä…d');
        }
      }).catch(()=>alert('BÅ‚Ä…d sieci'));
  }
});
</script>

<script>
// Note form submission - no auto-refresh, let flash message show
const noteForm = document.getElementById('noteForm');
if(noteForm){
  noteForm.addEventListener('submit', function(e) {
    // Just submit normally, page will refresh after redirect
  });
}

// ObsÅ‚uga edycji i usuwania notatek
document.addEventListener('click', function(e){
  if(e.target.classList.contains('note-delete-btn')){
    const id = e.target.getAttribute('data-id');
    if(confirm('Czy na pewno chcesz usunÄ…Ä‡ tÄ™ notatkÄ™?')){
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/api/shift_note/${id}/delete`;
      document.body.appendChild(form);
      form.submit();
    }
  }
  if(e.target.classList.contains('note-edit-btn')){
    const id = e.target.getAttribute('data-id');
    const noteDiv = e.target.closest('div[style*="background: #f9f9f9"]');
    const noteText = noteDiv.querySelector('div:last-of-type').innerText;
    const newText = prompt('Edytuj notatkÄ™:', noteText);
    if(newText !== null && newText.trim() !== ''){
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/api/shift_note/${id}/update`;
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'note';
      input.value = newText;
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }
  }
});
</script>

<script>
// Show/hide time inputs for Wyjscie prywatne in global dashboard absence form
document.addEventListener('DOMContentLoaded', function(){
  var sel = document.getElementById('abs_typ_select');
  var fromLabel = document.getElementById('abs_wyjscie_label_from');
  var toLabel = document.getElementById('abs_wyjscie_label_to');
  function update(){
    if(!sel) return;
    if(sel.value === 'Wyjscie prywatne'){
      fromLabel.classList.remove('hidden');
      toLabel.classList.remove('hidden');
      document.getElementById('abs_wyjscie_from').required = true;
      document.getElementById('abs_wyjscie_to').required = true;
    } else {
      fromLabel.classList.add('hidden');
      toLabel.classList.add('hidden');
      try{ document.getElementById('abs_wyjscie_from').required = false; document.getElementById('abs_wyjscie_to').required = false; }catch(e){}
    }
  }
  if(sel){ sel.addEventListener('change', update); update(); }
});
</script>

<script>
// Load obsada (shift assignments) for selected date and render table
document.addEventListener('DOMContentLoaded', function(){
  const obsadaDate = document.getElementById('obsadaDate');
  const obsadaTable = document.getElementById('obsadaTable');
  const refreshBtn = document.getElementById('refreshObsada');

  function isoToday(){
    const d = new Date();
    return d.toISOString().slice(0,10);
  }

  function renderRows(rows){
    const tbody = obsadaTable.querySelector('tbody');
    tbody.innerHTML = '';
    if(!rows || rows.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="2" class="text-muted">Brak przypisanych pracownikÃ³w.</td>';
      tbody.appendChild(tr);
      return;
    }
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.sekcja}</td><td>${r.imie_nazwisko}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function loadObsada(dateStr){
    if(!dateStr) dateStr = isoToday();
    try{
      const res = await fetch(`/api/obsada-for-date?date=${encodeURIComponent(dateStr)}`, {credentials: 'same-origin'});
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const j = await res.json();
      renderRows(j.rows || []);
    }catch(e){
      console.error('loadObsada failed', e);
      renderRows([]);
    }
  }

  if(obsadaDate){
    if(!obsadaDate.value) obsadaDate.value = '{{ dzisiaj }}' || isoToday();
    loadObsada(obsadaDate.value);
    obsadaDate.addEventListener('change', function(){ loadObsada(this.value); });
  }
  if(refreshBtn){ refreshBtn.addEventListener('click', function(){ if(obsadaDate) loadObsada(obsadaDate.value); }); }
});
</script>

{% endblock %}
