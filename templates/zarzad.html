{% extends "layout.html" %}

{% block content %}

<div class="section-header">
    <div><h2 class="header-title">üìä Wyniki Produkcyjne: <strong>{{ tytul }}</strong></h2></div>
    <div class="filters">
        <a href="/zarzad?tryb=dzien&data={{ wybrana_data }}" class="btn {% if tryb=='dzien' %}btn-primary{% endif %}">Dzie≈Ñ</a>
        <a href="/zarzad?tryb=miesiac&rok={{ wybrany_rok }}&miesiac={{ wybrany_miesiac }}" class="btn {% if tryb=='miesiac' %}btn-primary{% endif %}">MiesiƒÖc</a>
        <a href="/zarzad?tryb=rok&rok={{ wybrany_rok }}" class="btn {% if tryb=='rok' %}btn-primary{% endif %}">Rok</a>
        <form action="/zarzad" method="GET" class="filters-form">
            <input type="hidden" name="tryb" value="{{ tryb }}">
            {% if tryb == 'dzien' %}
                <input type="date" name="data" value="{{ wybrana_data }}" onchange="this.form.submit()" class="filters-input">
            {% elif tryb == 'miesiac' %}
                <select name="miesiac" onchange="this.form.submit()" class="filters-input">{% for m in range(1,13) %}<option value="{{ m }}" {% if m==wybrany_miesiac %}selected{% endif %}>{{ m }}</option>{% endfor %}</select>
                <select name="rok" onchange="this.form.submit()" class="filters-input">{% for r in range(2024, 2030) %}<option value="{{ r }}" {% if r==wybrany_rok %}selected{% endif %}>{{ r }}</option>{% endfor %}</select>
            {% elif tryb == 'rok' %}
                <select name="rok" onchange="this.form.submit()" class="filters-input">{% for r in range(2024, 2030) %}<option value="{{ r }}" {% if r==wybrany_rok %}selected{% endif %}>{{ r }}</option>{% endfor %}</select>
            {% endif %}
        </form>
    </div>
</div>

<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:30px;">
    <div class="stat-card" style="text-align:center;">
        <span class="label">Wykonanie (Gotowe)</span>
        <div style="font-size:2em; font-weight:bold; color:var(--primary-color); margin:5px 0;">{{ suma_wykonanie|round(1) }} t</div>
        <div style="font-size:0.9em; color:#7f8c8d;">z planu: {{ suma_plan|round(1) }} t</div>
    </div>
    <div class="stat-card" style="text-align:center;">
        <span class="label">Realizacja Celu</span>
        <div style="font-size:2em; font-weight:bold; color:{% if procent >= 100 %}var(--success-color){% else %}#e67e22{% endif %}; margin:5px 0;">{{ procent|round(1) }}%</div>
        <div style="width:100%; background:#ecf0f1; height:8px; border-radius:4px; overflow:hidden; margin-top:5px;"><div style="height:100%; width:{{ procent }}%; background:var(--success-color);"></div></div>
    </div>
    <div class="stat-card" style="text-align:center;">
        <span class="label">Ilo≈õƒá Zlece≈Ñ</span>
        <div style="font-size:2em; font-weight:bold; color:#8e44ad; margin:5px 0;">{{ ilosc_zlecen }}</div>
        <div style="font-size:0.9em; color:#7f8c8d;">Zako≈Ñczonych</div>
    </div>
    <div class="stat-card" style="text-align:center;">
        <span class="label">Czas Awarii</span>
        <div style="font-size:2em; font-weight:bold; color:var(--danger-color); margin:5px 0;">{{ time_aw }} min</div>
        <div style="font-size:0.9em; color:#7f8c8d;">≈ÅƒÖcznie</div>
    </div>
</div>

<div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:30px;">
    <div class="section-box" style="padding:20px;">
        <h4 style="margin-top:0;">üìà Produkcja: Zasyp vs Workowanie</h4>
        <canvas id="chartProduction" style="max-height:300px;"></canvas>
    </div>
    <div class="section-box" style="padding:20px;">
        <h4 style="margin-top:0;">üõë Przyczyny Przestoj√≥w</h4>
        <canvas id="chartIssues" style="max-height:300px;"></canvas>
    </div>
</div>

{% if session.get('rola') in ['admin', 'zarzad', 'lider'] %}
<div class="section-box" style="padding:0; overflow:hidden;">
    <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #eee;">
        <h3 style="margin:0; color:var(--primary-color);">üë• Statystyki Pracownik√≥w (HR)</h3>
    </div>
    <table class="modern-table">
        <thead>
            <tr>
                <th>Pracownik</th>
                {% if tryb == 'dzien' %}
                    <th class="text-center">Zasyp</th><th class="text-center">Workowanie</th><th class="text-center">Magazyn</th><th>Status HR</th>
                {% else %}
                    <th class="text-center">Dni Pracy</th><th class="text-center">Nadgodziny</th><th class="text-center">Nieobecno≈õci (h)</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for p in pracownicy_stats %}
            <tr>
                <td style="font-weight:bold;">{{ p.name }}</td>
                {% if tryb == 'dzien' %}
                    <td class="text-center">{{ p.zasyp }}</td><td class="text-center">{{ p.workowanie }}</td><td class="text-center">{{ p.magazyn }}</td>
                    <td>{% if p.hr == '-' %}<span style="color:#ccc;">-</span>{% elif p.hr == 'Obecny' %}<span style="color:green; font-weight:bold;">Obecny</span>{% else %}<span style="color:red;">{{ p.hr }}</span>{% endif %}</td>
                {% else %}
                    <td class="text-center"><strong>{{ p.total }}</strong></td><td class="text-center" style="color:green;">{{ p.ot }} h</td><td class="text-center" style="color:red;">{{ p.abs }} h</td>
                {% endif %}
            </tr>
            {% else %}<tr><td colspan="5" style="text-align:center; padding:20px;">Brak danych kadrowych.</td></tr>{% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- NOWY WYKRES LINIOWO-S≈ÅUPKOWY ---
    new Chart(document.getElementById('chartProduction'), {
        type: 'bar',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [
                { 
                    label: 'Plan (t)', 
                    data: {{ chart_plan|safe }}, 
                    backgroundColor: '#bdc3c7', 
                    barPercentage: 0.5 
                },
                { 
                    label: 'Zasyp (t)', 
                    data: {{ chart_zasyp|safe }}, 
                    backgroundColor: '#3498db', // Niebieski dla Zasypu
                    barPercentage: 0.7 
                },
                { 
                    label: 'Workowanie (t)', 
                    data: {{ chart_work|safe }}, 
                    backgroundColor: '#8e44ad', // Fioletowy dla Workowania
                    barPercentage: 0.7 
                }
            ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Tony' } }
            },
            plugins: {
                tooltip: { mode: 'index', intersect: false }
            }
        }
    });

    // Wykres Ko≈Çowy
    new Chart(document.getElementById('chartIssues'), {
        type: 'doughnut',
        data: {
            labels: {{ pie_labels|safe }},
            datasets: [{
                data: {{ pie_values|safe }},
                backgroundColor: ['#e74c3c', '#f39c12', '#f1c40f', '#95a5a6', '#34495e']
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
</script>

<style>
    .stat-card { background:white; padding:15px; border-radius:8px; border:1px solid #ddd; }
    .text-center { text-align: center; }
</style>

{% endblock %}