{% extends "layout.html" %}

{% block content %}

<div class="section-header">
    <div><h2 class="header-title">üìä Wyniki Produkcyjne: <strong>{{ tytul }}</strong></h2></div>
    <div class="filters">
        <a href="/zarzad?tryb=dzien&data={{ wybrana_data }}" class="btn {% if tryb=='dzien' %}btn-primary{% endif %}">{{ _('dzien') }}</a>
        <a href="/zarzad?tryb=miesiac&rok={{ wybrany_rok }}&miesiac={{ wybrany_miesiac }}" class="btn {% if tryb=='miesiac' %}btn-primary{% endif %}">{{ _('mies_ac') }}</a>
        <a href="/zarzad?tryb=rok&rok={{ wybrany_rok }}" class="btn {% if tryb=='rok' %}btn-primary{% endif %}">{{ _('rok') }}</a>
        <form action="/zarzad" method="GET" class="filters-form">
            <input type="hidden" name="tryb" value="{{ tryb }}">
            {% if tryb == 'dzien' %}
                <input type="date" name="data" value="{{ wybrana_data }}" onchange="this.form.submit()" class="filters-input" aria-label="Wybierz datƒô">
            {% elif tryb == 'miesiac' %}
                <select name="miesiac" onchange="this.form.submit()" class="filters-input" title="{{ _('mies_ac') }}" aria-label="MiesiƒÖc">{% for m in range(1,13) %}<option value="{{ m }}" {% if m==wybrany_miesiac %}selected{% endif %}>{{ m }}</option>{% endfor %}</select>
                <select name="rok" onchange="this.form.submit()" class="filters-input" title="{{ _('rok') }}" aria-label="Rok">{% for r in range(2024, 2030) %}<option value="{{ r }}" {% if r==wybrany_rok %}selected{% endif %}>{{ r }}</option>{% endfor %}</select>
            {% elif tryb == 'rok' %}
                <select name="rok" onchange="this.form.submit()" class="filters-input" title="{{ _('rok') }}" aria-label="Rok">{% for r in range(2024, 2030) %}<option value="{{ r }}" {% if r==wybrany_rok %}selected{% endif %}>{{ r }}</option>{% endfor %}</select>
            {% endif %}
        </form>
    </div>
</div>

<div class="stat-grid">
    <div class="stat-card">
        <span class="label">{{ _('wykonanie_gotowe') }}</span>
        <div class="header-title header-lg text-primary">{{ suma_wykonanie|round(1) }} kg</div>
        <div class="small text-muted">z planu: {{ suma_plan|round(1) }} kg</div>
    </div>
        <div class="stat-card">
        <span class="label">{{ _('realizacja_celu') }}</span>
        <div class="header-title header-lg {% if procent >= 100 %}text-success{% else %}text-warning{% endif %}">{{ procent|round(1) }}%</div>
        <div class="progress"><div class="progress-bar {% if procent >= 100 %}progress-bar-success{% else %}progress-bar-success{% endif %} progress-w-{{ procent|round(0)|int }}"></div></div>
    </div>
        <div class="stat-card">
        <span class="label">{{ _('ilosc_zlecen') }}</span>
        <div class="header-title header-lg text-zarzad">{{ ilosc_zlecen }}</div>
        <div class="small text-muted">{{ _('zakonczonych') }}</div>
    </div>
    <div class="stat-card">
        <span class="label">{{ _('czas_awarii') }}</span>
        <div class="header-title header-lg text-danger-color">{{ time_aw }} min</div>
        <div class="small text-muted">≈ÅƒÖcznie</div>
    </div>
</div>

<div class="grid-2-1 mb-30">
    <div class="section-box section-padding">
        <h4>üìà {{ _('produkcja') }}: {{ _('zasyp') }} vs {{ _('workowanie') }}</h4>
        <div class="chart-wrapper"><canvas id="chartProduction" class="chart-canvas"></canvas></div>
    </div>
    <div class="section-box section-padding">
        <h4>üõë Przyczyny Przestoj√≥w</h4>
        <div class="chart-wrapper"><canvas id="chartIssues" class="chart-canvas"></canvas></div>
    </div>
</div>

{% if session.get('rola') in ['admin', 'zarzad', 'lider'] %}
<div class="section-box section-box-no-pad">
    <div class="p-15 p-15-bg">
        <h3 class="m-0 text-primary">üë• Statystyki Pracownik√≥w (HR)</h3>
    </div>
    <table class="modern-table">
        <thead>
            <tr>
                <th>üë§ Pracownik</th>
                {% if tryb == 'dzien' %}
                    <th class="text-center">üè≠ {{ _('zasyp') }}</th><th class="text-center">üîß {{ _('workowanie') }}</th><th class="text-center">üì¶ {{ _('magazyn') }}</th><th>üìã {{ _('status_hr') }}</th>
                {% else %}
                    <th class="text-center">üìÖ Dni Pracy</th><th class="text-center">‚è∞ Nadgodziny</th><th class="text-center">‚ùå Nieobecno≈õci</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for p in pracownicy_stats %}
            <tr>
                <td><strong>{{ p.name }}</strong></td>
                {% if tryb == 'dzien' %}
                    <td class="text-center">{{ p.zasyp }}</td><td class="text-center">{{ p.workowanie }}</td><td class="text-center">{{ p.magazyn }}</td>
                    <td>{% if p.hr == '-' %}<span class="text-muted">-</span>{% elif p.hr == 'Obecny' %}<span class="text-success font-bold">{{ _('obecny') }}</span>{% else %}<span class="text-danger-color">{{ p.hr }}</span>{% endif %}</td>
                {% else %}
                    <td class="text-center"><strong>{{ p.total }}</strong></td><td class="text-center text-success">{{ p.ot }} h</td><td class="text-center text-danger-color">{{ p.abs }} h</td>
                {% endif %}
            </tr>
            {% else %}<tr><td colspan="5" class="text-center p-20">{{ _('brak_danych_kadrowych') }}</td></tr>{% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- NOWY WYKRES LINIOWO-S≈ÅUPKOWY ---
    new Chart(document.getElementById('chartProduction'), {
        type: 'bar',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [
                { 
                    label: 'Plan (kg)', 
                    data: {{ chart_plan|safe }}, 
                    backgroundColor: '#bdc3c7', 
                    barPercentage: 0.5 
                },
                { 
                    label: '{{ _('zasyp') }} (kg)', 
                    data: {{ chart_zasyp|safe }}, 
                    backgroundColor: '#3498db', // Niebieski dla Zasypu
                    barPercentage: 0.7 
                },
                { 
                    label: '{{ _('workowanie') }} (kg)', 
                    data: {{ chart_work|safe }}, 
                    backgroundColor: '#8e44ad', // Fioletowy dla Workowania
                    barPercentage: 0.7 
                }
            ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'kg' } }
            },
            plugins: {
                tooltip: { mode: 'index', intersect: false }
            }
        }
    });

    // Wykres Ko≈Çowy
    new Chart(document.getElementById('chartIssues'), {
        type: 'doughnut',
        data: {
            labels: {{ pie_labels|safe }},
            datasets: [{
                data: {{ pie_values|safe }},
                backgroundColor: ['#e74c3c', '#f39c12', '#f1c40f', '#95a5a6', '#34495e']
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
</script>

{% endblock %}