{% extends "layout.html" %}

{% block content %}

<div class="section-header">
    <h2 class="header-title">üìä Wyniki Produkcji: {{ tytul }}</h2>
    
    <div class="header-actions">
        <form action="/zarzad" method="GET" class="inline-form" style="display:flex; gap:10px; align-items:center;">
            
            <select name="tryb" onchange="this.form.submit()" style="padding:8px; border-radius:5px;">
                <option value="dzien" {% if tryb=='dzien' %}selected{% endif %}>Dzie≈Ñ</option>
                <option value="tydzien" {% if tryb=='tydzien' %}selected{% endif %}>Tydzie≈Ñ</option>
                <option value="miesiac" {% if tryb=='miesiac' %}selected{% endif %}>MiesiƒÖc</option>
                <option value="rok" {% if tryb=='rok' %}selected{% endif %}>Rok</option>
            </select>

            {% if tryb == 'dzien' %}
                <input type="date" name="data" value="{{ wybrana_data }}" onchange="this.form.submit()" style="padding:8px;">
            {% elif tryb == 'miesiac' %}
                <select name="miesiac" onchange="this.form.submit()" style="padding:8px;">
                    {% for m in range(1,13) %}
                    <option value="{{ m }}" {% if m == wybrany_miesiac %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="rok" value="{{ wybrany_rok }}" onchange="this.form.submit()" style="width:60px; padding:8px;">
            {% elif tryb == 'rok' %}
                <input type="number" name="rok" value="{{ wybrany_rok }}" onchange="this.form.submit()" style="width:60px; padding:8px;">
            {% endif %}
        </form>
    </div>
</div>

<div style="display:flex; gap:20px; margin-bottom:30px; flex-wrap:wrap;">
    <div style="flex:1; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); border-left:5px solid #3498db;">
        <div style="font-size:0.9em; color:gray; text-transform:uppercase;">Plan Produkcji</div>
        <div style="font-size:2em; font-weight:bold; color:#2c3e50;">{{ suma_plan | round(1) }} t</div>
    </div>
    
    <div style="flex:1; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); border-left:5px solid #27ae60;">
        <div style="font-size:0.9em; color:gray; text-transform:uppercase;">Wykonanie</div>
        <div style="font-size:2em; font-weight:bold; color:#27ae60;">{{ suma_wykonanie | round(1) }} t</div>
    </div>

    <div style="flex:1; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); border-left:5px solid {% if procent >= 100 %}#27ae60{% elif procent >= 80 %}#f39c12{% else %}#e74c3c{% endif %};">
        <div style="font-size:0.9em; color:gray; text-transform:uppercase;">Realizacja</div>
        <div style="font-size:2em; font-weight:bold; color:{% if procent >= 100 %}#27ae60{% elif procent >= 80 %}#f39c12{% else %}#e74c3c{% endif %};">
            {{ procent | round(1) }}%
        </div>
    </div>

    <div style="flex:1; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); border-left:5px solid #c0392b;">
        <div style="font-size:0.9em; color:gray; text-transform:uppercase;">Czas Postoj√≥w</div>
        <div style="font-size:2em; font-weight:bold; color:#c0392b;">{{ time_aw }} min</div>
    </div>
</div>

<div style="display:flex; gap:20px; margin-bottom:30px; flex-wrap:wrap;">
    <div style="flex:2; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
        <h4 style="margin-top:0;">üìà Trend Produkcji</h4>
        <div style="height:300px;">
            <canvas id="chartProdukcja"></canvas>
        </div>
    </div>

    <div style="flex:1; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
        <h4 style="margin-top:0;">‚ö†Ô∏è Przyczyny Postoj√≥w</h4>
        <div style="height:300px; position:relative;">
            <canvas id="chartAwarie"></canvas>
        </div>
    </div>
</div>

<div class="crew-box">
    <h4>üë• Raport Pracowniczy</h4>
    <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead style="background:#eee;">
            <tr>
                <th style="padding:10px; text-align:left;">Pracownik</th>
                {% if tryb == 'dzien' %}
                    <th style="padding:10px; text-align:center;">Zasyp</th>
                    <th style="padding:10px; text-align:center;">Workowanie</th>
                    <th style="padding:10px; text-align:center;">Magazyn</th>
                    <th style="padding:10px; text-align:left;">Status HR</th>
                {% else %}
                    <th style="padding:10px; text-align:center;">Obecno≈õci (dni)</th>
                    <th style="padding:10px; text-align:center;">Nadgodziny (h)</th>
                    <th style="padding:10px; text-align:center;">Nieobecno≈õci (h)</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for p in pracownicy_stats %}
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:10px;"><strong>{{ p['name'] }}</strong></td>
                {% if tryb == 'dzien' %}
                    <td style="padding:10px; text-align:center;">{{ p['zasyp'] }}</td>
                    <td style="padding:10px; text-align:center;">{{ p['workowanie'] }}</td>
                    <td style="padding:10px; text-align:center;">{{ p['magazyn'] }}</td>
                    <td style="padding:10px;">
                        {% if p['hr'] == 'Nieobecno≈õƒá' %}<span style="color:red;">Nieobecny</span>
                        {% elif p['hr'] == 'Nadgodziny' %}<span style="color:blue;">Nadgodziny</span>
                        {% else %}-{% endif %}
                    </td>
                {% else %}
                    <td style="padding:10px; text-align:center;">{{ p['total'] }}</td>
                    <td style="padding:10px; text-align:center; color:blue;">{{ p['ot'] }}</td>
                    <td style="padding:10px; text-align:center; color:red;">{{ p['abs'] }}</td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- WYKRES PRODUKCJI (S≈ÅUPKOWY) ---
    const ctxProd = document.getElementById('chartProdukcja').getContext('2d');
    new Chart(ctxProd, {
        type: 'bar',
        data: {
            // "safe" jest kluczowe, ≈ºeby Python przekaza≈Ç dane jako JSON
            labels: {{ chart_labels | safe }},
            datasets: [
                {
                    label: 'Wykonanie (t)',
                    data: {{ chart_wyk | safe }},
                    backgroundColor: '#27ae60'
                },
                {
                    label: 'Plan (t)',
                    data: {{ chart_plan | safe }},
                    backgroundColor: '#bdc3c7'
                }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // --- WYKRES AWARII (KO≈ÅOWY) ---
    const ctxAw = document.getElementById('chartAwarie').getContext('2d');
    const labelsAw = {{ pie_labels | safe }};
    
    if (labelsAw.length > 0) {
        new Chart(ctxAw, {
            type: 'doughnut',
            data: {
                labels: labelsAw,
                datasets: [{
                    data: {{ pie_values | safe }},
                    backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#9b59b6']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    } else {
        // Je≈õli brak awarii, rysujemy pusty szary okrƒÖg z napisem
        new Chart(ctxAw, {
            type: 'doughnut',
            data: { labels: ["Brak awarii"], datasets: [{ data: [1], backgroundColor: ["#ecf0f1"] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { enabled: false } } }
        });
    }
</script>
{% endblock %}