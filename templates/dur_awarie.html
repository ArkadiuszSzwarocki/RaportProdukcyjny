{% extends "layout.html" %}

{% block title %}DUR - Awarie{% endblock %}

{% block content %}
<div style="padding: 20px; max-width: 1400px; margin: 0 auto;">
  <h1 style="color: #2c3e50; margin-bottom: 30px;">âš ï¸ Awarie i Przestoje - Zatwierdzanie</h1>
  
  {% if awarie %}
    {% for awaria in awarie %}
    <div style="margin-bottom: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
      <!-- NAGÅÃ“WEK AWARII -->
      {% set status_color = {'zgÅ‚oszony': '#fff3cd', 'czeka_na_czesci': '#ffcccc', 'zakoÅ„czony': '#d4edda', 'zamkniÄ™ty': '#f5f5f5'} %}
      {% set status_border = {'zgÅ‚oszony': '#ffc107', 'czeka_na_czesci': '#dc3545', 'zakoÅ„czony': '#28a745', 'zamkniÄ™ty': '#999999'} %}
      <div style="padding: 15px; background: {{ status_color.get(awaria.status_zglosnienia, '#f0f0f0') }}; border-left: 5px solid {{ status_border.get(awaria.status_zglosnienia, '#999999') }};">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; margin-bottom: 10px;">
          <div>
            <strong>Data:</strong> {{ awaria.data_wpisu }}<br>
            <strong>Sekcja:</strong> {{ awaria.sekcja }}
          </div>
          <div>
            <strong>Kategoria:</strong> {{ awaria.kategoria }}<br>
            <strong>RaportowaÅ‚:</strong> {{ awaria.pracownik_name }}
          </div>
          <div>
            <strong>Start:</strong> {{ awaria.czas_start_str }}<br>
            <strong>Stop:</strong> {% if awaria.czas_stop_str and awaria.czas_stop_str != '??:??' %}{{ awaria.czas_stop_str }}{% else %}â€”{% endif %}
          </div>
          <div>
            <strong>Status zgÅ‚oszenia:</strong>
            {% set status_map = {'zgÅ‚oszony': 'ğŸ”” ZgÅ‚oszony', 'czeka_na_czesci': 'âš™ï¸ Czeka na czÄ™Å›ci', 'zakoÅ„czony': 'âœ… ZakoÅ„czony', 'zamkniÄ™ty': 'ğŸ”’ ZamkniÄ™ty'} %}
            {% set status_bg = {'zgÅ‚oszony': '#ffc107', 'czeka_na_czesci': '#dc3545', 'zakoÅ„czony': '#28a745', 'zamkniÄ™ty': '#cccccc'} %}
            {% set status_text = {'zgÅ‚oszony': '#000', 'czeka_na_czesci': '#fff', 'zakoÅ„czony': '#fff', 'zamkniÄ™ty': '#666'} %}
            <span style="padding: 6px 12px; border-radius: 4px; background: {{ status_bg.get(awaria.status_zglosnienia, '#999') }}; color: {{ status_text.get(awaria.status_zglosnienia, '#fff') }}; font-weight: bold;">{{ status_map.get(awaria.status_zglosnienia, awaria.status_zglosnienia) }}</span>
            {% if awaria.data_zakonczenia %}
            <br><strong>ZakoÅ„czono:</strong> {{ awaria.data_zakonczenia }}
            {% endif %}
          </div>
        </div>
        <div style="padding: 10px; background: rgba(0,0,0,0.05); border-radius: 4px;">
          <strong>Problem:</strong><br>
          {{ awaria.problem }}
        </div>
      </div>
      
      <!-- KOMENTARZE -->
      {% if awaria.komentarze %}
      <div style="padding: 15px; background: #f9f9f9; border-top: 1px solid #ddd;">
        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">ğŸ’¬ Komentarze ({{ awaria.komentarze|length }})</h4>
        {% for kom in awaria.komentarze %}
        <div style="padding: 10px; background: white; border-left: 3px solid #2c3e50; margin-bottom: 10px; border-radius: 4px;">
          <small style="color: #666; display: block; margin-bottom: 5px;">
            <strong>{{ kom.imie_nazwisko or 'Anonimowy' }}</strong> - {{ kom.created_at.strftime('%Y-%m-%d %H:%M:%S') if kom.created_at else 'N/A' }}
          </small>
          <p style="margin: 0; padding: 0;">{{ kom.tresc }}</p>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      
      <!-- FORMULARZ AKCJI -->
      <div style="padding: 15px; background: #f0f0f0; border-top: 1px solid #ddd;">
        <form method="POST" action="{{ url_for('dur_zatwierdz_awariÄ™', awaria_id=awaria.id) }}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: flex-end;">
          
          <!-- Pole czasu zakoÅ„czenia -->
          <div>
            <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px;">
              â° Czas zakoÅ„czenia (opcjonalnie)
            </label>
            <input type="time" name="czas_stop" value="{% if awaria.czas_stop_str and awaria.czas_stop_str != '??:??' %}{{ awaria.czas_stop_str }}{% endif %}" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; font-size: 14px;">
          </div>

          <!-- Status zgÅ‚oszenia -->
          <div>
            <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px;">
              ğŸ“‹ Status zgÅ‚oszenia
            </label>
            <select name="status_zglosnienia" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; font-size: 14px;">
              <option value="zgÅ‚oszony" {% if awaria.status_zglosnienia == 'zgÅ‚oszony' %}selected{% endif %}>ğŸ”” ZgÅ‚oszony</option>
              <option value="czeka_na_czesci" {% if awaria.status_zglosnienia == 'czeka_na_czesci' %}selected{% endif %}>âš™ï¸ Czeka na czÄ™Å›ci</option>
              <option value="zakoÅ„czony" {% if awaria.status_zglosnienia == 'zakoÅ„czony' %}selected{% endif %}>âœ… ZakoÅ„czony</option>
              <option value="zamkniÄ™ty" {% if awaria.status_zglosnienia == 'zamkniÄ™ty' %}selected{% endif %}>ğŸ”’ ZamkniÄ™ty</option>
            </select>
          </div>

          <!-- Data zakoÅ„czenia -->
          <div>
            <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px;">
              ğŸ“… Data zakoÅ„czenia (opcjonalnie)
            </label>
            <input type="date" name="data_zakonczenia" value="{{ awaria.data_zakonczenia if awaria.data_zakonczenia else '' }}" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; font-size: 14px;">
          </div>
          
          <!-- Pole komentarza -->
          <div>
            <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px;">
              ğŸ“ TwÃ³j komentarz (opcjonalnie)
            </label>
            <input type="text" name="komentarz" placeholder="np. Naprawa ukoÅ„czona..." style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; font-size: 14px;">
          </div>
          
          <!-- Przycisk zapisz -->
          <div>
            <button type="submit" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s;">
              ğŸ’¾ Zapisz
            </button>
          </div>
        </form>
      </div>
    </div>
    {% endfor %}
    
    <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 4px; font-size: 14px;">
      <p><strong>Razem awarii:</strong> {{ awarie|length }}</p>
      <p><strong>Roboczych:</strong> {{ awarie|selectattr('status', 'equalto', 'roboczy')|list|length }}</p>
      <p><strong>Zatwierdzonych:</strong> {{ awarie|selectattr('status', 'equalto', 'zatwierdzone')|list|length }}</p>
      <p><strong>Odrzuconych:</strong> {{ awarie|selectattr('status', 'equalto', 'odrzucone')|list|length }}</p>
    </div>
  {% else %}
    <div style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 4px;">
      <h3 style="color: #6c757d;">Brak awarii w ostatnich 30 dniach</h3>
      <p style="color: #999;">Wszystkie systemy dziaÅ‚ajÄ… bez problemÃ³w! ğŸ‰</p>
    </div>
  {% endif %}
</div>

<style>
  input[type="time"],
  input[type="text"] {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  form {
    margin: 0;
  }
</style>
{% endblock %}
