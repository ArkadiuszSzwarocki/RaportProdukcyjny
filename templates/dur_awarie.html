{% extends "layout.html" %}

{% block title %}DUR - Awarie{% endblock %}

{% block content %}
<style>
  /* Container styles */
  .awarie-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .page-title {
    color: #2c3e50;
    margin-bottom: 30px;
  }

  .awaria-card {
    margin-bottom: 30px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  /* Header styles */
  .awaria-header {
    padding: 15px;
    border-left: 5px solid;
    box-sizing: border-box;
  }

  .awaria-header.status-zg≈Çoszone {
    background-color: #e7f3ff;
    border-left-color: #0066cc;
  }

  .awaria-header.status-czeka_na_czesci {
    background-color: #ffcccc;
    border-left-color: #dc3545;
  }

  .awaria-header.status-w_trakcie_naprawy {
    background-color: #fff3cd;
    border-left-color: #ffc107;
  }

  .awaria-header.status-zako≈Ñczone {
    background-color: #d4edda;
    border-left-color: #28a745;
  }

  .header-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 10px;
  }

  .header-section {
    font-size: 14px;
  }

  .problem-section {
    padding: 10px;
    background: rgba(0,0,0,0.05);
    border-radius: 4px;
    margin-top: 10px;
  }

  .status-select-label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 12px;
  }

  .status-select-header {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
  }

  .status-warning {
    color: #d9534f;
    font-weight: bold;
    display: block;
    margin-top: 3px;
    font-size: 12px;
  }

  .status-date {
    color: #666;
    display: block;
    margin-top: 5px;
    font-size: 12px;
  }

  /* History section */
  .history-section {
    padding: 15px;
    background: #f0f8ff;
    border-top: 1px solid #ddd;
  }

  .history-title {
    margin: 0 0 15px 0;
    color: #0066cc;
    font-size: 16px;
  }

  .history-item {
    padding: 10px;
    background: white;
    border-left: 3px solid #0066cc;
    margin-bottom: 10px;
    border-radius: 4px;
    font-size: 13px;
  }

  .history-item-flex {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .history-timestamp {
    color: #666;
    white-space: nowrap;
    font-size: 12px;
  }

  /* Comments section */
  .comments-section {
    padding: 15px;
    background: #f9f9f9;
    border-top: 1px solid #ddd;
  }

  .toggle-comments {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .comments-title {
    margin: 0;
    color: #2c3e50;
    font-size: 16px;
  }

  .toggle-icon {
    font-size: 20px;
    color: #666;
    transition: transform 0.2s;
  }

  .comments-container {
    margin-top: 15px;
  }

  .comment-item {
    padding: 10px;
    background: white;
    border-left: 3px solid #2c3e50;
    margin-bottom: 10px;
    border-radius: 4px;
  }

  .comment-meta {
    color: #666;
    display: block;
    margin-bottom: 5px;
    font-size: 12px;
  }

  .comment-text {
    margin: 0;
    padding: 0;
    word-wrap: break-word;
    font-size: 14px;
  }

  .no-comments {
    color: #999;
    font-style: italic;
    padding: 10px;
  }

  .add-comment-form {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
  }

  .comment-input-container {
    display: flex;
    gap: 10px;
  }

  .comment-input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .btn-add-comment {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    white-space: nowrap;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .btn-add-comment:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .btn-add-comment:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Statistics section */
  .stats-section {
    margin-top: 30px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 14px;
  }

  .stats-section p {
    margin: 10px 0;
  }

  /* Empty state */
  .empty-state {
    padding: 40px;
    text-align: center;
    background: #f8f9fa;
    border-radius: 4px;
  }

  .empty-state-title {
    color: #6c757d;
    font-size: 18px;
  }

  .empty-state-message {
    color: #999;
    font-size: 14px;
  }

  /* Input and button defaults */
  input[type="time"],
  input[type="text"] {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  form {
    margin: 0;
  }

  .awarie-wrapper {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .page-heading {
    color: #2c3e50;
    margin-bottom: 30px;
  }

  .awaria-wrapper {
    margin-bottom: 30px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .header-grid-flex {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 10px;
  }

  .problem-block {
    padding: 10px;
    background: rgba(0,0,0,0.05);
    border-radius: 4px;
  }

  .history-section-block {
    padding: 15px;
    background: #f0f8ff;
    border-top: 1px solid #ddd;
  }

  .history-title-text {
    margin: 0 0 15px 0;
    color: #0066cc;
  }

  .history-item-block {
    padding: 10px;
    background: white;
    border-left: 3px solid #0066cc;
    margin-bottom: 10px;
    border-radius: 4px;
    font-size: 13px;
  }

  .history-item-flex-block {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .history-timestamp-text {
    color: #666;
    white-space: nowrap;
    font-size: 12px;
  }

  .comments-section-block {
    padding: 15px;
    background: #f9f9f9;
    border-top: 1px solid #ddd;
  }

  .toggle-comments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .comments-title-text {
    margin: 0;
    color: #2c3e50;
  }

  .toggle-icon-element {
    font-size: 20px;
    color: #666;
    transition: transform 0.2s;
  }

  .comments-list {
    margin-top: 15px;
  }

  .comment-item-block {
    padding: 10px;
    background: white;
    border-left: 3px solid #2c3e50;
    margin-bottom: 10px;
    border-radius: 4px;
  }

  .comment-meta-text {
    color: #666;
    display: block;
    margin-bottom: 5px;
    font-size: 12px;
  }

  .comment-text-block {
    margin: 0;
    padding: 0;
    word-wrap: break-word;
  }

  .no-comments-text {
    color: #999;
    font-style: italic;
    padding: 10px;
  }

  .add-comment-form-block {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
  }

  .comment-input-flex {
    display: flex;
    gap: 10px;
  }

  .comment-input-field {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
  }

  .status-label-text {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 12px;
  }

  .status-warning-text {
    color: #d9534f;
    font-weight: bold;
    display: block;
    margin-top: 3px;
    font-size: 12px;
  }

  .status-date-text {
    color: #666;
    display: block;
    margin-top: 5px;
    font-size: 12px;
  }

  .stats-block {
    margin-top: 30px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 14px;
  }

  .stats-block p {
    margin: 10px 0;
  }

  .empty-state-block {
    padding: 40px;
    text-align: center;
    background: #f8f9fa;
    border-radius: 4px;
  }

  .empty-state-title-text {
    color: #6c757d;
    font-size: 18px;
  }

  .empty-state-message-text {
    color: #999;
    font-size: 14px;
  }

  /* Inline styles to move to CSS */
  .awaria-card-wrapper {
    margin-bottom: 30px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .header-grid-inline {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 10px;
  }

  .header-grid-inline > div {
    font-size: 14px;
  }

  .header-grid-inline strong {
    font-weight: bold;
  }

  .problem-section-inline {
    padding: 10px;
    background: rgba(0,0,0,0.05);
    border-radius: 4px;
    margin-top: 10px;
  }

  .status-label-header {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 12px;
  }

  .status-message-warning {
    color: #d9534f;
    font-weight: bold;
    display: block;
    margin-top: 3px;
    font-size: 12px;
  }

  .status-message-date {
    color: #666;
    display: block;
    margin-top: 5px;
    font-size: 12px;
  }

  .history-section-inline {
    padding: 15px;
    background: #f0f8ff;
    border-top: 1px solid #ddd;
  }

  .history-title-inline {
    margin: 0 0 15px 0;
    color: #0066cc;
  }

  .history-item-inline {
    padding: 10px;
    background: white;
    border-left: 3px solid #0066cc;
    margin-bottom: 10px;
    border-radius: 4px;
    font-size: 13px;
  }

  .history-flex {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .history-timestamp-inline {
    color: #666;
    white-space: nowrap;
    font-size: 12px;
  }

  .comments-section-inline {
    padding: 15px;
    background: #f9f9f9;
    border-top: 1px solid #ddd;
  }

  .toggle-comments-inline {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .comments-title-inline {
    margin: 0;
    color: #2c3e50;
  }

  .toggle-icon-inline {
    font-size: 20px;
    color: #666;
    transition: transform 0.2s;
  }

  .comments-container-inline {
    margin-top: 15px;
  }

  .comment-item-inline {
    padding: 10px;
    background: white;
    border-left: 3px solid #2c3e50;
    margin-bottom: 10px;
    border-radius: 4px;
  }

  .comment-meta-inline {
    color: #666;
    display: block;
    margin-bottom: 5px;
    font-size: 12px;
  }

  .comment-text-inline {
    margin: 0;
    padding: 0;
    word-wrap: break-word;
  }

  .no-comments-inline {
    color: #999;
    font-style: italic;
    padding: 10px;
  }

  .add-comment-form-inline {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
  }

  .comment-input-flex-inline {
    display: flex;
    gap: 10px;
  }

  .comment-input-inline {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
  }

  .btn-add-comment-inline {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    white-space: nowrap;
  }

  .stats-section-inline {
    margin-top: 30px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 14px;
  }

  .stats-section-inline p {
    margin: 10px 0;
  }

  .empty-state-inline {
    padding: 40px;
    text-align: center;
    background: #f8f9fa;
    border-radius: 4px;
  }

  .empty-state-title-inline {
    color: #6c757d;
    font-size: 18px;
  }

  .empty-state-message-inline {
    color: #999;
  }

  /* Awaria card wrapper */
  .awaria-card-inner {
    margin-bottom: 30px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  /* Header grid layout */
  .awaria-header-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 10px;
  }

  /* Status label styling */
  .status-label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 12px;
  }

  /* Status warning text */
  .status-warning-message {
    color: #d9534f;
    font-weight: bold;
    display: block;
    margin-top: 3px;
  }

  /* Status date text */
  .status-date-message {
    color: #666;
    display: block;
    margin-top: 5px;
  }

  /* Problem box styling */
  .problem-box {
    padding: 10px;
    background: rgba(0,0,0,0.05);
    border-radius: 4px;
  }

  /* History section wrapper */
  .history-section-wrapper {
    padding: 15px;
    background: #f0f8ff;
    border-top: 1px solid #ddd;
  }

  /* History title styling */
  .history-title-main {
    margin: 0 0 15px 0;
    color: #0066cc;
  }

  /* History change item */
  .history-change-item {
    padding: 10px;
    background: white;
    border-left: 3px solid #0066cc;
    margin-bottom: 10px;
    border-radius: 4px;
    font-size: 13px;
  }

  /* History flex layout */
  .history-flex-layout {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* History timestamp styling */
  .history-timestamp-main {
    color: #666;
    white-space: nowrap;
  }

  /* Comments section wrapper */
  .comments-section-wrapper {
    padding: 15px;
    background: #f9f9f9;
    border-top: 1px solid #ddd;
  }

  /* Toggle comments header */
  .toggle-comments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  /* Comments title styling */
  .comments-title-header {
    margin: 0;
    color: #2c3e50;
  }

  /* Toggle icon styling */
  .toggle-icon-main {
    font-size: 20px;
    color: #666;
    transition: transform 0.2s;
  }

  /* Comments container spacing */
  .comments-container-wrapper {
    margin-top: 15px;
  }

  /* Individual comment styling */
  .comment-item-main {
    padding: 10px;
    background: white;
    border-left: 3px solid #2c3e50;
    margin-bottom: 10px;
    border-radius: 4px;
  }

  /* Comment meta information */
  .comment-meta-main {
    color: #666;
    display: block;
    margin-bottom: 5px;
    font-size: 12px;
  }

  /* Comment text styling */
  .comment-text-main {
    margin: 0;
    padding: 0;
    word-wrap: break-word;
  }

  /* No comments message */
  .no-comments-message {
    color: #999;
    font-style: italic;
    padding: 10px;
  }

  /* Add comment form wrapper */
  .add-comment-form-wrapper {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
  }

  /* Comment input flex layout */
  .comment-input-flex-layout {
    display: flex;
    gap: 10px;
  }

  /* Comment input field styling */
  .comment-input-field-main {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  /* Button add comment styling */
  .btn-add-comment-main {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    white-space: nowrap;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  /* Statistics section styling */
  .stats-section-main {
    margin-top: 30px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 14px;
  }

  .stats-section-main p {
    margin: 10px 0;
  }

  /* Empty state styling */
  .empty-state-main {
    padding: 40px;
    text-align: center;
    background: #f8f9fa;
    border-radius: 4px;
  }

  /* Empty state title */
  .empty-state-title-main {
    color: #6c757d;
    font-size: 18px;
  }

  /* Empty state message */
  .empty-state-message-main {
    color: #999;
  }

  /* Awaria header with dynamic styling */
  .awaria-header-dynamic {
    padding: 15px;
    box-sizing: border-box;
  }

  /* Status-specific header colors */
  .awaria-header-base {
    padding: 15px;
    box-sizing: border-box;
    border-left: 5px solid;
  }

  .awaria-header-base.status-zg≈Çoszone {
    background-color: #e7f3ff;
    border-left-color: #0066cc;
  }

  .awaria-header-base.status-czeka_na_czesci {
    background-color: #ffcccc;
    border-left-color: #dc3545;
  }

  .awaria-header-base.status-w_trakcie_naprawy {
    background-color: #fff3cd;
    border-left-color: #ffc107;
  }

  .awaria-header-base.status-zako≈Ñczone {
    background-color: #d4edda;
    border-left-color: #28a745;
  }

  /* Dynamic awaria header colors */
  .awaria-header-dynamic.status-zg≈Çoszone {
    background-color: #e7f3ff;
    border-left-color: #0066cc;
  }

  .awaria-header-dynamic.status-czeka_na_czesci {
    background-color: #ffcccc;
    border-left-color: #dc3545;
  }

  .awaria-header-dynamic.status-w_trakcie_naprawy {
    background-color: #fff3cd;
    border-left-color: #ffc107;
  }

  .awaria-header-dynamic.status-zako≈Ñczone {
    background-color: #d4edda;
    border-left-color: #28a745;
  }
</style>
<div class="awarie-wrapper">
  <h1 class="page-heading">‚ö†Ô∏è Awarie i Przestoje - Zatwierdzanie</h1>
  
  {% if awarie %}
    {% for awaria in awarie %}
    <div class="awaria-card-inner">
      <!-- NAG≈Å√ìWEK AWARII -->
      <div class="awaria-header status-{{ awaria.status }}" data-status="{{ awaria.status }}">


        <div class="awaria-header-grid">
          <div>
            <strong>Data:</strong> {{ awaria.data_wpisu }}<br>
            <strong>{{ _('sekcja_label') }}</strong> {{ awaria.sekcja }}
          </div>
          <div>
            <strong>{{ _('kategoria') }}</strong> {{ awaria.kategoria }}<br>
            <strong>{{ _('raportowa≈Ç') }}</strong> {{ awaria.pracownik_name }}
          </div>
          <div>
            <strong>{{ _('start_label') }}</strong> {{ awaria.czas_start_str }}<br>
            <strong>{{ _('stop_label') }}</strong> {% if awaria.czas_stop_str and awaria.czas_stop_str != '??:??' %}{{ awaria.czas_stop_str }}{% else %}‚Äî{% endif %}
          </div>
          <div>
            <label class="status-label">üîß Status:</label>
            <select class="status-select-header" data-awaria-id="{{ awaria.id }}" title="{{ _('zmien_status') }}">
              <!-- Statusy -->
              <option value="zg≈Çoszone" {% if awaria.status == 'zg≈Çoszone' %}selected{% endif %}>üîî Zg≈Çoszone</option>
              <option value="czeka_na_czesci" {% if awaria.status == 'czeka_na_czesci' %}selected{% endif %}>‚öôÔ∏è Czeka na czƒô≈õci</option>
              <option value="w_trakcie_naprawy" {% if awaria.status == 'w_trakcie_naprawy' %}selected{% endif %}>üîß W trakcie naprawy</option>
              <option value="zako≈Ñczone" {% if awaria.status == 'zako≈Ñczone' %}selected{% endif %}>‚úÖ Zako≈Ñczone</option>
              
              <!-- Stare statusy - do migracji (pokazane z ostrze≈ºeniem) -->
              {% set old_statuses = ['roboczy', 'zatwierdzone', 'odrzucone', 'wznowione', 'zg≈Çoszony', 'czeka_na_czesci_old'] %}
              {% if awaria.status in old_statuses and awaria.status not in ['czeka_na_czesci', 'w_trakcie_naprawy', 'zako≈Ñczone'] %}
              <option value="{{ awaria.status }}" selected>‚ö†Ô∏è [STARY] {{ awaria.status }}</option>
              {% endif %}
            </select>
            <small class="status-warning-message">
              {% if awaria.status in ['roboczy', 'zatwierdzone', 'odrzucone', 'wznowione', 'zg≈Çoszony'] %}
              ‚ö†Ô∏è Status wymaga migracji - proszƒô wybraƒá nowy status z listy
              {% endif %}
            </small>
            {% if awaria.data_zakonczenia %}
            <small class="status-date-message"><strong>{{ _('zakonczono') }}</strong> {{ awaria.data_zakonczenia }}</small>
            {% endif %}
          </div>
        </div>
        <div class="problem-box">
          <strong>Problem:</strong><br>
          {{ awaria.problem }}
        </div>
      </div>
      
      <!-- HISTORIA ZMIAN STATUSU -->
      {% if awaria.historia_statusu %}
      <div class="history-section-wrapper">
        <h4 class="history-title-main">üìä Historia zmian statusu</h4>
        {% for zmiana in awaria.historia_statusu %}
        <div class="history-change-item">
          <div class="history-flex-layout">
            <div>
              <strong>{{ zmiana.imie_nazwisko or 'System' }}</strong> zmieni≈Ç status
              {% if zmiana.stary_status %}na <strong>{{ zmiana.nowy_status }}</strong> (z {{ zmiana.stary_status }}){% else %}na <strong>{{ zmiana.nowy_status }}</strong>{% endif %}
            </div>
            <small class="history-timestamp-main">
              {{ zmiana.data_zmiany.strftime('%Y-%m-%d %H:%M:%S') if zmiana.data_zmiany else 'N/A' }}
            </small>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      
      <!-- KOMENTARZE (ZWIJANE) -->
      <div class="comments-section-wrapper">
        <div class="toggle-comments-header toggle-comments" data-awaria-id="{{ awaria.id }}">
          <h4 class="comments-title-header">üí¨ Komentarze ({{ awaria.komentarze|length if awaria.komentarze else 0 }})</h4>
          <span class="toggle-icon-main toggle-icon">‚ñº</span>
        </div>
        
        <!-- Lista komentarzy -->
        <div class="comments-container-wrapper comments-container" data-awaria-id="{{ awaria.id }}">
          {% if awaria.komentarze %}
            {% for kom in awaria.komentarze %}
            <div class="comment-item-main">
              <small class="comment-meta-main">
                <strong>{{ kom.imie_nazwisko or 'System' }}</strong> - {{ kom.created_at.strftime('%Y-%m-%d %H:%M:%S') if kom.created_at else 'N/A' }}
              </small>
              <p class="comment-text-main">{{ kom.tresc }}</p>
            </div>
            {% endfor %}
          {% else %}
            <p class="no-comments-message">{{ _('brak_komentarzy') }}</p>
          {% endif %}
        </div>
        
        <!-- Formularz dodawania komentarza -->
        <form class="add-comment-form add-comment-form-wrapper" data-awaria-id="{{ awaria.id }}">
          <div class="comment-input-flex-layout">
            <input 
              type="text" 
              class="comment-input comment-input-field-main" 
              name="komentarz" 
              placeholder="Dodaj komentarz...">
            <button 
              type="submit" 
              class="btn-add-comment btn-add-comment-main">
              üìù Dodaj
            </button>
          </div>
        </form>
      </div>

    </div>
    {% endfor %}
    
    <div class="stats-section-main">
      <p><strong>{{ _('razem_awarii') }}</strong> {{ awarie|length }}</p>
      <p><strong>{{ _('zgloszenia') }}</strong> {{ awarie|selectattr('status', 'equalto', 'zg≈Çoszone')|list|length }}</p>
      <p><strong>{{ _('czeka_na_czesci') }}</strong> {{ awarie|selectattr('status', 'equalto', 'czeka_na_czesci')|list|length }}</p>
      <p><strong>{{ _('w_trakcie_naprawy') }}</strong> {{ awarie|selectattr('status', 'equalto', 'w_trakcie_naprawy')|list|length }}</p>
      <p><strong>Zako≈Ñczone:</strong> {{ awarie|selectattr('status', 'equalto', 'zako≈Ñczone')|list|length }}</p>
    </div>
  {% else %}
    <div class="empty-state-main">
      <h3 class="empty-state-title-main">{{ _('brak_awarii_30_dni') }}</h3>
      <p class="empty-state-message-main">{{ _('wszystkie_systemy_ok') }}</p>
    </div>
  {% endif %}
</div>

<style>
  input[type="time"],
  input[type="text"] {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  form {
    margin: 0;
  }
</style>

<script>
// Obs≈Çuga zwijania/rozwijania komentarzy
document.querySelectorAll('.toggle-comments').forEach(header => {
  // data-awaria-id w HTML ‚Üí dataset.awariaId (camelCase!)
  const awaria_id = header.dataset.awariaId;
  const container = document.querySelector(`.comments-container[data-awaria-id="${awaria_id}"]`);
  const icon = header.querySelector('.toggle-icon');
  
  // Sprawdzenie czy elementy istniejƒÖ
  if (!container || !icon) {
    console.warn('Missing elements for awaria_id:', awaria_id, { container: !!container, icon: !!icon });
    return;
  }
  
  // Domy≈õlnie - komentarze ZAMKNIƒòTE (zawsze)
  container.style.display = 'none';
  icon.style.transform = 'rotate(-90deg)';
  
  header.addEventListener('click', function() {
    const isHidden = container.style.display === 'none';
    container.style.display = isHidden ? 'block' : 'none';
    icon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
  });
});

// Obs≈Çuga dodawania komentarzy
document.querySelectorAll('.add-comment-form').forEach(form => {
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const awaria_id = this.dataset.awariaId;
    const input = this.querySelector('.comment-input');
    const komentarz = input.value.trim();
    const button = this.querySelector('.btn-add-comment');
    
    if (!komentarz) {
      showToast('Wpisz komentarz!', 'warning');
      return;
    }
    
    try {
      button.disabled = true;
      button.textContent = '‚è≥ Wysy≈Çanie...';
      
      const formData = new FormData();
      formData.append('komentarz', komentarz);
      
      const endpoint = `{{ url_for('quality.dur_zatwierdz_awariƒô', awaria_id=0) }}`.replace('/0', '/' + awaria_id);
      
      const response = await fetch(endpoint, {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        showToast('‚úì Komentarz dodany', 'success');
        input.value = '';
        button.textContent = 'üìù Dodaj';
        button.disabled = false;
        // Od≈õwie≈º stronƒô aby pokazaƒá nowy komentarz
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(`‚ùå ${data.message}`, 'error');
        button.textContent = 'üìù Dodaj';
        button.disabled = false;
      }
    } catch (error) {
      console.error('Error:', error);
      showToast(`‚ùå B≈ÇƒÖd: ${error.message}`, 'error');
      button.textContent = 'üìù Dodaj';
      button.disabled = false;
    }
  });
});

// Obs≈Çuga zmiany statusu w nag≈Ç√≥wku (select w g√≥rnym rogu)
document.querySelectorAll('.status-select-header').forEach(select => {
  select.addEventListener('change', async function(e) {
    e.preventDefault();
    const awaria_id = this.dataset.awariaId;
    const nowy_status = this.value;
    const old_value = this.dataset.old_value;
    
    try {
      const formData = new FormData();
      formData.append('status', nowy_status);
      
      const endpoint = `{{ url_for('quality.dur_zatwierdz_awariƒô', awaria_id=0) }}`.replace('/0', '/' + awaria_id);
      
      const response = await fetch(endpoint, {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        this.dataset.old_value = nowy_status;
        // Zmie≈Ñ kolor t≈Ça nag≈Ç√≥wka na podstawie nowego statusu
        const status_colors = {'zg≈Çoszone': '#e7f3ff', 'czeka_na_czesci': '#ffcccc', 'w_trakcie_naprawy': '#fff3cd', 'zako≈Ñczone': '#d4edda'};
        const header = this.closest('[style*="background"]');
        if (header) {
          header.style.background = status_colors[nowy_status] || '#f0f0f0';
        }
        
        // Poka≈º toast z dodatkowƒÖ informacjƒÖ dla zako≈Ñczone
        if (nowy_status === 'zako≈Ñczone') {
          showToast(`‚úì Status zmieniony na "‚úÖ Zako≈Ñczone" ‚Äî karta zostanie od≈õwie≈ºona`, 'success');
        } else {
          showToast(`‚úì Status zmieniony na "${nowy_status}"`, 'success');
        }
        
        setTimeout(() => location.reload(), 500);
      } else {
        showToast(`‚ùå ${data.message}`, 'error');
        this.value = old_value;
      }
    } catch (error) {
      console.error('Error:', error);
      showToast(`‚ùå B≈ÇƒÖd: ${error.message}`, 'error');
      this.value = old_value;
    }
  });
  select.dataset.old_value = select.value;
});
</script>
{% endblock %}
