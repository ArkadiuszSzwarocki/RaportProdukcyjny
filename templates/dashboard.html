{% extends "layout.html" %}

{% block content %}

<div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

    <div class="section-header">
    <div><h2 class="header-title">Hala Produkcyjna: <strong>{{ sekcja }}</strong></h2><p class="text-muted m-0">{{ rola|upper }} | {{ dzisiaj }}</p></div>
    <div class="d-flex gap-10">
        <button type="button" onclick="openModal('modalProblem')" class="btn btn-danger">‚ö†Ô∏è ZG≈ÅO≈ö</button>
        
        <a href="/?sekcja=Zasyp" class="btn {% if sekcja=='Zasyp' %}btn-primary{% else %}btn-outline{% endif %}">Zasyp</a>
        <a href="/?sekcja=Workowanie" class="btn {% if sekcja=='Workowanie' %}btn-primary{% else %}btn-outline{% endif %}">Workowanie</a>
        <a href="/?sekcja=Magazyn" class="btn {% if sekcja=='Magazyn' %}btn-primary{% else %}btn-outline{% endif %}">Magazyn</a>
    </div>
</div>

<div class="section-box d-flex align-center justify-between">
    <div class="d-flex align-center gap-10">
        <strong>üë• Obsada Linii:</strong>
        {% for o in obsada %}
            <div class="chip">
                {{ o[1] }}
                {% if rola in ['lider', 'admin', 'pracownik'] %}
                <form action="{{ url_for('api.usun_z_obsady', id=o[0]) }}" method="POST" class="m-0">
                    <button type="submit" class="btn-delete">&times;</button>
                </form>
                {% endif %}
            </div>
        {% else %}
            <span class="text-muted text-muted-italic">Brak przypisanych pracownik√≥w.</span>
        {% endfor %}
    </div>
    
    {% if rola in ['lider', 'admin', 'pracownik'] %}
    <form action="{{ url_for('api.dodaj_do_obsady') }}" method="POST" class="d-flex gap-5">
        <input type="hidden" name="sekcja" value="{{ sekcja }}">
        <select name="pracownik_id" required title="Wybierz pracownika" aria-label="Wybierz pracownika" class="input-sm">
            <option value="" disabled selected>+ Dodaj osobƒô</option>
            {% for p in pracownicy %}<option value="{{ p[0] }}">{{ p[1] }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn btn-start">OK</button>
    </form>
    {% endif %}
</div>

{% if sekcja == 'Magazyn' %}
    <div class="grid-2">
        <div class="stat-card"><span class="label">Przyjƒôto Netto</span><strong class="value text-success">{{ suma_wykonanie|int }} kg</strong></div>
        <div class="stat-card"><span class="label">Ilo≈õƒá Palet</span><strong class="value">{{ magazyn_palety|length }} szt.</strong></div>
    </div>
{% else %}
    <div class="grid-auto-fit">
        <div class="stat-card"><span class="label">Plan</span><strong class="value">{{ suma_plan|int }} kg</strong></div>
        <div class="stat-card"><span class="label">Wykonanie</span><strong class="value text-success">{{ suma_wykonanie|int }} kg</strong></div>
        <div class="stat-card"><span class="label">% Realizacji</span><strong class="value">{{ (suma_wykonanie/suma_plan*100)|int if suma_plan>0 else 0 }}%</strong></div>
    </div>
{% endif %}

{% if wpisy %}
<div class="mb-20">
    {% for w in wpisy[:2] %}
        <div class="alert-warning d-flex justify-between align-center mb-5">
            <span>‚ö†Ô∏è <strong>{{ w[3] }}</strong> [{{ w[5] }}]: {{ w[2] }}</span>
            {% if rola in ['lider', 'admin'] %}
                <div class="d-flex gap-8 align-center">
                    <a href="{{ url_for('api.edytuj', id=w[0]) }}" title="Edytuj wpis" class="font-bold text-warning-dark no-underline">‚úé</a>
                    <form action="{{ url_for('api.usun_wpis', id=w[0]) }}" method="POST" class="m-0">
                        <input type="hidden" name="sekcja" value="{{ sekcja }}">
                        <button type="submit" class="btn-icon text-warning-dark">‚úñ</button>
                    </form>
                </div>
            {% endif %}
        </div>
    {% endfor %}
</div>
{% endif %}

{% set ns = namespace(is_active=false) %}
{% for p in plan %}{% if p[3] == 'w toku' %}{% set ns.is_active = true %}{% endif %}{% endfor %}

    <div class="section-box p-0">
    <div class="p-15 p-15-bg">
        <h3 class="m-0 text-primary">üìã {% if sekcja=='Magazyn' %}Rejestr Przyjƒôƒá{% else %}Kolejka Produkcyjna{% endif %}</h3>
        <span class="badge-info">{{ sekcja|upper }}</span>
    </div>
    {% if rola == 'planista' and quality_count and quality_count > 0 %}
    <div class="alert-warning d-flex justify-between align-center mb-10">
        <div class="text-warning-dark font-bold">üîî SƒÖ {{ quality_count }} zg≈Çosze≈Ñ dezynfekcji od laboratorium ‚Äî sprawd≈∫ i dodaj do plan√≥w.</div>
        <div>
            <a href="{{ url_for('jakosc_index') }}" class="btn-action btn-warning">Przejd≈∫ do Jako≈õƒá</a>
        </div>
    </div>
    {% endif %}

    <table class="modern-table">
        <thead>
            <tr>
                <th>#</th><th>Produkt</th><th>Plan (kg)</th><th>Czas Pracy</th><th>Status</th><th>Realizacja</th><th class="text-right">Akcje</th>
            </tr>
        </thead>
        <tbody>
        {% for p in plan %}
            <tr class="row-{{ p[3]|replace(' ', '') }}">
                <td class="text-muted">{{ loop.index }}</td>
                <td><strong class="text-primary">{{ p[1] }}</strong><div class="small text-muted">{{ p[9]|upper }}</div></td>
                <td><strong>{{ p[2]|int }} kg</strong></td>
                <td class="small">
                    {% if p[4] %}<div class="text-success">Start: {{ p[4] }}</div>{% endif %}
                    {% if p[5] %}<div class="text-danger-color">Stop: {{ p[5] }}</div>{% endif %}
                </td>
                <td><span class="status-badge status-{{ p[3]|replace(' ', '') }}">{{ p[3]|upper }}</span></td>
                <td>
                    <strong class="{% if p[7] > 0 %}text-success{% else %}text-muted{% endif %}">{{ p[7]|int }} kg</strong>
                    {% if palety_mapa[p[0]] %}
                        <button type="button" onclick="toggleDetails({{ p[0] }})" class="btn-toggle ml-5">
                            üì¶ {{ palety_mapa[p[0]]|length }} szt. ‚ñº
                        </button>
                    {% endif %}
                    {# Przyciski przenoszenia do Jako≈õƒá usuniƒôte ‚Äî dezynfekcja planowana przez laboratorium i zg≈Çaszana plani≈õcie. #}
                </td>
                <td class="text-right">
                    {% if rola in ['lider', 'admin', 'pracownik'] and sekcja != 'Magazyn' %}
                        {% if p[3] == 'zaplanowane' %}
                            {% if ns.is_active %}<button type="button" disabled class="btn-action btn-disabled"><span class="material-icons">block</span></button>
                            {% else %}<form action="{{ url_for('api.start_zlecenie', id=p[0]) }}" method="POST"><input type="hidden" name="sekcja" value="{{ sekcja }}"><button type="submit" class="btn-action btn-start">START</button></form>{% endif %}
                        {% elif p[3] == 'w toku' %}
                            <div class="d-flex gap-5 justify-end">
                                {% if sekcja == 'Workowanie' %}<button type="button" onclick="openModal('paleta-{{ p[0] }}')" class="btn-action btn-purple">{% if p[9] == 'bigbag' %}+ BIGBAG{% else %}+ PALETA{% endif %}</button>{% endif %}
                                {% if sekcja == 'Zasyp' %}<button type="button" onclick="openModal('stop-zasyp-{{ p[0] }}')" class="btn-action btn-stop">STOP</button>
                                {% else %}<form action="{{ url_for('api.koniec_zlecenie', id=p[0]) }}" method="POST"><input type="hidden" name="sekcja" value="{{ sekcja }}"><button type="submit" class="btn-action btn-stop">STOP</button></form>{% endif %}
                            </div>
                            <div id="paleta-{{ p[0] }}" class="modal-popup">
                                <h4 class="m-0 text-zarzad">{% if p[9] == 'bigbag' %}üì¶ Nowy BigBag{% else %}üì¶ Nowa Paleta{% endif %}</h4>
                                <form action="{{ url_for('api.dodaj_palete', plan_id=p[0]) }}" method="POST" class="d-flex flex-column gap-10">
                                    <input type="hidden" name="sekcja" value="{{ sekcja }}"><input type="hidden" name="typ_produkcji" value="{{ p[9] }}">
                                    {% if p[9] == 'bigbag' %}<label>Waga Palety (TARA) [kg]:</label><input type="number" step="1" name="waga_palety" value="25" class="input-sm font-bold">
                                    {% else %}<label>Waga Produktu (Netto) [kg]:</label><input type="number" step="1" name="waga_palety" value="1000" class="input-sm font-bold">{% endif %}
                                    <div class="d-flex gap-10"><button type="submit" class="btn-action btn-save flex-1">DODAJ</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                </form>
                            </div>
                            <div id="stop-zasyp-{{ p[0] }}" class="modal-popup">
                                <h4 class="m-0 text-danger-color">üõë Zatrzymaj (Zasyp)</h4>
                                <form action="{{ url_for('api.koniec_zlecenie', id=p[0]) }}" method="POST" class="d-flex flex-column gap-10">
                                    <input type="hidden" name="sekcja" value="{{ sekcja }}"><label>Zu≈ºycie (kg):</label><input type="number" step="1" name="final_tonaz" value="{{ p[7]|int if p[7] else '' }}" required class="input-sm font-bold">
                                    <div class="d-flex gap-10"><button type="submit" class="btn-action btn-stop flex-1">ZATWIERD≈π</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                </form>
                            </div>
                        {% elif p[3] == 'zakonczone' %}
                                    <div class="d-flex align-center justify-end gap-10">
                                <span class="material-icons text-success">check_circle</span>
                                    {% if sekcja == 'Zasyp' and p[13] and not p[10] %}
                                    <button type="button" onclick="openModal('wyjasnij-{{ p[0] }}')" class="btn-action btn-stop btn-small pulse-animation">‚ö†Ô∏è WYJA≈öNIJ ({{ p[12]|int }} kg)</button>
                                    <div id="wyjasnij-{{ p[0] }}" class="modal-popup">
                                        <h4 class="m-0 text-danger-color">‚ö†Ô∏è Rozbie≈ºno≈õƒá Wagi</h4>
                                        <p class="small mb-15">Zasyp: <strong>{{ p[7]|int }} kg</strong><br>Workowanie: <strong>{{ p[11]|int }} kg</strong><br>R√≥≈ºnica: <strong class="text-danger-color">{{ p[12]|int }} kg</strong></p>
                                        <form action="{{ url_for('api.zapisz_wyjasnienie', id=p[0]) }}" method="POST" class="d-flex flex-column gap-10">
                                            <input type="hidden" name="sekcja" value="{{ sekcja }}">
                                            <textarea name="wyjasnienie" placeholder="Przyczyna..." required rows="3" class="input-sm"></textarea>
                                            <div class="d-flex gap-10"><button type="submit" class="btn-action btn-save flex-1">ZAPISZ</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                        </form>
                                    </div>
                                {% endif %}
                                {% if rola in ['lider', 'admin'] %}<form action="{{ url_for('api.przywroc_zlecenie', id=p[0]) }}" method="POST" onsubmit="return confirm('Wznowiƒá?');"><button type="submit" class="btn-action btn-outline-warning"><span class="material-icons">replay</span></button></form>{% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% if palety_mapa[p[0]] and (sekcja == 'Workowanie' or sekcja == 'Magazyn') %}
            <tr id="details-{{ p[0] }}" class="details-row">
                <td colspan="7" class="p-0">
                    <div class="p-10">
                        <table class="modern-table small">
                            <thead><tr><th>Nr</th><th>Godzina</th><th>Typ</th><th>Waga Netto</th><th>Opcje</th></tr></thead>
                            <tbody>
                                {% for pal in palety_mapa[p[0]] %}
                                <tr>
                                    <td>{{ loop.index }}</td><td>üïí {{ pal[1] }}</td><td><span class="small text-muted">{{ pal[4]|upper }}</span></td>
                                    <td>
                                        {% if sekcja == 'Magazyn' and pal[4] == 'bigbag' %}
                                            {% if pal[0] == 0 %}<button type="button" onclick="openModal('waga-{{ pal[2] }}')" class="btn-action btn-warning small">‚öñÔ∏è WA≈ªENIE</button>
                                            {% else %}<strong>{{ pal[0]|int }} kg</strong><button type="button" onclick="openModal('waga-{{ pal[2] }}')" class="btn-icon ml-5">‚úèÔ∏è</button>{% endif %}
                                            <div id="waga-{{ pal[2] }}" class="modal-popup">
                                                <h4 class="m-0">‚öñÔ∏è Wa≈ºenie BigBag</h4>
                                                <div class="mb-15 small">Tara palety: <strong>{{ pal[5]|int }} kg</strong></div>
                                                <form action="{{ url_for('api.wazenie_magazyn', paleta_id=pal[2]) }}" method="POST" class="d-flex flex-column gap-10">
                                                    <input type="hidden" name="sekcja" value="Magazyn"><input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                                                    <label>Waga BRUTTO (z paletƒÖ) [kg]:</label>
                                                    <input type="number" step="1" name="waga_brutto" value="{{ pal[6]|int if pal[6] > 0 else '' }}" placeholder="np. 1025" required class="input-sm font-bold" aria-label="Waga BRUTTO (kg)">
                                                    <div class="d-flex gap-10"><button type="submit" class="btn-action btn-save flex-1">ZAPISZ</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                                </form>
                                            </div>
                                        {% else %}<strong>{{ pal[0]|int }} kg</strong>{% endif %}
                                    </td>
                                    <td>{% if rola in ['lider', 'admin'] and sekcja == 'Workowanie' %}<form action="{{ url_for('api.usun_palete', id=pal[3]) }}" method="POST" onsubmit="return confirm('Usu≈Ñ?');"><button type="submit" class="btn-icon text-danger-color">‚ùå</button></form>{% endif %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endif %}
        {% else %}<tr><td colspan="7" class="text-center p-30">Brak danych.</td></tr>{% endfor %}
        </tbody>
    </table>
</div>

{% if rola in ['lider', 'admin'] %}

<div class="section-box border-left-zarzad">
    <h3 class="m-0 text-zarzad">üè• HR / Nieobecno≈õci i Nadgodziny</h3>
    <form action="{{ url_for('api.dodaj_obecnosc') }}" method="POST" class="form-flex mb-15">
        <select name="pracownik_id" required title="Wybierz pracownika" aria-label="Wybierz pracownika" class="input-sm font-bold">
            <option value="" disabled selected>-- Pracownik --</option>
            {% for p in wszyscy_pracownicy %}
            <option value="{{ p[0] }}">{{ p[1] }}</option>
            {% endfor %}
        </select>
        <select name="typ" required title="Typ wpisu" aria-label="Typ wpisu" class="input-sm">
            <option value="Nieobecno≈õƒá">L4 / Urlop (Nieobecno≈õƒá)</option>
            <option value="Nadgodziny">Nadgodziny</option>
            <option value="Inne">Inne</option>
        </select>
        <input type="number" step="0.5" name="godziny" placeholder="Ilo≈õƒá godzin" class="input-sm w-100px" aria-label="Ilo≈õƒá godzin">
        <input type="text" name="komentarz" placeholder="Komentarz (opcjonalnie)" class="input-sm flex-1" aria-label="Komentarz (opcjonalnie)">
        <button type="submit" class="btn-action btn-purple">ZAPISZ</button>
    </form>

    <table class="modern-table small">
        <thead><tr><th>Pracownik</th><th>Typ</th><th>Godziny</th><th>Komentarz</th><th>Opcje</th></tr></thead>
        <tbody>
            {% for r in raporty_hr %}
            <tr>
                <td><strong>{{ r[1] }}</strong></td>
                <td><span class="badge-info badge-purple">{{ r[2] }}</span></td>
                <td>{{ r[3] }} h</td>
                <td>{{ r[4] }}</td>
                <td><form action="{{ url_for('api.usun_obecnosc', id=r[0]) }}" method="POST"><button type="submit" class="btn-icon text-danger-color">‚ùå</button></form></td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="text-center text-muted">Brak wpis√≥w HR dzisiaj.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="section-box mb-30 bg-dark text-white p-20">
    <h3 class="m-0 text-light bb-light">üìù Raport Ko≈Ñcowy Lidera</h3>
    <form action="{{ url_for('zamknij_zmiane') }}" method="POST">
        <label class="form-label">Notatki / Uwagi do zmiany:</label>
        <textarea name="uwagi_lidera" rows="4" class="input-sm mb-15" placeholder="Wpisz podsumowanie zmiany, problemy, uwagi dla nastƒôpnej zmiany..."></textarea>
        
        <div class="d-flex justify-between align-center">
            <div class="small text-muted">* Klikniƒôcie zako≈Ñczy wszystkie aktywne zlecenia.</div>
            <button type="submit" class="btn-warning font-bold" onclick="return confirm('Czy na pewno chcesz zamknƒÖƒá zmianƒô i wys≈Çaƒá raport?')">üìß WY≈öLIJ RAPORT I ZAMKNIJ ZMIANƒò</button>
        </div>
    </form>
</div>

{% endif %}

<div id="modalProblem" class="modal-popup hidden">
    <h3 class="m-0 text-warning">‚ö†Ô∏è Zg≈Ço≈õ Problem / Przest√≥j</h3>
    <form action="{{ url_for('api.dodaj_wpis') }}" method="POST" class="d-flex flex-column gap-15">
        <input type="hidden" name="sekcja" value="{{ sekcja }}"><input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
        
        <label>Typ Zdarzenia:</label>
        <select name="kategoria" required title="Kategoria zdarzenia" aria-label="Kategoria zdarzenia" class="input-sm font-bold">
            <option value="" disabled selected>-- Wybierz --</option>
            <option value="Przezbrojenie">‚öôÔ∏è Przezbrojenie</option>
            <option value="Awaria">üõë Awaria Maszyny</option>
            <option value="Brak Surowca">üì¶ Brak Surowca</option>
            <option value="Przerwa">‚òï Przerwa</option>
            <option value="Inne">üìù Inne</option>
        </select>
        
        <label>Czas WystƒÖpienia:</label>
        <input type="time" name="czas_start" value="{{ now_time }}" class="input-sm" aria-label="Czas wystƒÖpienia">
        
        <label>Opis (opcjonalnie):</label>
        <textarea name="problem" placeholder="Co siƒô sta≈Ço?" rows="3" class="input-sm"></textarea>
        
        <div class="d-flex gap-10">
            <button type="submit" class="btn-action btn-warning flex-1">ZG≈ÅO≈ö</button>
            <button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button>
        </div>
    </form>
</div>

<script>
    function toggleDetails(id) { var row = document.getElementById('details-' + id); var hidden = getComputedStyle(row).display === 'none'; row.style.display = hidden ? 'table-row' : 'none'; }
    function openModal(id) { document.getElementById('modalOverlay').style.display = 'block'; document.getElementById(id).style.display = 'flex'; }
    function closeAllModals() { document.getElementById('modalOverlay').style.display = 'none'; document.querySelectorAll('.modal-popup').forEach(el => el.style.display = 'none'); }
    let idleTime = 0; document.addEventListener('mousemove', () => idleTime = 0); document.addEventListener('keypress', () => idleTime = 0);
    setInterval(() => { idleTime++; if (idleTime >= 15 && document.getElementById('modalOverlay').style.display === 'none') { window.location.reload(); } }, 1000);
</script>

<!-- moved CSS to static/style.css -->

{% endblock %}