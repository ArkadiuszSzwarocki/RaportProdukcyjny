{% extends "layout.html" %}

{% block content %}

<div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

    <div class="section-header">
    <div><h2 class="header-title">Hala Produkcyjna: <strong>{{ sekcja }}</strong></h2><p class="text-muted m-0">{{ rola|upper }} | {{ dzisiaj }}</p></div>
    <div class="d-flex gap-10">
    </div>
</div>

<div class="section-box d-flex align-center justify-between">
    <div class="d-flex align-center gap-10">
        <strong>üë• Obsada Linii:</strong>
        {% for o in obsada %}
            <div class="chip">
                {{ o[1] }}
                {% if rola in ['lider', 'admin', 'pracownik'] %}
                <form action="{{ url_for('api.usun_z_obsady', id=o[0]) }}" method="POST" class="m-0">
                    <button type="submit" class="btn-delete" aria-label="Usu≈Ñ z obsady">&times;</button>
                </form>
                {% endif %}
            </div>
        {% else %}
            <span class="text-muted text-muted-italic">Brak przypisanych pracownik√≥w.</span>
        {% endfor %}
    </div>
    
    {% if rola in ['lider', 'admin', 'pracownik'] %}
    <form action="{{ url_for('api.dodaj_do_obsady') }}" method="POST" class="d-flex gap-5">
        <input type="hidden" name="sekcja" value="{{ sekcja }}">
        <select name="pracownik_id" required title="Wybierz pracownika" aria-label="Wybierz pracownika" class="input-sm">
            <option value="" disabled selected>+ Dodaj osobƒô</option>
            {% for p in pracownicy %}<option value="{{ p[0] }}">{{ p[1] }}</option>{% endfor %}
        </select>
        <button type="submit" class="btn btn-start">OK</button>
    </form>
    {% endif %}
</div>

{% if sekcja == 'Magazyn' %}
    <div class="grid-2">
        <div class="stat-card"><span class="label">Przyjƒôto Netto</span><strong class="value text-success">{{ suma_wykonanie|int }} kg</strong></div>
        <div class="stat-card"><span class="label">Ilo≈õƒá Palet</span><strong class="value">{{ magazyn_palety|length }} szt.</strong></div>
    </div>
    <div class="section-box mb-10">
        <h4 class="m-0">üì¶ Palety do Zatwierdzenia</h4>
        <div class="mt-10">
                    {% if unconfirmed_palety and unconfirmed_palety|length > 0 %}
                        <table class="modern-table small">
                            <thead>
                                <tr>
                                    <th>Nr</th>
                                    <th>üìã Produkt</th>
                                    <th>‚öñÔ∏è Waga</th>
                                    <th>üïí Dodana</th>
                                    <th>‚è±Ô∏è Czas</th>
                                    <th>‚úÖ Akcja</th>
                                </tr>
                            </thead>
                            <tbody>
                        {% for p in unconfirmed_palety %}
                            <tr>
                                <td class="text-muted font-bold">{{ p[4] if p[4] is not none else p[0] }}</td>
                                <td><strong class="text-primary">{{ p[1] }}</strong></td>
                                <td><strong class="text-success">{{ p[2] }}</strong></td>
                                <td class="time-display">{{ p[3] }}</td>
                                <td><span class="paleta-elapsed duration-badge" data-start="{{ p[3] }}">{% if p[5] %}{{ p[5] }}{% else %}-{% endif %}</span></td>
                                <td>
                                    <form action="{{ url_for('api.potwierdz_palete', paleta_id=p[0]) }}" method="POST" class="confirm-paleta-form inline-form">
                                        <input type="hidden" name="sekcja" value="{{ sekcja }}">
                                        <button type="submit" class="btn-action btn-success btn-small">Zatwierd≈∫</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="text-muted text-center p-10">Brak palet oczekujƒÖcych na zatwierdzenie.</div>
                    {% endif %}
        </div>
    </div>
    {% if rola in ['lider', 'admin'] %}
    <!-- Przycisk wysy≈Çania przypomnie≈Ñ usuniƒôty. Potwierdzanie palet odbywa siƒô przez sekcjƒô 'Zatwierd≈∫' w Magazyn. -->
    {% endif %}
{% else %}
    <div class="grid-auto-fit">
        <div class="stat-card"><span class="label">Plan</span><strong class="value">{{ suma_plan|int }} kg</strong></div>
        <div class="stat-card"><span class="label">Wykonanie</span><strong class="value text-success">{{ suma_wykonanie|int }} kg</strong></div>
        <div class="stat-card"><span class="label">% Realizacja</span><strong class="value">{{ (suma_wykonanie/suma_plan*100)|int if suma_plan>0 else 0 }}%</strong></div>
    </div>
{% endif %}

{% if wpisy %}
<div class="mb-20">
    {% for w in wpisy[:2] %}
        <div class="alert-warning d-flex justify-between align-center mb-5">
            <div>
                <span>‚ö†Ô∏è <strong>{{ w[3] }}</strong> [{{ w[5] }}]: {{ w[2] }}</span>
                <div class="small text-muted">od {{ w[3] }}{% if w[4] %} ‚Äî do {{ w[4] }}{% endif %}</div>
            </div>
            {% if rola in ['lider', 'admin'] %}
                <div class="d-flex gap-8 align-center">
                    <a href="{{ url_for('api.edytuj', id=w[0]) }}" title="Edytuj wpis" class="font-bold text-warning-dark no-underline">‚úé</a>
                    <form action="{{ url_for('api.usun_wpis', id=w[0]) }}" method="POST" class="m-0">
                        <input type="hidden" name="sekcja" value="{{ sekcja }}">
                        <button type="submit" class="btn-icon text-warning-dark" aria-label="Usu≈Ñ wpis">‚úñ</button>
                    </form>
                </div>
            {% endif %}
        </div>
    {% endfor %}
</div>
{% endif %}

{% set ns = namespace(is_active=false) %}
{% for p in plan %}{% if p[3] == 'w toku' %}{% set ns.is_active = true %}{% endif %}{% endfor %}

{# Defensive: prefer server-provided `hr_pracownicy`; fallback to full lists if not provided #}
{% if hr_pracownicy is not defined %}
    {% if wszyscy_pracownicy is defined %}
        {% set hr_pracownicy = wszyscy_pracownicy %}
    {% else %}
        {% set hr_pracownicy = pracownicy %}
    {% endif %}
{% endif %}

    <div class="section-box p-0">
    <div class="p-15 p-15-bg">
        <h3 class="m-0 text-primary">üìã {% if sekcja=='Magazyn' %}Rejestr Przyjƒôƒá{% else %}Kolejka Produkcyjna{% endif %}</h3>
        <span class="badge-info">{{ sekcja|upper }}</span>
    </div>
    {% if rola == 'planista' and quality_count and quality_count > 0 %}
    <div class="alert-warning d-flex justify-between align-center mb-10">
        <div class="text-warning-dark font-bold">üîî SƒÖ {{ quality_count }} zg≈Çosze≈Ñ dezynfekcji od laboratorium ‚Äî sprawd≈∫ i dodaj do plan√≥w.</div>
        <div>
            <a href="{{ url_for('jakosc_index') }}" class="btn-action btn-warning">Przejd≈∫ do Jako≈õƒá</a>
        </div>
    </div>
    {% endif %}
        

    <table class="modern-table">
        <thead>
            <tr>
                <th>#</th><th>üì¶ Produkt</th><th>üìã Plan</th><th>üïí Czas Pracy</th><th>üìä Status</th><th>‚úÖ Realizacja</th><th class="text-right">‚öôÔ∏è Akcje</th>
            </tr>
        </thead>
        <tbody>
        {% for p in plan %}
            <tr class="row-{{ p[3]|replace(' ', '') }}">
                <td class="text-muted font-bold">{{ loop.index }}</td>
                <td>
                    <strong class="text-primary">{{ p[1] }}</strong>
                    <div class="small badge-sekcja">{{ p[9]|upper }}</div>
                </td>
                <td>
                    <strong class="text-success">{{ p[2]|int }} kg</strong>
                </td>
                <td class="small">
                    {% if p[4] %}<div class="time-display">üü¢ {{ p[4] }}</div>{% endif %}
                    {% if p[5] %}<div class="time-display text-danger-color">üî¥ {{ p[5] }}</div>{% endif %}
                    {% if p[6] is not none and p[6] > 0 %}
                        {% set mins = p[6] %}
                        {% set h = (mins // 60) %}
                        {% set m = mins % 60 %}
                        <div class="duration-badge">‚è±Ô∏è {% if h > 0 %}{{ h }}h {% endif %}{{ m }}m</div>
                    {% endif %}
                </td>
                <td><span class="status-badge status-{{ p[3]|replace(' ', '') }}">{{ p[3]|upper }}</span></td>
                <td>
                    <strong class="{% if p[7] > 0 %}text-success{% else %}text-muted{% endif %}">{{ p[7]|int }} kg</strong>
                    {% if palety_mapa[p[0]] %}
                        <button type="button" onclick="toggleDetails('{{ p[0] }}')" class="btn-toggle ml-5">
                            üì¶ {{ palety_mapa[p[0]]|length }} szt. ‚ñº
                        </button>
                    {% endif %}
                    {# Przyciski przenoszenia do Jako≈õƒá usuniƒôte ‚Äî dezynfekcja planowana przez laboratorium i zg≈Çaszana plani≈õcie. #}
                </td>
                <td class="text-right">
                    {% if rola in ['lider', 'admin', 'pracownik'] and sekcja != 'Magazyn' %}
                        {% if p[3] == 'zaplanowane' %}
                            {% if ns.is_active %}<button type="button" disabled class="btn-action btn-disabled" aria-label="Zablokowane"><span class="material-icons">block</span></button>
                            {% else %}<form action="{{ url_for('api.start_zlecenie', id=p[0]) }}" method="POST"><input type="hidden" name="sekcja" value="{{ sekcja }}"><button type="submit" class="btn-action btn-start">START</button></form>{% endif %}
                        {% elif p[3] == 'w toku' %}
                            <div class="d-flex gap-5 justify-end">
                                {% if sekcja == 'Workowanie' %}
                                    <button type="button" onclick="openModal('paleta-{{ p[0] }}')" class="btn-action btn-purple">{% if p[9] == 'bigbag' %}+ BIGBAG{% else %}+ PALETA{% endif %}</button>
                                {% endif %}
                                {% if sekcja == 'Zasyp' %}
                                    <button type="button" onclick="openModal('szarza-{{ p[0] }}')" class="btn-action btn-green">+ SZAR≈ªA</button>
                                    <button type="button" onclick="openModal('stop-zasyp-{{ p[0] }}')" class="btn-action btn-stop">STOP</button>
                                {% else %}
                                    <form action="{{ url_for('api.koniec_zlecenie', id=p[0]) }}" method="POST"><input type="hidden" name="sekcja" value="{{ sekcja }}"><button type="submit" class="btn-action btn-stop">STOP</button></form>
                                {% endif %}
                            </div>
                            <div id="paleta-{{ p[0] }}" class="modal-popup">
                                <h4 class="m-0 text-zarzad">{% if p[9] == 'bigbag' %}üì¶ Nowy BigBag{% else %}üì¶ Nowa Paleta{% endif %}</h4>
                                <form action="{{ url_for('api.dodaj_palete', plan_id=p[0]) }}" method="POST" class="d-flex flex-column gap-10">
                                    <input type="hidden" name="sekcja" value="{{ sekcja }}"><input type="hidden" name="typ_produkcji" value="{{ p[9] }}">
                                    {% if p[9] == 'bigbag' %}<label>Waga Palety (TARA) [kg]:</label><input type="number" step="1" name="waga_palety" value="25" class="input-sm font-bold" aria-label="Waga palety (TARA) [kg]">
                                    {% else %}<label>Waga Produktu (Netto) [kg]:</label><input type="number" step="1" name="waga_palety" value="1000" class="input-sm font-bold" aria-label="Waga produktu (Netto) [kg]">{% endif %}
                                    <div class="d-flex gap-10"><button type="submit" class="btn-action btn-save flex-1">DODAJ</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                </form>
                            </div>
                                <div id="szarza-{{ p[0] }}" class="modal-popup">
                                    <h4 class="m-0 text-zarzad">üì¶ Nowa Szar≈ºa (Zasyp)</h4>
                                    <form action="{{ url_for('api.dodaj_palete', plan_id=p[0]) }}" method="POST" class="d-flex flex-column gap-10">
                                        <input type="hidden" name="sekcja" value="Zasyp">
                                        <input type="hidden" name="typ_produkcji" value="{{ p[9] }}">
                                        <label>Waga Szar≈ºy (Netto) [kg]:</label>
                                        <input type="number" step="1" name="waga_palety" value="1000" class="input-sm font-bold" aria-label="Waga szar≈ºy (Netto) [kg]">
                                        <div class="d-flex gap-10"><button type="submit" class="btn-action btn-save flex-1">DODAJ</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                    </form>
                                </div>
                            <div id="stop-zasyp-{{ p[0] }}" class="modal-popup">
                                <h4 class="m-0 text-danger-color">üõë Zatrzymaj (Zasyp)</h4>
                                <form action="{{ url_for('api.koniec_zlecenie', id=p[0]) }}" method="POST" class="d-flex flex-column gap-10">
                                    <input type="hidden" name="sekcja" value="{{ sekcja }}"><label>Zu≈ºycie (kg):</label><input type="number" step="1" name="final_tonaz" value="{{ p[7]|int if p[7] else '' }}" required class="input-sm font-bold" aria-label="Zu≈ºycie (kg)">
                                    <div class="d-flex gap-10"><button type="submit" class="btn-action btn-stop flex-1">ZATWIERD≈π</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                </form>
                            </div>
                            {% if sekcja != 'Zasyp' %}
                            <div id="stop-{{ p[0] }}" class="modal-popup">
                                <h4 class="m-0 text-danger-color">üõë Zatrzymaj</h4>
                                <form action="{{ url_for('api.koniec_zlecenie', id=p[0]) }}" method="POST" class="d-flex flex-column gap-10">
                                    <input type="hidden" name="sekcja" value="{{ sekcja }}"><label>Zu≈ºycie (kg):</label><input type="number" step="1" name="final_tonaz" value="{{ p[7]|int if p[7] else '' }}" required class="input-sm font-bold" aria-label="Zu≈ºycie (kg)">
                                    <div class="d-flex gap-10"><button type="submit" class="btn-action btn-stop flex-1">ZATWIERD≈π</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                </form>
                            </div>
                            {% endif %}
                        {% elif p[3] == 'zakonczone' %}
                                    <div class="d-flex align-center justify-end gap-10">
                                <span class="material-icons text-success">check_circle</span>
                                    {% if sekcja == 'Zasyp' and p[13] and not p[10] %}
                                    <button type="button" onclick="openModal('wyjasnij-{{ p[0] }}')" class="btn-action btn-stop btn-small pulse-animation">‚ö†Ô∏è WYJA≈öNIJ ({{ p[12]|int }} kg)</button>
                                    <div id="wyjasnij-{{ p[0] }}" class="modal-popup">
                                        <h4 class="m-0 text-danger-color">‚ö†Ô∏è Rozbie≈ºno≈õƒá Wagi</h4>
                                        <p class="small mb-15">Zasyp: <strong>{{ p[7]|int }} kg</strong><br>Workowanie: <strong>{{ p[11]|int }} kg</strong><br>R√≥≈ºnica: <strong class="text-danger-color">{{ p[12]|int }} kg</strong></p>
                                        <form action="{{ url_for('api.zapisz_wyjasnienie', id=p[0]) }}" method="POST" class="d-flex flex-column gap-10">
                                            <input type="hidden" name="sekcja" value="{{ sekcja }}">
                                            <textarea name="wyjasnienie" placeholder="Przyczyna..." required rows="3" class="input-sm"></textarea>
                                            <div class="d-flex gap-10"><button type="submit" class="btn-action btn-save flex-1">ZAPISZ</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                        </form>
                                    </div>
                                {% endif %}
                                {% if rola in ['lider', 'admin'] %}<form action="{{ url_for('api.przywroc_zlecenie', id=p[0]) }}" method="POST" onsubmit="return confirm('Wznowiƒá?');"><button type="submit" class="btn-action btn-outline-warning" aria-label="Przywr√≥ƒá zlecenie"><span class="material-icons">replay</span></button></form>{% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% if palety_mapa[p[0]] and (sekcja == 'Workowanie' or sekcja == 'Magazyn' or sekcja == 'Zasyp') %}
            <tr id="details-{{ p[0] }}" class="details-row">
                <td colspan="7" class="p-0">
                    <div class="p-10">
                        <table class="modern-table small">
                            <thead><tr><th>Nr</th><th>üïí Godzina</th><th>Typ</th><th>Waga</th><th>‚è±Ô∏è Czas</th><th>Opcje</th></tr></thead>
                            <tbody>
                                {% for pal in palety_mapa[p[0]] %}
                                <tr>
                                    <td class="text-muted font-bold">{{ loop.index }}</td>
                                    <td class="time-display"><span>{{ pal[1] }}</span></td>
                                    <td><span class="badge-sekcja">{{ pal[4]|upper }}</span></td>
                                    <td>
                                        {% if sekcja == 'Magazyn' and pal[4] == 'bigbag' %}
                                            {% if pal[0] == 0 %}<button type="button" onclick="openModal('waga-{{ pal[2] }}')" class="btn-action btn-warning small">‚öñÔ∏è WA≈ªENIE</button>
                                            {% else %}<strong class="text-success">{{ pal[0]|int }} kg</strong><button type="button" onclick="openModal('waga-{{ pal[2] }}')" class="btn-icon ml-5" aria-label="Edytuj wagƒô">‚úèÔ∏è</button>{% endif %}
                                            <div id="waga-{{ pal[2] }}" class="modal-popup">
                                                <h4 class="m-0">‚öñÔ∏è Wa≈ºenie BigBag</h4>
                                                <div class="mb-15 small">Tara palety: <strong>{{ pal[5]|int }} kg</strong></div>
                                                <form action="{{ url_for('api.wazenie_magazyn', paleta_id=pal[2]) }}" method="POST" class="d-flex flex-column gap-10">
                                                    <input type="hidden" name="sekcja" value="Magazyn"><input type="hidden" name="data_powrotu" value="{{ dzisiaj }}">
                                                    <label>Waga BRUTTO (z paletƒÖ) [kg]:</label>
                                                    <input type="number" step="1" name="waga_brutto" value="{{ pal[6]|int if pal[6] > 0 else '' }}" placeholder="np. 1025" required class="input-sm font-bold" aria-label="Waga BRUTTO (kg)">
                                                    <div class="d-flex gap-10"><button type="submit" class="btn-action btn-save flex-1">ZAPISZ</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                                </form>
                                            </div>
                                        {% else %}<strong class="text-primary">{{ pal[0]|int }} kg</strong>{% endif %}
                                    </td>
                                    <td>
                                        <span class="paleta-elapsed duration-badge" data-start="{{ pal[9] }}"></span>
                                    </td>
                                    <td>
                                        {% if pal[7] and pal[7] != '' %}
                                            {% if pal[7] == 'do_przyjecia' %}
                                                <span class="badge badge-warning">üîÑ Do przyjƒôcia</span>
                                            {% elif pal[7] == 'przyjeta' %}
                                                <span class="badge badge-success">‚úÖ Przyjƒôta</span>
                                            {% elif pal[7] == 'zamknieta' %}
                                                <span class="badge badge-secondary">üîí Zamkniƒôta</span>
                                            {% else %}
                                                <span class="badge">{{ pal[7] }}</span>
                                            {% endif %}
                                        {% endif %}
                                        {% if rola in ['lider', 'admin'] %}
                                            <button type="button" onclick="openModal('editpal-{{ pal[2] }}')" class="btn-icon" aria-label="Edytuj paletƒô">‚úèÔ∏è</button>
                                            <button type="button" onclick="openModal('confirm-delete-{{ pal[2] }}')" class="btn-icon text-danger-color" aria-label="Usu≈Ñ paletƒô">üóëÔ∏è</button>
                                        {% endif %}
                                        {% if sekcja == 'Magazyn' and (rola == 'magazynier' or rola in ['lider','admin']) and pal[7] == 'do_przyjecia' %}
                                            <form action="{{ url_for('api.potwierdz_palete', paleta_id=pal[2]) }}" method="POST" class="inline-form" style="display:inline-block; margin-left:8px;">
                                                <input type="hidden" name="sekcja" value="{{ sekcja }}">
                                                <button type="submit" class="btn-action btn-save btn-small">Potwierd≈∫</button>
                                            </form>
                                        {% endif %}
                                    <div id="editpal-{{ pal[2] }}" class="modal-popup">
                                        <h4 class="m-0">‚úèÔ∏è Edytuj paletƒô</h4>
                                        <form action="{{ url_for('api.edytuj_palete', paleta_id=pal[2]) }}" method="POST" class="d-flex flex-column gap-10">
                                            <label>Waga (Netto) [kg]:</label>
                                            <input type="number" step="1" name="waga_palety" value="{{ pal[0]|int if pal[0] else '' }}" required class="input-sm font-bold" aria-label="Waga (kg)">
                                            <div class="d-flex gap-10"><button type="submit" class="btn-action btn-save flex-1">ZAPISZ</button><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
                                        </form>
                                    </div>
                                    <div id="confirm-delete-{{ pal[2] }}" class="modal-popup">
                                        <h4 class="m-0">üóëÔ∏è Usu≈Ñ paletƒô</h4>
                                        <p class="mb-15">Czy na pewno chcesz usunƒÖƒá tƒô paletƒô?</p>
                                        <div class="d-flex gap-10">
                                            <form action="{{ url_for('api.usun_palete', id=pal[2]) }}" method="POST" class="flex-1">
                                                <button type="submit" class="btn-action btn-danger flex-1">üóëÔ∏è Usu≈Ñ</button>
                                            </form>
                                            <button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">Anuluj</button>
                                        </div>
                                    </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endif %}
        {% else %}<tr><td colspan="7" class="text-center p-30">Brak danych.</td></tr>{% endfor %}
        </tbody>
    </table>
</div>

    {# HR, Nadgodziny i Raport Ko≈Ñcowy usuniƒôte z tego widoku ‚Äî przeniesione do dashboard_global.html #}

<script>
    function toggleDetails(id) { var row = document.getElementById('details-' + id); var hidden = getComputedStyle(row).display === 'none'; row.style.display = hidden ? 'table-row' : 'none'; }
    function openModal(id) { 
        console.log('[debug] openModal called for id=', id);
        try { console.trace(); } catch(e){}
        try{
            // Telemetry: detailed trace for STOP modals
            if (id && id.startsWith && id.startsWith('stop')){
                try{
                    console.log('[stop-trace] openModal for', id);
                    console.trace('[stop-trace] call stack for openModal');
                    var payload = {id: id, stack: (new Error()).stack || null, url: location.href};
                    if (navigator.sendBeacon){
                        try{ navigator.sendBeacon('/telemetry/openmodal', JSON.stringify(payload)); }catch(e){}
                    } else {
                        try{ fetch('/telemetry/openmodal', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload), keepalive:true}).catch(()=>{}); }catch(e){}
                    }
                }catch(e){}
            }
            // NOTE: suppression removed ‚Äî use AJAX submit to avoid accidental overlay click interception
        }catch(e){}
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById(id).style.display = 'flex';
    }
    function closeAllModals() { document.getElementById('modalOverlay').style.display = 'none'; document.querySelectorAll('.modal-popup').forEach(el => el.style.display = 'none'); }
    let idleTime = 0; document.addEventListener('mousemove', () => idleTime = 0); document.addEventListener('keypress', () => idleTime = 0);
    setInterval(() => { idleTime++; if (idleTime >= 15 && document.getElementById('modalOverlay').style.display === 'none') { window.location.reload(); } }, 1000);
    // Ensure all modals are hidden by default on initial load
    try{ closeAllModals(); }catch(e){}
</script>

<script>
// Live elapsed timers for unconfirmed palety
function formatElapsed(secs){
    if(secs < 0) secs = 0;
    const h = Math.floor(secs/3600);
    const m = Math.floor((secs%3600)/60);
    const s = secs%60;
    if(h>0) return h+"h "+String(m).padStart(2,'0')+"m";
    if(m>0) return m+"m "+String(s).padStart(2,'0')+"s";
    return s+"s";
}
function updatePaletaTimers(){
    document.querySelectorAll('.paleta-elapsed').forEach(function(el){
        const ds = el.getAttribute('data-start');
        if(!ds) return;
        // parse 'YYYY-MM-DD HH:MM:SS' by replacing space with 'T'
        let t = ds.replace(' ', 'T');
        // If no timezone, Date.parse treats as local in most browsers
        const start = Date.parse(t);
        if(isNaN(start)) return;
        const now = Date.now();
        const secs = Math.floor((now - start)/1000);
        el.textContent = '‚è±Ô∏è ' + formatElapsed(secs);
    });
}
document.addEventListener('DOMContentLoaded', function(){ updatePaletaTimers(); setInterval(updatePaletaTimers, 1000); });
</script>

<!-- Przypomnienia usuniƒôte: funkcja remind_unconfirmed_palety zostaje, ale nie ma przycisku w UI. -->

<!-- moved CSS to static/style.css -->
<script>
// AJAX approve/reject for dashboard wnioski_pending
document.addEventListener('DOMContentLoaded', function(){
    // showToast() provided by static/js/toasts.js

    var forms = document.querySelectorAll('.wn-form');
    forms.forEach(function(f){
        f.addEventListener('submit', function(e){
            e.preventDefault();
            var url = f.getAttribute('action');
            var row = f.closest('tr');
            var btn = f.querySelector('.wn-btn'); if(btn) btn.disabled = true;
            fetch(url, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest', 'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams()})
            .then(function(r){ try{ return r.json(); }catch(e){ return {}; } })
            .then(function(j){
                if(j && j.success){ if(row) row.remove(); showToast(j.message || 'Wniosek przetworzony', 'success'); }
                else { showToast((j && j.message) ? j.message : 'B≈ÇƒÖd', 'danger'); if(btn) btn.disabled = false; }
            }).catch(function(err){ console.error(err); showToast('B≈ÇƒÖd sieci', 'danger'); if(btn) btn.disabled = false; });
        });
    });
});
</script>

{% endblock %}

{% if sekcja == 'Magazyn' %}
<style>
#unconfirmed-modal { display: none; flex-direction: column; max-width: 700px; }
</style>
<div id="unconfirmed-modal" class="modal-popup">
    <h4 class="m-0 text-danger-color">‚ùó Palety do zatwierdzenia</h4>
    <div id="unconfirmed-list" class="mb-15 small"></div>
    <div class="d-flex gap-10"><button type="button" onclick="closeAllModals()" class="btn-action btn-cancel flex-1">ANULUJ</button></div>
</div>

<script id="unconfirmed-data" type="application/json">{{ (unconfirmed_palety|default([])) | tojson }}</script>
<script>
(function(){
    var unconfirmed = [];
    try {
        var el = document.getElementById('unconfirmed-data');
        if (el && el.textContent) { unconfirmed = JSON.parse(el.textContent || '[]'); }
    } catch(e) { console.error('Failed to parse unconfirmed data', e); unconfirmed = []; }
    try{
        if (unconfirmed && unconfirmed.length){
            var now = Date.now();
            var overdue = unconfirmed.filter(function(p){
                var t = Date.parse(p[3]);
                return !isNaN(t) && (now - t) > 10*60*1000; // 10 minut
            });
            if (overdue.length){
                var list = document.getElementById('unconfirmed-list');
                overdue.forEach(function(p){
                    var el = document.createElement('div');
                    el.className = 'mb-5';
                    var txt = document.createElement('span');
                    txt.textContent = 'Paleta #' + p[0] + ' (plan ' + p[1] + ' - ' + p[2] + ') dodana: ' + p[3];
                    el.appendChild(txt);
                    var form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/api/potwierdz_palete/' + p[0];
                    form.style.display = 'inline-block';
                    form.style.marginLeft = '8px';
                    var btn = document.createElement('button');
                    btn.type = 'submit';
                    btn.className = 'btn-action btn-success';
                    btn.textContent = 'Zatwierdzam paletƒô';
                    form.appendChild(btn);
                    el.appendChild(form);
                    if (list) list.appendChild(el);
                });
                openModal('unconfirmed-modal');
            }
        }
    }catch(e){console.error(e)}
})();
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function(){
    // Disable submit button after first click for dodawanie palet (prevent double-add)
    document.querySelectorAll('form[action*="/api/dodaj_palete"]').forEach(function(f){
        f.addEventListener('submit', function(e){
            var btn = f.querySelector('button[type="submit"]');
            if(btn){ btn.disabled = true; btn.classList.add('btn-disabled'); }
        });
    });
    // Toast helper
    var toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    toastContainer.style.position = 'fixed';
    toastContainer.style.right = '20px';
    toastContainer.style.top = '20px';
    toastContainer.style.zIndex = 9999;
    document.body.appendChild(toastContainer);
    function showToast(msg, type){
        var t = document.createElement('div');
        t.className = 'toast ' + (type||'');
        t.style.background = (type=='success')? '#2ecc71' : (type=='error'? '#e74c3c' : '#333');
        t.style.color = '#fff';
        t.style.padding = '10px 14px';
        t.style.marginTop = '8px';
        t.style.borderRadius = '4px';
        t.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
        t.textContent = msg;
        toastContainer.appendChild(t);
        setTimeout(function(){ t.style.opacity = '0'; setTimeout(function(){ t.remove(); }, 300); }, 3500);
    }

    // Intercept potwierdz_palete forms and send via fetch with retry/backoff; remove tile on success
    // Use event delegation to handle forms added dynamically
    document.addEventListener('submit', function(e){
        var form = e.target;
        if (!form.classList.contains('confirm-paleta-form')) return;
        
        console.log('[DEBUG] confirm-paleta-form submit intercepted (event delegation)');
        e.preventDefault();
        var btn = form.querySelector('button[type="submit"]');
        if(btn){ btn.disabled = true; }
        var attempts = 0;
        var maxAttempts = 3;
        function doFetch(){
            attempts++;
            fetch(form.action, { method: 'POST', credentials: 'same-origin', headers: {'X-Requested-With':'XMLHttpRequest'} })
                .then(function(res){
                    if(res.ok){
                        console.log('[DEBUG] potwierdz_palete success');
                        showToast('Potwierdzono paletƒô', 'success');
                        var li = form.closest('li');
                        if(li) {
                            console.log('[DEBUG] removing <li> element');
                            li.remove();
                        }
                        // Soft reload using current URL - will keep user on same sekcja/page
                        // Using location.href with same URL causes page reload but preserves query params
                        setTimeout(function(){
                            console.log('[DEBUG] soft reload with location.href');
                            location.href = location.href;
                        }, 300);
                    } else {
                        if(attempts < maxAttempts){
                            var delay = 300 * Math.pow(2, attempts-1);
                            setTimeout(doFetch, delay);
                        } else {
                            showToast('B≈ÇƒÖd potwierdzenia (server)', 'error');
                            if(btn){ btn.disabled = false; }
                        }
                    }
                })
                .catch(function(err){
                    if(attempts < maxAttempts){
                        var delay = 300 * Math.pow(2, attempts-1);
                        setTimeout(doFetch, delay);
                    } else {
                        showToast('B≈ÇƒÖd sieci podczas potwierdzania', 'error');
                        if(btn){ btn.disabled = false; }
                    }
                });
        }
        doFetch();
    }, false);
});
</script>

<script>
// Je≈õli URL zawiera open_stop, otw√≥rz modal stop dla podanego plan_id
// Usu≈Ñ parametr `open_stop` z URL natychmiast ‚Äî zapobiega niechcianemu auto-otwieraniu modal√≥w
(function(){
    try{
        const params = new URLSearchParams(window.location.search);
        if(params.has('open_stop')){
            console.log('[debug] Removing open_stop from URL to prevent auto modal open. skip_open_stop=', sessionStorage.getItem('skip_open_stop'));
            params.delete('open_stop');
            const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            window.history.replaceState({}, document.title, newUrl);
            // Nie otwieramy modalu automatycznie w tej wersji.
        }
    }catch(e){console.error(e)}
})();
</script>

<script>
// Toast notification function
function showToast(message, type = 'error') {
    // Remove old toasts
    const oldToasts = document.querySelectorAll('.toast-notification');
    oldToasts.forEach(t => t.remove());
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: ${type === 'error' ? '#d32f2f' : '#4caf50'};
        color: white;
        padding: 16px 24px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 10000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Add CSS animation for toast
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);

// AJAX submit for dodaj_palete forms to avoid click interception by overlays
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('form[action*="/dodaj_palete"]').forEach(form => {
        form.addEventListener('submit', async function(e){
            e.preventDefault();
            // disable pointer events on stop-* overlays to avoid interception
            const stopEls = Array.from(document.querySelectorAll('[id^="stop-"]'));
            stopEls.forEach(el => { el.dataset._savedPe = el.style.pointerEvents || ''; el.style.pointerEvents = 'none'; });
            // safety timeout to restore if request hangs
            let restoreCalled = false;
            const restore = () => {
                if(restoreCalled) return; restoreCalled = true;
                stopEls.forEach(el => { if(el.dataset._savedPe !== undefined){ el.style.pointerEvents = el.dataset._savedPe; delete el.dataset._savedPe; } else { el.style.pointerEvents = ''; } });
            };
            const timeoutId = setTimeout(restore, 3000);
            try{
                sessionStorage.setItem('skip_open_stop','1');
                const action = form.getAttribute('action');
                const fd = new FormData(form);
                const resp = await fetch(action, { method: 'POST', body: fd, credentials: 'same-origin' });
                clearTimeout(timeoutId);
                restore();
                
                // Check for error responses (4xx, 5xx)
                if (!resp.ok) {
                    const errorText = await resp.text();
                    showToast(errorText || `B≈ÇƒÖd ${resp.status}: Nie uda≈Ço siƒô dodaƒá przedmiotu`, 'error');
                    return;
                }
                
                if(resp.redirected){ window.location.href = resp.url; return; }
                // Reload with current URL parameters preserved (sekcja, data, etc)
                window.location.href = window.location.href;
            }catch(err){
                clearTimeout(timeoutId);
                restore();
                console.error('AJAX dodaj_palete failed, falling back to normal submit', err);
                showToast('B≈ÇƒÖd sieci: ' + err.message, 'error');
                form.submit();
            }
        });
    });
});
</script>