{% extends "layout.html" %}

{% block content %}
<!-- modalOverlay removed (mechanizm popup wy≈ÇƒÖczony) -->
    <div class="section-header">
    <div>
        <h2 class="header-title">Hala Produkcyjna: <strong>{{ sekcja }}</strong></h2>
        {% if sekcja != 'Zasyp' %}
        <p class="text-muted m-0">{{ rola|upper }} | {{ dzisiaj }}</p>
        {% endif %}
        <div class="day-tile" style="margin-top:8px;" data-sekcja="{{ sekcja }}">
            <button type="button" class="day-nav left" data-day-offset="-1" aria-label="Poprzedni dzie≈Ñ">‚óÄ</button>
            <div class="day-center">
                <div class="day-label">Widok dla</div>
                <div id="current-date-display" class="day-date">{{ dzisiaj }}</div>
            </div>
            <button type="button" class="day-nav right" data-day-offset="1" aria-label="Nastƒôpny dzie≈Ñ">‚ñ∂</button>
            <input type="hidden" id="current-date-iso" value="{{ dzisiaj.strftime('%Y-%m-%d') }}">
            {% if sekcja == 'Zasyp' %}
                <button type="button" class="btn-action btn-outline" style="margin-left:10px;" onclick="(function(){ if(typeof showQuickPopup==='function'){ showQuickPopup('Szybki popup Zasyp', '<p>To jest szybki popup dla Zasypu.</p>'); } else { alert('showQuickPopup niedostƒôpny'); } })();">Quick popup</button>
            {% endif %}
        </div>
    </div>
    <div class="d-flex align-center gap-12 header-stats">
        {% if sekcja == 'Magazyn' %}
            <div class="stat-inline stat-magazyn"><span class="label">Przyjƒôto</span><strong class="value text-success">{{ suma_wykonanie|int }} kg</strong></div>
            <div class="stat-inline stat-magazyn"><span class="label">Palet</span><strong class="value">{{ magazyn_palety|length }} szt.</strong></div>
        {% else %}
            <div class="stat-inline stat-plan"><span class="label">Plan</span><strong class="value">{{ suma_plan|int }} kg</strong></div>
            <div class="stat-inline stat-wykonanie"><span class="label">Wykonanie</span><strong class="value text-success">{{ suma_wykonanie|int }} kg</strong></div>
            <div class="stat-inline stat-realizacja"><span class="label">% Realizacja</span><strong class="value">{{ (suma_wykonanie/suma_plan*100)|int if suma_plan>0 else 0 }}%</strong></div>
        {% endif %}
    </div>
</div>

<!-- Date overview widget: shows current date and range (dzie≈Ñ/tydzie≈Ñ/miesiƒÖc) -->
<div class="section-box mb-10 date-overview" style="display:block;">
    <div class="p-10 d-flex align-center justify-between">
        <div>
            <div class="small text-muted">PrzeglƒÖd daty</div>
            <div><strong id="overview-current">{{ dzisiaj.strftime('%d %b %Y') }}</strong></div>
            <div id="overview-range" class="small text-muted">-</div>
        </div>
        <div class="d-flex gap-8">
            <button type="button" id="view-day" class="btn btn-sm">Dzie≈Ñ</button>
            <button type="button" id="view-week" class="btn btn-sm">Tydzie≈Ñ</button>
            <button type="button" id="view-month" class="btn btn-sm">MiesiƒÖc</button>
        </div>
    </div>
</div>

{% if sekcja == 'Magazyn' %}
    <div class="section-box mb-10">
        <h4 class="m-0">üì¶ Palety do Zatwierdzenia</h4>
        <div class="mt-10">
                    {% if unconfirmed_palety and unconfirmed_palety|length > 0 %}
                        <table class="modern-table small">
                            <thead>
                                <tr>
                                    <th>Nr</th>
                                    <th>üìã Produkt</th>
                                    <th>‚öñÔ∏è Waga</th>
                                    <th>üïí Dodana</th>
                                    <th>‚è±Ô∏è Czas</th>
                                    <th>‚úÖ Akcja</th>
                                </tr>
                            </thead>
                            <tbody>
                        {% for p in unconfirmed_palety %}
                            <tr>
                                <td class="text-muted font-bold">{{ p[4] if p[4] is not none else p[0] }}</td>
                                <td><strong class="text-primary">{{ p[1] }}</strong></td>
                                <td><strong class="text-success">{{ p[2] }}</strong></td>
                                <td class="time-display">{{ p[3] }}</td>
                                <td><span class="paleta-elapsed duration-badge" data-start="{{ p[3] }}">{% if p[5] %}{{ p[5] }}{% else %}-{% endif %}</span></td>
                                <td>
                                    <a href="{{ url_for('api.potwierdz_palete_page', paleta_id=p[0]) }}" class="btn-action btn-success btn-small" data-slide>Zatwierd≈∫</a>
                                </td>
                            </tr>
                        {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="text-muted text-center p-10">Brak palet oczekujƒÖcych na zatwierdzenie.</div>
                    {% endif %}
        </div>
    </div>
    {% if rola in ['lider', 'admin'] %}
    <!-- Przycisk wysy≈Çania przypomnie≈Ñ usuniƒôty. Potwierdzanie palet odbywa siƒô przez sekcjƒô 'Zatwierd≈∫' w Magazyn. -->
    {% endif %}
{% else %}
    {# Stat cards removed ‚Äî metrics already shown in the header to avoid duplication and overlap #}
    
{% endif %}

{% if wpisy %}
<div class="mb-20">
    {% for w in wpisy[:2] %}
        <div class="alert-warning d-flex justify-between align-center mb-5">
            <div>
                <span>‚ö†Ô∏è <strong>{{ w[3] }}</strong> [{{ w[5] }}]: {{ w[2] }}</span>
                <div class="small text-muted">od {{ w[3] }}{% if w[4] %} ‚Äî do {{ w[4] }}{% endif %}</div>
            </div>

            
            {% if rola in ['lider', 'admin'] %}
                <div class="d-flex gap-8 align-center">
                    <a href="{{ url_for('api.edytuj', id=w[0]) }}" title="Edytuj wpis" class="font-bold text-warning-dark no-underline">‚úé</a>
                    <form action="{{ url_for('api.usun_wpis', id=w[0]) }}" method="POST" class="m-0">
                        <input type="hidden" name="sekcja" value="{{ sekcja }}">
                        <button type="submit" class="btn-icon text-warning-dark" aria-label="Usu≈Ñ wpis">‚úñ</button>
                    </form>
                </div>
            {% endif %}
        </div>
    {% endfor %}
</div>
{% endif %}

{% set ns = namespace(is_active=false) %}
{% for p in plan %}{% if p[3] == 'w toku' %}{% set ns.is_active = true %}{% endif %}{% endfor %}

{# Defensive: prefer server-provided `hr_pracownicy`; fallback to full lists if not provided #}
{% if hr_pracownicy is not defined %}
    {% if wszyscy_pracownicy is defined %}
        {% set hr_pracownicy = wszyscy_pracownicy %}
    {% else %}
        {% set hr_pracownicy = pracownicy %}
    {% endif %}
{% endif %}

    <div class="section-box p-0">
    <div class="p-15 p-15-bg">
        <h3 class="m-0 text-primary">üìã {% if sekcja=='Magazyn' %}Rejestr Przyjƒôƒá{% else %}Kolejka Produkcyjna{% endif %}</h3>
        <span class="badge-info">{{ sekcja|upper }}</span>
    </div>
    {% if rola == 'planista' and quality_count and quality_count > 0 %}
    <div class="alert-warning d-flex justify-between align-center mb-10">
        <div class="text-warning-dark font-bold">üîî SƒÖ {{ quality_count }} zg≈Çosze≈Ñ dezynfekcji od laboratorium ‚Äî sprawd≈∫ i dodaj do plan√≥w.</div>
        <div>
            <a href="{{ url_for('jakosc_index') }}" class="btn-action btn-warning">Przejd≈∫ do Jako≈õƒá</a>
        </div>
    </div>
    {% endif %}
    
    <!-- Sekcja: Wznowienie zlece≈Ñ z poprzedniego dnia -->
    {% if sekcja in ['Zasyp', 'Workowanie'] %}
    <div class="alert-info d-flex justify-between align-center mb-10" id="resume-yesterday-section">
        <div>
            <div class="font-bold">üîÑ Wczorajsze zlecenia (zawieszonych)</div>
            <div class="small text-muted">Kliknij aby wznowiƒá prace z poprzedniego dnia</div>
        </div>
        <button type="button" class="btn-action btn-info" onclick="resumeYesterdaysOrders('{{ sekcja }}');">
            <span class="material-icons" style="margin-right: 4px;">replay</span> Wzn√≥w zlecenia z wczoraj
        </button>
    </div>
    {% endif %}

    <table class="modern-table">
        <thead>
            <tr>
                <th>#</th><th>üì¶ Produkt</th><th>üìã Plan</th><th>üïí Czas Pracy</th><th>üìä Status</th><th>‚úÖ Realizacja</th><th class="text-right">‚öôÔ∏è Akcje</th>
            </tr>
        </thead>
        <tbody>
        {% for p in plan %}
            <tr class="row-{{ p[3]|replace(' ', '') }}">
                <td class="text-muted font-bold">{{ loop.index }}</td>
                <td>
                    <strong class="text-primary">{{ p[1] }}</strong>
                    <div class="small badge-sekcja">{{ p[9]|upper }}</div>
                </td>
                <td>
                    <strong class="text-success">{{ p[2]|int }} kg</strong>
                </td>
                <td class="small">
                    {% if p[4] %}<div class="time-display">üü¢ {{ p[4] }}</div>{% endif %}
                    {% if p[5] %}<div class="time-display text-danger-color">üî¥ {{ p[5] }}</div>{% endif %}
                    {% if p[6] is not none and p[6] > 0 %}
                        {% set mins = p[6] %}
                        {% set h = (mins // 60) %}
                        {% set m = mins % 60 %}
                        <div class="duration-badge">‚è±Ô∏è {% if h > 0 %}{{ h }}h {% endif %}{{ m }}m</div>
                    {% endif %}
                </td>
                <td><span class="status-badge status-{{ p[3]|replace(' ', '') }}">{{ p[3]|upper }}</span></td>
                <td>
                    <strong class="{% if p[7] > 0 %}text-success{% else %}text-muted{% endif %}">{{ p[7]|int }} kg</strong>
                    {% if palety_mapa[p[0]] %}
                        <button type="button" onclick="toggleDetails('{{ p[0] }}')" class="btn-toggle ml-5">
                            üì¶ {{ palety_mapa[p[0]]|length }} szt. ‚ñº
                        </button>
                    {% endif %}
                    {# Przyciski przenoszenia do Jako≈õƒá usuniƒôte ‚Äî dezynfekcja planowana przez laboratorium i zg≈Çaszana plani≈õcie. #}
                </td>
                <td class="text-right">
                    {% if rola in ['lider', 'admin', 'pracownik'] and sekcja != 'Magazyn' %}
                        {% if p[3] == 'zaplanowane' %}
                            {% if ns.is_active %}<button type="button" disabled class="btn-action btn-disabled" aria-label="Zablokowane"><span class="material-icons">block</span></button>
                            {% else %}<form action="{{ url_for('api.start_zlecenie', id=p[0]) }}" method="POST"><input type="hidden" name="sekcja" value="{{ sekcja }}"><button type="submit" class="btn-action btn-start">START</button></form>{% endif %}
                        {% elif p[3] == 'w toku' %}
                            <div class="d-flex gap-5 justify-end">
                                {% if sekcja == 'Workowanie' %}
                                    <div class="paleta-inline-wrapper paleta-inline">
                                            {% if p[9] == 'bigbag' %}
                                            <a href="{{ url_for('api.dodaj_palete_page', plan_id=p[0]) }}" class="btn-action btn-purple" data-slide>{{ '+ BIGBAG' }}</a>
                                        {% else %}
                                            <a href="{{ url_for('api.dodaj_palete_page', plan_id=p[0]) }}" class="btn-action btn-purple" data-slide>+ PALETA</a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                {% if sekcja == 'Zasyp' %}
                                    <a href="{{ url_for('api.szarza_page', plan_id=p[0]) }}" class="btn-action btn-green" target="_blank">+ SZAR≈ªA</a>
                                    <a href="{{ url_for('api.koniec_zlecenie_page', id=p[0], sekcja=sekcja) }}" class="btn-action btn-stop" data-slide>STOP</a>
                                {% else %}
                                    <form action="{{ url_for('api.koniec_zlecenie', id=p[0]) }}" method="POST"><input type="hidden" name="sekcja" value="{{ sekcja }}"><button type="submit" class="btn-action btn-stop">STOP</button></form>
                                {% endif %}
                            </div>
                            <!-- Modale paleta/szarza/stop-zasyp usuniƒôte -->
                            {% if sekcja != 'Zasyp' %}
                            <!-- Modal stop usuniƒôty -->
                            {% endif %}
                        {% elif p[3] == 'zakonczone' %}
                                    <div class="d-flex align-center justify-end gap-10">
                                <span class="material-icons text-success">check_circle</span>
                                    {% if sekcja == 'Zasyp' and p[13] and not p[10] %}
                                    <a href="{{ url_for('api.wyjasnij_page', id=p[0]) }}" class="btn-action btn-stop btn-small pulse-animation" data-slide>‚ö†Ô∏è WYJA≈öNIJ ({{ p[12]|int }} kg)</a>
                                    <!-- Wyja≈õnienie modal (slide-over) -->
                                    {% endif %}
                                {% if rola in ['lider', 'admin'] %}<form action="{{ url_for('api.przywroc_zlecenie', id=p[0]) }}" method="POST" onsubmit="return confirm('Wznowiƒá?');"><button type="submit" class="btn-action btn-outline-warning" aria-label="Przywr√≥ƒá zlecenie"><span class="material-icons">replay</span></button></form>{% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% if palety_mapa[p[0]] and (sekcja == 'Workowanie' or sekcja == 'Magazyn' or sekcja == 'Zasyp') %}
            <tr id="details-{{ p[0] }}" class="details-row">
                <td colspan="7" class="p-0">
                    <div class="p-10">
                        <table class="modern-table small">
                            <thead><tr><th>Nr</th><th>üïí Godzina</th><th>Typ</th><th>Waga</th><th>‚è±Ô∏è Czas</th><th>Opcje</th></tr></thead>
                            <tbody>
                                {% for pal in palety_mapa[p[0]] %}
                                <tr>
                                    <td class="text-muted font-bold">{{ loop.index }}</td>
                                    <td class="time-display"><span>{{ pal[1] }}</span></td>
                                    <td><span class="badge-sekcja">{{ pal[4]|upper }}</span></td>
                                    <td>
                                            {% if sekcja == 'Magazyn' and pal[4] == 'bigbag' %}
                                                {% if pal[0] == 0 %}
                                                    <a href="{{ url_for('api.edytuj_palete_page', paleta_id=pal[2]) }}" class="btn-action btn-warning small" data-slide>‚öñÔ∏è WA≈ªENIE</a>
                                                {% else %}
                                                    <strong class="text-success">{{ pal[0]|int }} kg</strong>
                                                    <a href="{{ url_for('api.edytuj_palete_page', paleta_id=pal[2]) }}" class="btn-icon ml-5" aria-label="Edytuj wagƒô" data-slide>‚úèÔ∏è</a>
                                                {% endif %}
                                            <!-- Waga modal removed -->
                                        {% else %}<strong class="text-primary">{{ pal[0]|int }} kg</strong>{% endif %}
                                    </td>
                                    <td>
                                        <span class="paleta-elapsed duration-badge" data-start="{{ pal[9] }}"></span>
                                    </td>
                                    <td>
                                        {% if pal[7] and pal[7] != '' %}
                                            {% if pal[7] == 'do_przyjecia' %}
                                                {% if sekcja != 'Zasyp' %}
                                                    <span class="badge badge-warning">üîÑ Do przyjƒôcia</span>
                                                {% endif %}
                                            {% elif pal[7] == 'przyjeta' %}
                                                <span class="badge badge-success">‚úÖ Przyjƒôta</span>
                                            {% elif pal[7] == 'zamknieta' %}
                                                <span class="badge badge-secondary">üîí Zamkniƒôta</span>
                                            {% else %}
                                                <span class="badge">{{ pal[7] }}</span>
                                            {% endif %}
                                        {% endif %}
                                        {% if rola in ['lider', 'admin'] %}
                                            <a href="{{ url_for('api.edytuj_palete_page', paleta_id=pal[2]) }}" class="btn-icon" aria-label="Edytuj paletƒô" data-slide>‚úèÔ∏è</a>
                                            <a href="{{ url_for('api.confirm_delete_palete_page', paleta_id=pal[2]) }}" class="btn-icon text-danger-color" aria-label="Usu≈Ñ paletƒô" data-slide>üóëÔ∏è</a>
                                        {% endif %}
                                        {% if sekcja == 'Magazyn' and (rola == 'magazynier' or rola in ['lider','admin']) and pal[7] == 'do_przyjecia' %}
                                            {# Inline styles removed ‚Äî use .btn-confirm-inline class in external CSS (static/style.css) #}
                                            <a href="{{ url_for('api.potwierdz_palete_page', paleta_id=pal[2]) }}" class="btn-action btn-save btn-small btn-confirm-inline" data-slide>Potwierd≈∫</a>
                                        {% endif %}
                                    <!-- editpal and confirm-delete modals removed -->
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endif %}
        {% else %}<tr><td colspan="7" class="text-center p-30">Brak danych.</td></tr>{% endfor %}
        </tbody>
    </table>
</div>

    {# HR, Nadgodziny i Raport Ko≈Ñcowy usuniƒôte z tego widoku ‚Äî przeniesione do dashboard_global.html #}

<script>
    function toggleDetails(id) {
        var row = document.getElementById('details-' + id);
        if (!row) return;
        var isHidden = getComputedStyle(row).display === 'none' || row.style.display === 'none';
        row.style.display = isHidden ? 'table-row' : 'none';
    }
    
    // ========== RƒòCZNE WZNOWIENIE ZLECE≈É Z POPRZEDNIEGO DNIA ==========
    function resumeYesterdaysOrders(sekcja) {
        console.log(`[RESUME] Starting resume for sekcja=${sekcja}`);
        const button = event.target.closest('button');
        console.log(`[RESUME] Button element: ${button ? 'found' : 'NOT FOUND'}`);
        if (!button) return;
        
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '‚è≥ Wznawiam...';
        
        const fetchUrl = `/api/wznow_zlecenia_sekcji/${sekcja}`;
        console.log(`[RESUME] Sending fetch to: ${fetchUrl}`);
        
        fetch(fetchUrl, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log(`[RESUME] Response status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log(`[RESUME] Response data:`, data);
            if (data.success) {
                console.log(`[RESUME] ‚úÖ ${data.message}`);
                alert(`‚úÖ ${data.message}`);
                // Od≈õwie≈º stronƒô aby pokazaƒá wznowione zlecenia
                setTimeout(() => location.reload(), 500);
            } else {
                console.error(`[RESUME] ‚úó B≈ÇƒÖd: ${data.message}`);
                alert(`‚ùå ${data.message}`);
                button.disabled = false;
                button.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('[RESUME] ‚úó B≈ÇƒÖd sieci:', error);
            alert(`‚ùå B≈ÇƒÖd sieci: ${error.message}`);
            button.disabled = false;
            button.textContent = originalText;
        });
    }
    
    // Modale wy≈ÇƒÖczone ‚Äî funkcje zastƒôpcze blokujƒÖce popupy
    function openModal(id) {
        try { if(window.__RP_DEBUG__){ console.debug('[modal-disabled] openModal called, id=', id); } } catch(e){}
        return;
    }

    function closeAllModals() {
        try { if(window.__RP_DEBUG__){ console.debug('[modal-disabled] closeAllModals called'); } } catch(e){}
        // Backwards-compat shim: route legacy modal close calls to the slide-over/center-modal
        try { if (typeof closeSlideOver === 'function') closeSlideOver(); } catch(e){}
        try { if (typeof closeCenterModal === 'function') closeCenterModal(); } catch(e){}
        return;
    }

    // openPopup removed ‚Äî use `showSlideOver(...)` directly where needed
    
    // Zamknij wszystko na start
    closeAllModals();

    /* showModalDisabled removed ‚Äî slide-over used as fallback instead */

    
</script>

<script>
// Modal movement logger: logs bounding rect before and after a small mousemove below the modal,
// prints to console and posts JSON to server endpoint `/debug/modal-move`.
// modal movement logger removed (modal mechanism disabled)
</script>

<script>
// Live elapsed timers for unconfirmed palety
function formatElapsed(secs){
    if(secs < 0) secs = 0;
    const h = Math.floor(secs/3600);
    const m = Math.floor((secs%3600)/60);
    const s = secs%60;
    if(h>0) return h+"h "+String(m).padStart(2,'0')+"m";
    if(m>0) return m+"m "+String(s).padStart(2,'0')+"s";
    return s+"s";
}
function updatePaletaTimers(){
    document.querySelectorAll('.paleta-elapsed').forEach(function(el){
        const ds = el.getAttribute('data-start');
        if(!ds) return;
        // parse 'YYYY-MM-DD HH:MM:SS' by replacing space with 'T'
        let t = ds.replace(' ', 'T');
        // If no timezone, Date.parse treats as local in most browsers
        const start = Date.parse(t);
        if(isNaN(start)) return;
        const now = Date.now();
        const secs = Math.floor((now - start)/1000);
        el.textContent = '‚è±Ô∏è ' + formatElapsed(secs);
    });
}
document.addEventListener('DOMContentLoaded', function(){ updatePaletaTimers(); setInterval(updatePaletaTimers, 1000); });
</script>

<script>
// Day shift buttons (global): navigate with ?sekcja=...&data=YYYY-MM-DD
document.addEventListener('DOMContentLoaded', function(){
    // selector updated: controls are rendered in .day-tile
    var container = document.querySelector('.day-tile');
    if(!container) return;
    function pad(n){ return n<10?('0'+n):n; }
    function isoFromDate(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
    var baseIso = document.getElementById('current-date-iso') ? document.getElementById('current-date-iso').value : null;
    var baseDate = baseIso ? new Date(baseIso+'T00:00:00') : new Date();
    container.querySelectorAll('button[data-day-offset]').forEach(function(btn){
        btn.addEventListener('click', function(){
            var offset = parseInt(btn.getAttribute('data-day-offset')||0,10);
            var target = new Date(baseDate.getTime());
            target.setDate(target.getDate() + offset);
            var iso = isoFromDate(target);
            // preserve sekcja in querystring (use data-sekcja from container)
            var params = new URLSearchParams(window.location.search);
            var sec = container.dataset.sekcja || params.get('sekcja');
            if(sec) params.set('sekcja', sec);
            else params.delete('sekcja');
            params.set('data', iso);
            window.location.search = params.toString();
        });
    });
});
</script>

<script>
// Date overview logic: compute day/week/month ranges based on #current-date-iso
document.addEventListener('DOMContentLoaded', function(){
    var isoInput = document.getElementById('current-date-iso');
    if(!isoInput) return;
    var baseIso = isoInput.value;
    function parseIso(s){ return new Date((s||'') + 'T00:00:00'); }
    function fmt(d){ try { return d.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short', year: 'numeric' }); } catch(e){ return d.toISOString().slice(0,10); } }

    function startOfWeek(d){ // Monday as first day
        var dt = new Date(d.getTime());
        var dow = dt.getDay(); // 0 Sun .. 6 Sat
        var delta = (dow + 6) % 7; // days since Monday
        dt.setDate(dt.getDate() - delta);
        dt.setHours(0,0,0,0);
        return dt;
    }
    function endOfWeek(d){ var s = startOfWeek(d); s.setDate(s.getDate()+6); return s; }
    function startOfMonth(d){ var s = new Date(d.getFullYear(), d.getMonth(), 1); return s; }
    function endOfMonth(d){ var s = new Date(d.getFullYear(), d.getMonth()+1, 0); return s; }

    var currentEl = document.getElementById('overview-current');
    var rangeEl = document.getElementById('overview-range');
    var dayBtn = document.getElementById('view-day');
    var weekBtn = document.getElementById('view-week');
    var monthBtn = document.getElementById('view-month');

    var currentDate = baseIso ? parseIso(baseIso) : new Date();
    currentEl.textContent = fmt(currentDate);

    function showDay(){ rangeEl.textContent = fmt(currentDate); }
    function showWeek(){ var s = startOfWeek(currentDate); var e = endOfWeek(currentDate); rangeEl.textContent = fmt(s) + ' ‚Äî ' + fmt(e); }
    function showMonth(){ var s = startOfMonth(currentDate); var e = endOfMonth(currentDate); rangeEl.textContent = fmt(s) + ' ‚Äî ' + fmt(e); }

    // default to day view
    showDay();

    dayBtn && dayBtn.addEventListener('click', function(){ showDay(); });
    weekBtn && weekBtn.addEventListener('click', function(){ showWeek(); });
    monthBtn && monthBtn.addEventListener('click', function(){ showMonth(); });
});
</script>

{% if sekcja == 'Zasyp' %}
<script>
// Zamienia zachowanie link√≥w z `data-slide` na Zasypie ‚Äî zamiast slide-over
// ≈Çaduje zawarto≈õƒá przez fetch i pokazuje w globalnym `showQuickPopup`.
document.addEventListener('DOMContentLoaded', function(){
    if(typeof showQuickPopup !== 'function') return;

    document.body.addEventListener('click', function(e){
        var a = e.target.closest && e.target.closest('a[data-slide]');
        if(!a) return;
        var href = a.getAttribute('href');
        if(!href) return;

        // only intercept relative links (same-origin)
        if(href.indexOf('http') === 0 && new URL(href, location.href).origin !== location.origin) return;

        e.preventDefault();
        // Prevent other click handlers (including slide-over) from running
        if (e.stopImmediatePropagation) try { e.stopImmediatePropagation(); } catch (e) {}
        // remove legacy slide attributes to fully disable slide-cover behavior on Zasyp
        try { a.removeAttribute('data-slide'); a.removeAttribute('data-slide-html'); } catch (e) {}
        var title = a.getAttribute('title') || a.textContent.trim() || 'Szybki popup';
        fetch(href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(function(res){ return res.text(); })
            .then(function(html){
                try{ showQuickPopup(title, html); }catch(err){ console.error(err); alert('B≈ÇƒÖd: nie uda≈Ço siƒô otworzyƒá popupu'); }
            }).catch(function(err){ console.error('fetch popup failed', err); alert('B≈ÇƒÖd ≈Çadowania zawarto≈õci'); });
    }, false);
});
</script>
{% endif %}

<!-- Przypomnienia usuniƒôte: funkcja remind_unconfirmed_palety zostaje, ale nie ma przycisku w UI. -->

<!-- moved CSS to static/style.css -->
<!-- Paleta modal removed: replaced by a separate page (dodaj_palete) -->
<script>
// AJAX approve/reject for dashboard wnioski_pending
document.addEventListener('DOMContentLoaded', function(){
    // showToast() provided by static/js/toasts.js

    var forms = document.querySelectorAll('.wn-form');
    forms.forEach(function(f){
        f.addEventListener('submit', function(e){
            e.preventDefault();
            var url = f.getAttribute('action');
            var row = f.closest('tr');
            var btn = f.querySelector('.wn-btn'); if(btn) btn.disabled = true;
            fetch(url, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest', 'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams()})
            .then(function(r){ try{ return r.json(); }catch(e){ return {}; } })
            .then(function(j){
                if(j && j.success){ if(row) row.remove(); showToast(j.message || 'Wniosek przetworzony', 'success'); }
                else { showToast((j && j.message) ? j.message : 'B≈ÇƒÖd', 'danger'); if(btn) btn.disabled = false; }
            }).catch(function(err){ console.error(err); showToast('B≈ÇƒÖd sieci', 'danger'); if(btn) btn.disabled = false; });
        });
    });
});
</script>

{% endblock %}

{% if sekcja == 'Magazyn' %}
<!-- Blok powiadomie≈Ñ o niezatwierdzonych paletach usuniƒôty (modale wy≈ÇƒÖczone) -->
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function(){
    // Disable submit button after first click for dodawanie palet (prevent double-add)
    document.querySelectorAll('form[action*="/api/dodaj_palete"]').forEach(function(f){
        f.addEventListener('submit', function(e){
            var btn = f.querySelector('button[type="submit"]');
            if(btn){ btn.disabled = true; btn.classList.add('btn-disabled'); }
        });
    });
    // Toast helper
    var toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    toastContainer.style.position = 'fixed';
    toastContainer.style.right = '20px';
    toastContainer.style.top = '20px';
    toastContainer.style.zIndex = 9999;
    document.body.appendChild(toastContainer);
    function showToast(msg, type){
        var t = document.createElement('div');
        t.className = 'toast ' + (type||'');
        t.style.background = (type=='success')? '#2ecc71' : (type=='error'? '#e74c3c' : '#333');
        t.style.color = '#fff';
        t.style.padding = '10px 14px';
        t.style.marginTop = '8px';
        t.style.borderRadius = '4px';
        t.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
        t.textContent = msg;
        toastContainer.appendChild(t);
        setTimeout(function(){ t.style.opacity = '0'; setTimeout(function(){ t.remove(); }, 300); }, 3500);
    }

    // Intercept potwierdz_palete forms and send via fetch with retry/backoff; remove tile on success
    // Use event delegation to handle forms added dynamically
    document.addEventListener('submit', function(e){
        var form = e.target;
        if (!form.classList.contains('confirm-paleta-form')) return;
        
        console.log('[DEBUG] confirm-paleta-form submit intercepted (event delegation)');
        e.preventDefault();
        var btn = form.querySelector('button[type="submit"]');
        if(btn){ btn.disabled = true; }
        var attempts = 0;
        var maxAttempts = 3;
        function doFetch(){
            attempts++;
            fetch(form.action, { method: 'POST', credentials: 'same-origin', headers: {'X-Requested-With':'XMLHttpRequest'} })
                .then(function(res){
                    if(res.ok){
                        console.log('[DEBUG] potwierdz_palete success');
                        showToast('Potwierdzono paletƒô', 'success');
                        var li = form.closest('li');
                        if(li) {
                            console.log('[DEBUG] removing <li> element');
                            li.remove();
                        }
                        // Soft reload using current URL - will keep user on same sekcja/page
                        // Using location.href with same URL causes page reload but preserves query params
                        setTimeout(function(){
                            console.log('[DEBUG] soft reload with location.href');
                            location.href = location.href;
                        }, 300);
                    } else {
                        if(attempts < maxAttempts){
                            var delay = 300 * Math.pow(2, attempts-1);
                            setTimeout(doFetch, delay);
                        } else {
                            showToast('B≈ÇƒÖd potwierdzenia (server)', 'error');
                            if(btn){ btn.disabled = false; }
                        }
                    }
                })
                .catch(function(err){
                    if(attempts < maxAttempts){
                        var delay = 300 * Math.pow(2, attempts-1);
                        setTimeout(doFetch, delay);
                    } else {
                        showToast('B≈ÇƒÖd sieci podczas potwierdzania', 'error');
                        if(btn){ btn.disabled = false; }
                    }
                });
        }
        doFetch();
    }, false);
});
</script>

<script>
// Je≈õli URL zawiera open_stop, otw√≥rz modal stop dla podanego plan_id
// Usu≈Ñ parametr `open_stop` z URL natychmiast ‚Äî zapobiega niechcianemu auto-otwieraniu modal√≥w
(function(){
    try{
        const params = new URLSearchParams(window.location.search);
        if(params.has('open_stop')){
            console.log('[debug] Removing open_stop from URL to prevent auto modal open. skip_open_stop=', sessionStorage.getItem('skip_open_stop'));
            params.delete('open_stop');
            const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            window.history.replaceState({}, document.title, newUrl);
            // Nie otwieramy modalu automatycznie w tej wersji.
        }
    }catch(e){console.error(e)}
})();
</script>

<script>
// Toast notification function
function showToast(message, type = 'error') {
    // Remove old toasts
    const oldToasts = document.querySelectorAll('.toast-notification');
    oldToasts.forEach(t => t.remove());
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        inset-inline-end: 20px;
        background-color: ${type === 'error' ? '#d32f2f' : '#4caf50'};
        color: white;
        padding: 16px 24px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 10000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Add CSS animation for toast
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);

// AJAX submit for dodaj_palete forms to avoid click interception by overlays
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('form[action*="/dodaj_palete"]').forEach(form => {
        form.addEventListener('submit', async function(e){
            e.preventDefault();
            // disable pointer events on stop-* overlays to avoid interception
            const stopEls = Array.from(document.querySelectorAll('[id^="stop-"]'));
            stopEls.forEach(el => { el.dataset._savedPe = el.style.pointerEvents || ''; el.style.pointerEvents = 'none'; });
            // safety timeout to restore if request hangs
            let restoreCalled = false;
            const restore = () => {
                if(restoreCalled) return; restoreCalled = true;
                stopEls.forEach(el => { if(el.dataset._savedPe !== undefined){ el.style.pointerEvents = el.dataset._savedPe; delete el.dataset._savedPe; } else { el.style.pointerEvents = ''; } });
            };
            const timeoutId = setTimeout(restore, 3000);
            try{
                sessionStorage.setItem('skip_open_stop','1');
                const action = form.getAttribute('action');
                const fd = new FormData(form);
                const resp = await fetch(action, { method: 'POST', body: fd, credentials: 'same-origin' });
                clearTimeout(timeoutId);
                restore();
                
                // Check for error responses (4xx, 5xx)
                if (!resp.ok) {
                    const errorText = await resp.text();
                    showToast(errorText || `B≈ÇƒÖd ${resp.status}: Nie uda≈Ço siƒô dodaƒá przedmiotu`, 'error');
                    return;
                }
                
                if(resp.redirected){ window.location.href = resp.url; return; }
                // Reload with current URL parameters preserved (sekcja, data, etc)
                window.location.href = window.location.href;
            }catch(err){
                clearTimeout(timeoutId);
                restore();
                console.error('AJAX dodaj_palete failed, falling back to normal submit', err);
                showToast('B≈ÇƒÖd sieci: ' + err.message, 'error');
                form.submit();
            }
        });
    });
});
</script>
