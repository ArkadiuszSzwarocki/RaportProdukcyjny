{% extends "layout.html" %}

{% block content %}
<div class="section-box">
  <style>
    .perm-actions { margin-top:12px; }
    .perm-status { margin-left:12px; color:green; display:none; }
    .section-actions { margin-top:12px; }
  </style>
  <div class="section-header">
    <h2>{{ _('ustawienia_role') }}</h2>
    <div><a href="/admin/ustawienia" class="btn">{{ _('powrot') }}</a></div>
  </div>

  <p>Tu możesz zarządzać dostępem ról do stron aplikacji oraz ustawić, czy dostęp ma być tylko do odczytu.</p>

  <div class="alert alert-info" style="margin-bottom: 20px; background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; color: #1565c0;">
    <strong>➕ Dodaj nową rolę:</strong>
    <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
      <input type="text" id="newRoleName" placeholder="Nazwa nowej roli (np. kierownik, specjalista)" class="input-sm" style="min-width: 250px;">
      <button type="button" id="btnAddRole" class="btn btn-primary" style="padding: 8px 16px;">+ Dodaj rolę</button>
      <span id="addRoleStatus" style="color: green; display: none;"></span>
    </div>
  </div>

  <div class="table-responsive">
    <table class="modern-table">
      <thead>
        <tr>
          <th>Strona</th>
          {% for r in roles %}<th>{{ r[0] }}</th>{% endfor %}
        </tr>
      </thead>
      <tbody id="permBody">
        {% for p in pages %}
        <tr data-page="{{ p }}">
          <td><strong>{{ p }}</strong></td>
          {% for r in roles %}
          <td>
            <label><input type="checkbox" class="perm-access" data-role="{{ r[0] }}"> Dostęp</label><br>
            <label><input type="checkbox" class="perm-readonly" data-role="{{ r[0] }}"> Tylko odczyt</label>
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="section-actions">
    <button id="btnSavePerms" class="btn btn-primary">{{ _('zapisz_uprawnienia') }}</button>
    <span id="permStatus" class="perm-status">{{ _('zapisano_punkt') }}</span>
  </div>

  <script id="perms-data" type="application/json">{{ perms_json|tojson }}</script>
  <script>
  (function(){
    // Obsługa dodawania nowej roli
    document.getElementById('btnAddRole').addEventListener('click', async function(){
      const roleName = document.getElementById('newRoleName').value.trim().toLowerCase();
      if(!roleName){
        alert('Proszę wpisać nazwę roli');
        return;
      }
      
      try{
        const resp = await fetch('/admin/ustawienia/roles/add', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({role_name: roleName})
        });
        
        const result = await resp.json();
        if(result.success){
          document.getElementById('addRoleStatus').textContent = '✓ Rola dodana!';
          document.getElementById('addRoleStatus').style.display = 'inline';
          document.getElementById('newRoleName').value = '';
          setTimeout(() => location.reload(), 1000);
        } else {
          alert('Błąd: ' + (result.error || 'Nie udało się dodać roli'));
        }
      } catch(e){
        alert('Błąd sieci: ' + e);
      }
    });
    
    let current = {};
    try{
      const raw = document.getElementById('perms-data') && document.getElementById('perms-data').textContent;
      console.log('Raw perms-data (first 300 chars):', raw.slice(0, 300));
      current = raw ? JSON.parse(raw) : {};
      console.log('Parsed perms:', Object.keys(current).length, 'pages');
    }catch(e){
      console.error('Failed to parse perms_json:', e);
      current = {};
    }
    
    // Renderuj checkboxy na podstawie config
    const rows = document.querySelectorAll('#permBody tr');
    rows.forEach(function(tr){
      const page = tr.getAttribute('data-page');
      const pagePerms = current[page] || {};
      
      // Dla każdego checkboxa access/readonly — sprawdź czy rola+strona istnieje w config
      tr.querySelectorAll('input.perm-access').forEach(function(accessCh){
        const role = accessCh.getAttribute('data-role');
        const rolePerms = pagePerms[role];
        
        // Ustaw state checkboxa
        accessCh.checked = rolePerms && rolePerms.access ? true : false;
        
        // Znajdź readonly checkbox dla tej samej roli w tym wierszu
        const readonlyCh = tr.querySelector('input.perm-readonly[data-role="' + role + '"]');
        if(readonlyCh) {
          readonlyCh.checked = rolePerms && rolePerms.readonly ? true : false;
          
          // Add listener: jeśli readonly=true, to access musi być true i disabled
          readonlyCh.addEventListener('change', function(){
            if(this.checked) {
              accessCh.checked = true;
              accessCh.disabled = true;
            } else {
              accessCh.disabled = false;
            }
          });
          
          // Initial state: jeśli readonly=true, wyłącz access checkbox
          if(readonlyCh.checked) {
            accessCh.disabled = true;
          }
        }
      });
    });

    document.getElementById('btnSavePerms').addEventListener('click', async function(){
      // Canonical page order (must match server-side list)
      const pageOrder = ['dashboard','ustawienia','jakosc','planista','plan','zasyp','workowanie','magazyn','moje_godziny','awarie','wyniki'];
      const payload = {};
      
      // Build payload in canonical page order
      pageOrder.forEach(function(page){
        const tr = document.querySelector('#permBody tr[data-page="' + page + '"]');
        if(!tr) return; // page not found, skip
        
        const pageRoles = {};
        
        // Dla każdego wiersza — przejrzyj pary (access, readonly) checkbox dla tej samej roli
        tr.querySelectorAll('input.perm-access').forEach(function(accessCh){
          const role = accessCh.getAttribute('data-role');
          const readonlyCh = tr.querySelector('input.perm-readonly[data-role="' + role + '"]');
          
          // Zapisz KAŻDĄ rolę (zaznaczoną lub nie)
          const access = accessCh.checked;
          const readonly = readonlyCh && readonlyCh.checked;
          
          // Jeśli readonly=true, automatycznie access=true (readonly bez dostępu to nonsens)
          pageRoles[role] = { access: !!(access || readonly), readonly: !!readonly };
        });
        
        // Dodaj KAŻDĄ stronę do payload (nawet jeśli żadna rola nie ma dostępu)
        payload[page] = pageRoles;
      });

      console.log('Wysyłam payload (ordered):', JSON.stringify(payload).slice(0, 300));
      console.log('Payload keys order:', Object.keys(payload));
      
      try{
        const resp = await fetch('/admin/ustawienia/roles/save', { method: 'POST', headers: {'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'}, body: JSON.stringify(payload) });
        if(resp.status === 200){
          try{
            const j = await resp.json();
            document.getElementById('permStatus').textContent = 'Zapisano.' + (j && j.backup ? ' Kopia: ' + j.backup : '');
          }catch(e){
            document.getElementById('permStatus').textContent = 'Zapisano.';
          }
          document.getElementById('permStatus').style.display='inline';
          setTimeout(function(){ location.reload(); }, 1200);
        } else {
          // try to extract JSON error
          try{
            const j = await resp.json();
            alert('Błąd zapisu: ' + (j && j.error ? j.error : resp.status));
          }catch(e){
            alert('Błąd zapisu (status ' + resp.status + ')');
          }
        }
      }catch(e){ alert('Błąd sieci: ' + e); }
    });
  })();
  </script>

</div>
{% endblock %}
