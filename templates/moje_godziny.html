{% extends 'layout.html' %}
{% block content %}
<h2>{{ _('moje_godziny') }}</h2>
{% if not mapped %}
  <div class="alert alert-warning">Twoje konto nie jest powiązane z rekordem pracownika. Skontaktuj się z administratorem.</div>
{% endif %}

<p>Zakres: {{ d_od }} — {{ d_do }}</p>
  {% if pracownicy_list %}
    <form method="get" class="mb-3">
      <label for="pracownik_select">{{ _('przeglądaj_pracownika') }}</label>
      <select id="pracownik_select" name="pracownik_id" title="Wybierz pracownika do przeglądu" onchange="this.form.submit()" class="form-control pracownik-select">
        <option value="">-- wybierz --</option>
        {% for p in pracownicy_list %}
          <option value="{{ p[0] }}" {% if selected_pid and p[0]==selected_pid %}selected{% endif %}>{{ p[1] }}</option>
        {% endfor %}
      </select>
    </form>
  {% endif %}
  <div class="mp-flex-row">
    <div>
      <h4>{{ _('twoje_podsumowanie') }}</h4>
      <ul>
        <li>Liczba zmian obecności w tym okresie: <strong id="obecnosciCount_owner">{{ owner_summary.obecnosci }}</strong></li>
        <li>Wyjścia prywatne (suma godzin): <strong id="wyjsciaHours_owner">{{ '%.2f'|format(owner_summary.wyjscia_hours) }} h</strong></li>
        <li>Urlop bieżący (dni): <strong id="urlopBiez_owner">{{ owner_summary.urlop_biezacy if owner_summary.urlop_biezacy is defined else 0 }}</strong></li>
        <li>Urlop zaległy (dni): <strong id="urlopZal_owner">{{ owner_summary.urlop_zalegly if owner_summary.urlop_zalegly is defined else 0 }}</strong></li>
      </ul>
    </div>
    {% if viewed_summary %}
    <div>
      <h4>{{ _('przegladany_pracownik') }}</h4>
      <ul>
        <li>Liczba zmian obecności w tym okresie: <strong id="obecnosciCount_viewed">{{ viewed_summary.obecnosci }}</strong></li>
        <li>Wyjścia prywatne (suma godzin): <strong id="wyjsciaHours_viewed">{{ '%.2f'|format(viewed_summary.wyjscia_hours) }} h</strong></li>
        <li>Urlop bieżący (dni): <strong id="urlopBiez_viewed">{{ viewed_summary.urlop_biezacy if viewed_summary.urlop_biezacy is defined else 0 }}</strong></li>
        <li>Urlop zaległy (dni): <strong id="urlopZal_viewed">{{ viewed_summary.urlop_zalegly if viewed_summary.urlop_zalegly is defined else 0 }}</strong></li>
      </ul>
    </div>
    {% endif %}
  </div>
  <h3>{{ _('zloz_wniosek_o_wolne') }}</h3>
  <form action="{{ url_for('api.submit_wniosek') }}" method="post" class="mb-3">
    <div class="row">
      <div class="col-md-3"><label for="typ_select">{{ _('typ') }}</label>
        <select id="typ_select" name="typ" class="form-control" title="{{ _('wybierz_typ_wniosku') }}">
          <option>{{ _('urlop') }}</option>
          <option>{{ _('nieobecnosc') }}</option>
          <option>{{ _('wyjscie_prywatne') }}</option>
        </select>
      </div>
      <div class="col-md-3"><label>{{ _('od') }}</label><input id="data_od" type="date" name="data_od" class="form-control" required title="{{ _('data_od') }}" placeholder="RRRR-MM-DD"></div>
      <div class="col-md-3"><label>{{ _('do') }}</label><input id="data_do" type="date" name="data_do" class="form-control" required title="{{ _('data_do') }}" placeholder="RRRR-MM-DD"></div>
      <div class="col-md-3 d-none" id="timeColOd"><label for="czas_od">{{ _('czas_od') }}</label><input id="czas_od" type="time" name="czas_od" title="{{ _('czas_od') }}" placeholder="{{ _('hh_mm') }}" class="form-control"></div>
    </div>
    <div class="row mt-2">
      <div class="col-md-9"></div>
      <div class="col-md-3 align-self-end"><button type="submit" class="btn btn-primary">{{ _('zloz_wniosek') }}</button></div>
    </div>
  </form>

  <h3>{{ _('twoje_wnioski') }}</h3>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>{{ _('data') }}</th><th>{{ _('typ') }}</th><th>{{ _('okres') }}</th><th>{{ _('stan') }}</th>
        {% if session.get('rola') in ['lider','admin'] %}<th>{{ _('akcje') }}</th>{% endif %}
      </tr>
    </thead>
    <tbody>
    {% for w in wnioski %}
      <tr data-wnid="{{ w.id }}">
        <td>{{ w.zlozono }}</td>
        <td>{{ w.typ }}</td>
        <td>{{ w.data_od }} → {{ w.data_do }}{% if w.czas_od %} ({{ w.czas_od }}-{{ w.czas_do }}){% endif %}</td>
        <td>{{ w.status }}</td>
        {% if session.get('rola') in ['lider','admin'] %}
          <td>
            {% if w.status != 'approved' %}
              <button class="btn btn-sm btn-success wn-action" data-id="{{ w.id }}" data-action="approve">{{ _('zatwierdz') }}</button>
              <button type="button" class="btn btn-sm btn-danger wn-action ml-6" data-id="{{ w.id }}" data-action="reject">{{ _('odrzuc') }}</button>
            {% else %}
              <span class="badge badge-success">{{ _('zatwierdzony') }}</span>
            {% endif %}
          </td>
        {% endif %}
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <h3>{{ _('suma_godzin_wg_typu') }}</h3>
  <table class="table" id="typyTable_owner">
    <thead><tr><th>{{ _('typ') }}</th><th>{{ _('godziny') }}</th></tr></thead>
    <tbody>
    {% for t, h in owner_summary.typy.items() %}
      <tr data-typ="{{ t }}"><td>{{ t or '(brak)' }}</td><td class="typ-hours">{{ '%.2f'|format(h) }} h</td></tr>
    {% endfor %}
    </tbody>
  </table>
  {% if viewed_summary %}
  <h4>Typy — przeglądany</h4>
  <table class="table" id="typyTable_viewed">
    <thead><tr><th>{{ _('typ') }}</th><th>{{ _('godziny') }}</th></tr></thead>
    <tbody>
    {% for t, h in viewed_summary.typy.items() %}
      <tr data-typ="{{ t }}"><td>{{ t or '(brak)' }}</td><td class="typ-hours">{{ '%.2f'|format(h) }} h</td></tr>
    {% endfor %}
    </tbody>
  </table>
  {% endif %}

  <h3>Kalendarz godzin (miesiąc)</h3>
  <style>
    .cal-grid { width:100%; border-collapse: collapse; }
    .cal-grid th { text-align:center; padding:6px; background:#f7f7f7; }
    .cal-grid td { width:14%; vertical-align: top; border:1px solid #eee; padding:8px; height:100px; }
    .cal-day { font-weight:600; margin-bottom:6px; }
    .cal-hours { font-size:0.9em; }
    .cal-type { font-size:0.85em; font-weight:600; margin-top:6px; display:inline-block; padding:2px 6px; border-radius:4px; background:#f0f0f0; color:#333; }
    .cal-hr { background:#ffe6e6; }
    .cal-approved { outline: 3px solid #c8f7c5; }
    .badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-top:6px; }
    .badge-success { background:#28a745; color:#fff; }
    .text-danger { color:#b30000; font-weight:600; }
    /* Toast styles moved to static/css/toasts.css */
    /* Spinner */
    .spinner { width:18px; height:18px; border:3px solid rgba(0,0,0,0.1); border-top:3px solid #007bff; border-radius:50%; animation: spin 1s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
    /* utility spacing to avoid inline styles */
    .ml-6 { margin-left: 6px; }
    /* Legend container styles moved from inline to here */
    .mp-legend {
      margin-top:14px;
      background:#fff;
      border:1px solid #e6e6e6;
      padding:10px 12px;
      border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,0.03);
      font-size:0.9em;
    }
      /* legend items moved from inline styles */
      .mp-legend .mp-legend-item { margin-left:8px; display:inline-block; }
      .mp-legend .cal-type-obecny { background:#eef; }
  </style>
    <div class="mp-cal-row">
      {# Decide which calendar to show: prefer viewed (selected) if present, otherwise owner #}
      {% set show_viewed = (calendar_days_viewed is defined and calendar_days_viewed) or (selected_pid) %}
      {% if show_viewed %}
        {% set display_days = calendar_days_viewed if (calendar_days_viewed is defined and calendar_days_viewed) else calendar_days_owner %}
        {% set display_pid = viewed_pid or selected_pid or owner_pid %}
      {% else %}
        {% set display_days = calendar_days_owner %}
        {% set display_pid = owner_pid %}
      {% endif %}
      <div class="mp-cal-col-main">
        <h4>{{ _('kalendarz_pracownika') }}</h4>
        <table class="cal-grid">
          <tr>
            <th>{{ _('pon') }}</th><th>{{ _('wt') }}</th><th>{{ _('sr') }}</th><th>{{ _('czw') }}</th><th>{{ _('pt') }}</th><th>{{ _('sob') }}</th><th>{{ _('nd') }}</th>
          </tr>
          <tr>
          {% for d in display_days %}
            {% set wd = d.date.weekday() %}
            {% if loop.first and wd > 0 %}
              {% for i in range(wd) %}
                <td></td>
              {% endfor %}
            {% endif %}
            {% set classes = [] %}
            {% if d.hr %}{% do classes.append('cal-hr') %}{% endif %}
            {% if d.approved %}{% do classes.append('cal-approved') %}{% endif %}
            <td data-date="{{ d.date }}" data-pid="{{ display_pid }}" class="{{ ' '.join(classes) }}">
              <div class="cal-day">{{ d.date.day }}</div>
              <div class="cal-hours">{{ '%.2f'|format(d.hours) }} h</div>
              {% if d.typ_label %}<div class="cal-type">{{ d.typ_label }}</div>{% endif %}
              {% if d.approved %}<div class="badge badge-success">{{ _('zatwierdzone') }}</div>{% endif %}
              {% if d.hr %}<div class="text-danger">{{ _('hr') }}</div>{% endif %}
            </td>
            {% if wd == 6 and not loop.last %}
              </tr><tr>
            {% endif %}
          {% endfor %}
          </tr>
        </table>
      </div>
    </div>
  <!-- Modale usunięte: podgląd wniosków i potwierdzenia przeniesiony/wyłączony -->

  <script>
    const my_pid = '{{ session.get("pracownik_id") or "" }}';
    const my_role = '{{ (session.get("rola") or "")|lower }}';
    // showToast() provided by static/js/toasts.js

    /* Modal UI removed — podgląd wniosków przeniesiony lub wyłączony. */

    // Edit hours helpers
    function submitEditHours(){
      const btn = document.getElementById('editHoursBtn');
      const pid = btn.getAttribute('data-pid');
      const date = btn.getAttribute('data-date');
      const val = document.getElementById('editHoursInput').value;
      if(!pid || !date) return showToast('Brak danych do zapisu', 'warning');
      fetch('/edytuj_godziny', {
        method: 'POST',
        headers: {'X-Requested-With':'XMLHttpRequest', 'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({pracownik_id: pid, date: date, godziny: val})
      }).then(r=>r.json()).then(j=>{
        if(j && j.success){
          showToast(j.message || 'Zapisano godziny', 'success');
          // update clicked cell if present
          // find any td[data-date][data-pid] matching
          const cell = document.querySelector('td[data-date="'+date+'"][data-pid="'+pid+'"]');
          if(cell){ const ch = cell.querySelector('.cal-hours'); if(ch) ch.textContent = parseFloat(val||0).toFixed(2)+' h'; }
          // refresh summary
          try{ refreshSummary(pid, 'viewed'); }catch(e){}
        } else {
          showToast((j && j.message) ? j.message : 'Błąd zapisu', 'danger');
        }
      }).catch(e=>{ console.error(e); showToast('Błąd sieci przy zapisie', 'danger'); });
    }

    // Toggle visibility of date/time inputs depending on selected typ
    function updateWniosekFields(){
      try{
        const typ = document.getElementById('typ_select').value;
        const timeColOd = document.getElementById('timeColOd');
        const timeColDo = document.getElementById('timeColDo');
        const czasOd = document.getElementById('czas_od');
        const czasDo = document.getElementById('czas_do');
        const dataDoWrapper = document.getElementById('data_do');
        const dataOd = document.getElementById('data_od');
        if(!timeColOd || !timeColDo || !dataOd) return;
        if(typ === 'Wyjście prywatne'){
          // Wyjście prywatne — jedno wyjście w danym dniu. Pokaż pola czasowe, ukryj pole data_do (ale zostaw w formularzu).
          timeColOd.style.display = '';
          timeColDo.style.display = '';
          if(czasOd) czasOd.required = true;
          if(czasDo) czasDo.required = true;
          if(dataDoWrapper) { dataDoWrapper.style.display = 'none'; dataDoWrapper.value = dataOd.value || ''; }
          // sync values
          if(dataOd){ dataOd.addEventListener('change', function(){ if(document.getElementById('typ_select').value === 'Wyjście prywatne'){ if(dataDoWrapper) dataDoWrapper.value = dataOd.value; } }); }
        } else {
          timeColOd.style.display = 'none';
          timeColDo.style.display = 'none';
          if(czasOd) { czasOd.required = false; czasOd.value = ''; }
          if(czasDo) { czasDo.required = false; czasDo.value = ''; }
          if(dataDoWrapper) { dataDoWrapper.style.display = ''; }
        }
      }catch(e){ console.error('updateWniosekFields error', e); }
    }

    // Attach click handlers to calendar cells (data-date attribute) — use data-pid on each cell
    document.addEventListener('DOMContentLoaded', function(){
      const cells = document.querySelectorAll('td[data-date]');
      cells.forEach(function(c){ c.addEventListener('click', function(){
        try{ if(typeof showToast==='function') showToast('Podgląd wniosków jest wyłączony w tej instalacji', 'info'); else alert('Podgląd wniosków jest wyłączony'); }catch(e){console.log('modal disabled click');}
      }); });
      // wire up type selector to toggle fields
      const typSel = document.getElementById('typ_select');
      if(typSel){ typSel.addEventListener('change', updateWniosekFields); updateWniosekFields(); }
      // initial refresh of summaries
      try{ refreshSummary('{{ owner_pid }}', 'owner'); }catch(e){}
      /*{% if viewed_summary %}*/
      try{ refreshSummary('{{ viewed_pid }}', 'viewed'); }catch(e){}
      /*{% endif %}*/
    });

    // openModalFor removed — modal UI disabled

    // Refresh summary counters (obecnosci, wyjscia_hours, typy) for given pid and target suffix ('owner'|'viewed')
    function refreshSummary(pid, suffix){
      if(!pid) return;
      const suf = suffix ? ('_' + suffix) : '';
      fetch('/api/wnioski/summary?pracownik_id='+encodeURIComponent(pid), {headers:{'X-Requested-With':'XMLHttpRequest'}})
        .then(r=>r.json()).then(j=>{
          if(j && !j.error){
            const ob = document.getElementById('obecnosciCount' + suf); if(ob) ob.textContent = j.obecnosci;
            const wh = document.getElementById('wyjsciaHours' + suf); if(wh) wh.textContent = (parseFloat(j.wyjscia_hours)||0).toFixed(2) + ' h';
            const ub = document.getElementById('urlopBiez' + suf); if(ub) ub.textContent = j.urlop_biezacy || 0;
            const uz = document.getElementById('urlopZal' + suf); if(uz) uz.textContent = j.urlop_zalegly || 0;
            if(j.typy){
              const table = document.getElementById('typyTable' + (suffix ? ('_' + suffix) : ''));
              Object.keys(j.typy).forEach(t=>{
                if(table){
                  const row = table.querySelector('tr[data-typ="'+t+'"]');
                  if(row){ const cell = row.querySelector('.typ-hours'); if(cell) cell.textContent = (parseFloat(j.typy[t])||0).toFixed(2)+' h'; }
                }
              });
            }
          }
        }).catch(err=>{ console.error('Summary fetch error', err); });
    }
  </script>
  
  <!-- Sekcja edycji godzin wewnątrz modalu została usunięta wraz z modalami -->
  
  <!-- Legend for calendar types (moved under calendar) -->
  <div class="mp-legend">
    <strong>Legenda:</strong>
    <span class="mp-legend-item"><span class="cal-type cal-type-obecny">{{ _('obecny') }}</span> — pracuje</span>
    <span class="mp-legend-item"><span class="cal-type">{{ _('u') }}</span> — Urlop</span>
    <span class="mp-legend-item"><span class="cal-type">{{ _('wp') }}</span> — Wyjście prywatne</span>
    <span class="mp-legend-item"><span class="cal-type">{{ _('n') }}</span> — Nieobecny</span>
    <span class="mp-legend-item"><span class="cal-type">{{ _('og') }}</span> — Odbiór godzin</span>
    <span class="mp-legend-item"><span class="cal-type">{{ _('op') }}</span> — Opieka</span>
  </div>
{% endblock %}
