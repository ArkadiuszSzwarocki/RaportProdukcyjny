{% extends 'layout.html' %}

{% block content %}
<div class="page-header">
    <h1>⚠️ {{ _('zgloszenie_problem') }}</h1>
</div>

<div class="section-box p-20">
    <form id="reportForm" class="d-flex flex-column gap-15 max-width-700">
        <label for="sekcja">{{ _('sekcja_label') }}</label>
        <select id="sekcja" name="sekcja" required class="input-sm">
            <option value="Zasyp">{{ _('zasyp') }}</option>
            <option value="Workowanie">{{ _('workowanie') }}</option>
            <option value="Magazyn">{{ _('magazyn') }}</option>
            <option value="Inne">Inne</option>
        </select>

        <label for="kategoria">{{ _('typ_zdarzenia') }}</label>
        <select id="kategoria" name="kategoria" required class="input-sm">
            <option value="">-- Wybierz --</option>
            <option value="Przezbrojenie">{{ _('przezbrojenie') }}</option>
            <option value="Awaria">{{ _('awaria_maszyny') }}</option>
            <option value="Brak Surowca">{{ _('brak_surowca') }}</option>
            <option value="Przerwa">{{ _('przerwa') }}</option>
            <option value="Inne">Inne</option>
        </select>

        <label>Opis (opcjonalnie):</label>
        <textarea name="problem" rows="6" class="input-sm" placeholder="{{ _('opisz_problem') }}"></textarea>

        <div class="d-flex gap-10">
            <button type="submit" class="btn-action btn-warning" id="submitBtn">{{ _('zglosz_btn') }}</button>
            <a href="/" class="btn-action btn-cancel">ANULUJ</a>
        </div>
    </form>
</div>

<script>
document.getElementById('reportForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = '⏳ Wysyłanie...';
        
        const formData = new FormData(this);
        const response = await fetch('{{ url_for("api.dodaj_wpis") }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showToast('✓ Awarię dodano pomyślnie', 'success');
            this.reset();
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        } else {
            const text = await response.text();
            showToast('❌ Błąd: ' + response.statusText, 'error');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('❌ Błąd połączenia: ' + error.message, 'error');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});
</script>

{% endblock %}
